name: ðŸ“± MindGarden ëª¨ë°”ì¼ ì•± ë¹Œë“œ

on:
  push:
    branches: [ main ]
    paths:
      - 'mobile/**'
      - '.github/workflows/deploy-mobile.yml'
  workflow_dispatch:
    inputs:
      platform:
        description: 'ë¹Œë“œí•  í”Œëž«í¼ (android, ios, both)'
        required: true
        default: 'both'
        type: choice
        options:
          - android
          - ios
          - both

jobs:
  build-android:
    name: ðŸ¤– Android ë¹Œë“œ
    runs-on: ubuntu-latest
    if: github.event.inputs.platform == 'android' || github.event.inputs.platform == 'both' || (github.event.inputs.platform == '' && github.event_name == 'push')
    
    steps:
    - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ðŸ“ mobile í´ë” í™•ì¸ ë° ì²´í¬ì•„ì›ƒ
      run: |
        echo "í˜„ìž¬ ë””ë ‰í† ë¦¬: $(pwd)"
        echo "ë””ë ‰í† ë¦¬ êµ¬ì¡°:"
        ls -la
        echo "mobile í´ë” í™•ì¸:"
        
        # mobile í´ë”ê°€ ì„œë¸Œëª¨ë“ˆì¸ì§€ í™•ì¸ (ë¹ˆ ë””ë ‰í† ë¦¬ ë˜ëŠ” .git íŒŒì¼ë§Œ ìžˆëŠ” ê²½ìš°)
        if [ -d "mobile" ]; then
          if [ -f "mobile/.git" ] || [ -d "mobile/.git" ]; then
            echo "ðŸ“¦ mobileì´ ì„œë¸Œëª¨ë“ˆë¡œ ê°ì§€ë¨"
            # ì„œë¸Œëª¨ë“ˆ ë‚´ìš© ì²´í¬ì•„ì›ƒ
            git submodule update --init --recursive mobile || echo "âš ï¸ ì„œë¸Œëª¨ë“ˆ ì²´í¬ì•„ì›ƒ ì‹¤íŒ¨"
            
            # ì„œë¸Œëª¨ë“ˆ ë‚´ìš©ì´ ì—†ìœ¼ë©´ ì§ì ‘ ì²´í¬ì•„ì›ƒ ì‹œë„
            if [ ! -d "mobile/android" ] && [ ! -d "mobile/ios" ]; then
              echo "âš ï¸ ì„œë¸Œëª¨ë“ˆ ë‚´ìš©ì´ ì—†ìŒ, ì§ì ‘ ì²´í¬ì•„ì›ƒ ì‹œë„..."
              cd mobile
              # ì„œë¸Œëª¨ë“ˆì˜ ì‹¤ì œ ì €ìž¥ì†Œ URL í™•ì¸
              if [ -f ".git" ]; then
                SUBMODULE_URL=$(cat .git | sed 's|^gitdir: ||' | sed 's|/\.git$||' | sed 's|^\.\./\.\./||')
                echo "ì„œë¸Œëª¨ë“ˆ ê²½ë¡œ: $SUBMODULE_URL"
              fi
              # ì„œë¸Œëª¨ë“ˆì˜ ì»¤ë°‹ í•´ì‹œ í™•ì¸
              COMMIT_HASH=$(git rev-parse HEAD 2>/dev/null || echo "")
              if [ -n "$COMMIT_HASH" ]; then
                echo "ì„œë¸Œëª¨ë“ˆ ì»¤ë°‹ í•´ì‹œ: $COMMIT_HASH"
                # ì‹¤ì œ ì €ìž¥ì†Œì—ì„œ í•´ë‹¹ ì»¤ë°‹ ì²´í¬ì•„ì›ƒ
                git fetch origin || true
                git checkout -f $COMMIT_HASH || git checkout -f HEAD || echo "âš ï¸ ì§ì ‘ ì²´í¬ì•„ì›ƒ ì‹¤íŒ¨"
              fi
              cd ..
            fi
          fi
          
          # mobile í´ë” ë‚´ìš© í™•ì¸
          echo "mobile í´ë” ë‚´ìš©:"
          ls -la mobile/ | head -20
          
          # android/ios í´ë” í™•ì¸
          if [ ! -d "mobile/android" ] && [ ! -d "mobile/ios" ]; then
            echo "âŒ mobile/android ë˜ëŠ” mobile/ios í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤!"
            echo "mobile í´ë” ìƒì„¸ ì •ë³´:"
            if [ -f "mobile/.git" ]; then
              echo "mobile/.git ë‚´ìš©:"
              cat mobile/.git
            fi
            echo "ì „ì²´ ë””ë ‰í† ë¦¬ êµ¬ì¡°:"
            find . -maxdepth 3 -type d | head -30
            exit 1
          fi
        else
          echo "âŒ mobile ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤!"
          echo "ì„œë¸Œëª¨ë“ˆ ì²´í¬ì•„ì›ƒ ì‹œë„..."
          git submodule update --init --recursive mobile || echo "âš ï¸ ì„œë¸Œëª¨ë“ˆ ì²´í¬ì•„ì›ƒ ì‹¤íŒ¨"
          if [ -d "mobile" ]; then
            echo "âœ… mobile ë””ë ‰í† ë¦¬ í™•ì¸ë¨"
            ls -la mobile/ | head -20
          else
            echo "âŒ mobile ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
            exit 1
          fi
        fi
      
    - name: â˜• Java 17 ì„¤ì • (Android ë¹Œë“œìš©)
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ðŸ“¦ Node.js 20 ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: ðŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        cd mobile
        npm ci
        
    - name: ðŸ”§ Android SDK ì„¤ì •
      uses: android-actions/setup-android@v3
      with:
        api-level: 33
        build-tools: 33.0.0
        target: android-33
        
    - name: ðŸ” ë¦´ë¦¬ì¦ˆ í‚¤ìŠ¤í† ì–´ ì„¤ì • (ì„ íƒì‚¬í•­)
      if: env.ANDROID_KEYSTORE_BASE64 != ''
      env:
        ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      run: |
        if [ -n "$ANDROID_KEYSTORE_BASE64" ]; then
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > mobile/android/app/my-release-key.keystore
          echo "âœ… í‚¤ìŠ¤í† ì–´ íŒŒì¼ ìƒì„± ì™„ë£Œ"
        else
          echo "â„¹ï¸ í‚¤ìŠ¤í† ì–´ê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ - Debug ë¹Œë“œë¡œ ì§„í–‰"
        fi
        
    - name: ðŸ—ï¸ Android Release ë¹Œë“œ
      run: |
        cd mobile/android
        ./gradlew assembleRelease
        
    - name: ðŸ“¦ Android AAB ë¹Œë“œ (Google Play ì—…ë¡œë“œìš©)
      run: |
        cd mobile/android
        ./gradlew bundleRelease
        
    - name: ðŸ“¤ ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: android-release
        path: |
          mobile/android/app/build/outputs/apk/release/app-release.apk
          mobile/android/app/build/outputs/bundle/release/app-release.aab
        retention-days: 30
        
    - name: ðŸ“‹ ë¹Œë“œ ì •ë³´ ì¶œë ¥
      run: |
        echo "ðŸ“± Android ë¹Œë“œ ì™„ë£Œ"
        echo "APK ìœ„ì¹˜: mobile/android/app/build/outputs/apk/release/app-release.apk"
        echo "AAB ìœ„ì¹˜: mobile/android/app/build/outputs/bundle/release/app-release.aab"
        ls -lh mobile/android/app/build/outputs/apk/release/ || true
        ls -lh mobile/android/app/build/outputs/bundle/release/ || true

  build-ios:
    name: ðŸŽ iOS ë¹Œë“œ
    runs-on: macos-latest
    if: github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'both' || (github.event.inputs.platform == '' && github.event_name == 'push')
    
    steps:
    - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ðŸ“ mobile í´ë” í™•ì¸ ë° ì²´í¬ì•„ì›ƒ
      run: |
        echo "í˜„ìž¬ ë””ë ‰í† ë¦¬: $(pwd)"
        echo "ë””ë ‰í† ë¦¬ êµ¬ì¡°:"
        ls -la
        echo "mobile í´ë” í™•ì¸:"
        
        # mobile í´ë”ê°€ ì„œë¸Œëª¨ë“ˆì¸ì§€ í™•ì¸ (ë¹ˆ ë””ë ‰í† ë¦¬ ë˜ëŠ” .git íŒŒì¼ë§Œ ìžˆëŠ” ê²½ìš°)
        if [ -d "mobile" ]; then
          if [ -f "mobile/.git" ] || [ -d "mobile/.git" ]; then
            echo "ðŸ“¦ mobileì´ ì„œë¸Œëª¨ë“ˆë¡œ ê°ì§€ë¨"
            # ì„œë¸Œëª¨ë“ˆ ë‚´ìš© ì²´í¬ì•„ì›ƒ
            git submodule update --init --recursive mobile || echo "âš ï¸ ì„œë¸Œëª¨ë“ˆ ì²´í¬ì•„ì›ƒ ì‹¤íŒ¨"
            
            # ì„œë¸Œëª¨ë“ˆ ë‚´ìš©ì´ ì—†ìœ¼ë©´ ì§ì ‘ ì²´í¬ì•„ì›ƒ ì‹œë„
            if [ ! -d "mobile/android" ] && [ ! -d "mobile/ios" ]; then
              echo "âš ï¸ ì„œë¸Œëª¨ë“ˆ ë‚´ìš©ì´ ì—†ìŒ, ì§ì ‘ ì²´í¬ì•„ì›ƒ ì‹œë„..."
              cd mobile
              # ì„œë¸Œëª¨ë“ˆì˜ ì‹¤ì œ ì €ìž¥ì†Œ URL í™•ì¸
              if [ -f ".git" ]; then
                SUBMODULE_URL=$(cat .git | sed 's|^gitdir: ||' | sed 's|/\.git$||' | sed 's|^\.\./\.\./||')
                echo "ì„œë¸Œëª¨ë“ˆ ê²½ë¡œ: $SUBMODULE_URL"
              fi
              # ì„œë¸Œëª¨ë“ˆì˜ ì»¤ë°‹ í•´ì‹œ í™•ì¸
              COMMIT_HASH=$(git rev-parse HEAD 2>/dev/null || echo "")
              if [ -n "$COMMIT_HASH" ]; then
                echo "ì„œë¸Œëª¨ë“ˆ ì»¤ë°‹ í•´ì‹œ: $COMMIT_HASH"
                # ì‹¤ì œ ì €ìž¥ì†Œì—ì„œ í•´ë‹¹ ì»¤ë°‹ ì²´í¬ì•„ì›ƒ
                git fetch origin || true
                git checkout -f $COMMIT_HASH || git checkout -f HEAD || echo "âš ï¸ ì§ì ‘ ì²´í¬ì•„ì›ƒ ì‹¤íŒ¨"
              fi
              cd ..
            fi
          fi
          
          # mobile í´ë” ë‚´ìš© í™•ì¸
          echo "mobile í´ë” ë‚´ìš©:"
          ls -la mobile/ | head -20
          
          # android/ios í´ë” í™•ì¸
          if [ ! -d "mobile/android" ] && [ ! -d "mobile/ios" ]; then
            echo "âŒ mobile/android ë˜ëŠ” mobile/ios í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤!"
            echo "mobile í´ë” ìƒì„¸ ì •ë³´:"
            if [ -f "mobile/.git" ]; then
              echo "mobile/.git ë‚´ìš©:"
              cat mobile/.git
            fi
            echo "ì „ì²´ ë””ë ‰í† ë¦¬ êµ¬ì¡°:"
            find . -maxdepth 3 -type d | head -30
            exit 1
          fi
        else
          echo "âŒ mobile ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤!"
          echo "ì„œë¸Œëª¨ë“ˆ ì²´í¬ì•„ì›ƒ ì‹œë„..."
          git submodule update --init --recursive mobile || echo "âš ï¸ ì„œë¸Œëª¨ë“ˆ ì²´í¬ì•„ì›ƒ ì‹¤íŒ¨"
          if [ -d "mobile" ]; then
            echo "âœ… mobile ë””ë ‰í† ë¦¬ í™•ì¸ë¨"
            ls -la mobile/ | head -20
          else
            echo "âŒ mobile ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
            exit 1
          fi
        fi
      
    - name: ðŸ“¦ Node.js 20 ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: ðŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        cd mobile
        npm ci
        
    - name: ðŸŽ CocoaPods ì„¤ì¹˜
      run: |
        cd mobile/ios
        sudo gem install cocoapods
        pod install
        
    - name: ðŸ—ï¸ iOS Archive ë¹Œë“œ
      run: |
        cd mobile/ios
        xcodebuild -workspace MindGardenMobile.xcworkspace \
          -scheme MindGardenMobile \
          -configuration Release \
          -sdk iphoneos \
          -archivePath build/MindGardenMobile.xcarchive \
          archive \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
          
    - name: ðŸ“¦ IPA ìƒì„±
      run: |
        cd mobile/ios
        xcodebuild -exportArchive \
          -archivePath build/MindGardenMobile.xcarchive \
          -exportPath build \
          -exportOptionsPlist ExportOptions.plist || echo "ExportOptions.plist ì—†ìŒ - IPA ìƒì„± ê±´ë„ˆëœ€"
          
    - name: ðŸ“¤ ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: ios-release
        path: |
          mobile/ios/build/MindGardenMobile.xcarchive
          mobile/ios/build/*.ipa
        retention-days: 30
        
    - name: ðŸ“‹ ë¹Œë“œ ì •ë³´ ì¶œë ¥
      run: |
        echo "ðŸŽ iOS ë¹Œë“œ ì™„ë£Œ"
        echo "Archive ìœ„ì¹˜: mobile/ios/build/MindGardenMobile.xcarchive"
        ls -lh mobile/ios/build/ || true

  notify:
    name: ðŸ“¢ ë¹Œë“œ ì™„ë£Œ ì•Œë¦¼
    runs-on: ubuntu-latest
    needs: [build-android, build-ios]
    if: always()
    
    steps:
    - name: ðŸ“¥ ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
      uses: actions/download-artifact@v4
      with:
        pattern: '*-release'
        merge-multiple: true
        path: artifacts
        
    - name: ðŸ“‹ ë¹Œë“œ ìš”ì•½
      run: |
        echo "## ðŸ“± ëª¨ë°”ì¼ ì•± ë¹Œë“œ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ¤– Android" >> $GITHUB_STEP_SUMMARY
        if [ -d "artifacts/android-release" ]; then
          echo "âœ… Android ë¹Œë“œ ì„±ê³µ" >> $GITHUB_STEP_SUMMARY
          ls -lh artifacts/android-release/ >> $GITHUB_STEP_SUMMARY || true
        else
          echo "âš ï¸ Android ë¹Œë“œ ì‹¤íŒ¨ ë˜ëŠ” ê±´ë„ˆëœ€" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŽ iOS" >> $GITHUB_STEP_SUMMARY
        if [ -d "artifacts/ios-release" ]; then
          echo "âœ… iOS ë¹Œë“œ ì„±ê³µ" >> $GITHUB_STEP_SUMMARY
          ls -lh artifacts/ios-release/ >> $GITHUB_STEP_SUMMARY || true
        else
          echo "âš ï¸ iOS ë¹Œë“œ ì‹¤íŒ¨ ë˜ëŠ” ê±´ë„ˆëœ€" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“¥ ë¹Œë“œ íŒŒì¼ì€ GitHub Actionsì˜ Artifactsì—ì„œ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY

