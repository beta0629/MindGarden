name: ğŸš€ MindGarden ìš´ì˜ ë°°í¬

on:
  # ìš´ì˜ ë°°í¬ëŠ” ìˆ˜ë™ ì‹¤í–‰ë§Œ ê°€ëŠ¥ (ìë™ ë°°í¬ ë¹„í™œì„±í™”)
  # push:
  #   branches: [ main ]
  workflow_dispatch:
    # ìˆ˜ë™ ì‹¤í–‰ë§Œ ê°€ëŠ¥ - ì‹¤ìˆ˜ë¡œ ìš´ì˜ ë°°í¬ë˜ëŠ” ê²ƒ ë°©ì§€

jobs:
  deploy:
    name: ğŸ—ï¸ ë¹Œë“œ ë° ë°°í¬
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: â˜• Java 17 ì„¤ì •
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ğŸ“¦ Node.js 20 ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: ğŸ”§ Maven ìºì‹œ ì„¤ì •
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: ğŸ—ï¸ ë°±ì—”ë“œ ë¹Œë“œ
      run: mvn clean package -DskipTests
      
    - name: ğŸ“¦ í”„ë¡ íŠ¸ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        cd frontend
        npm install
        
    - name: ğŸ—ï¸ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ
      run: |
        cd frontend
        npm run build:ci
        
    - name: ğŸ” SSH ì—°ê²° í…ŒìŠ¤íŠ¸
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        port: 22
        timeout: 30s
        script: |
          echo "SSH ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ: $(date)"
          echo "ì„œë²„ ì •ë³´: $(uname -a)"
          
          # SSH ì•ˆì „ì¥ì¹˜: ë°©í™”ë²½ ê´€ë ¨ ëª…ë ¹ì–´ëŠ” ì ˆëŒ€ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
          echo "ğŸ›¡ï¸ SSH ì•ˆì „ì¥ì¹˜ í™œì„±í™” - ë°©í™”ë²½ ì„¤ì •ì€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ"
          echo "âœ… SSH í¬íŠ¸ 22ëŠ” ê¸°ì¡´ ìƒíƒœ ìœ ì§€ (ì ˆëŒ€ ë³€ê²½ ê¸ˆì§€)"
          echo "âš ï¸ ufw, iptables, ë°©í™”ë²½ ê´€ë ¨ ëª…ë ¹ì–´ëŠ” ì ˆëŒ€ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ"
          
          echo "ğŸ”§ ì„œë²„ ìƒíƒœ í™•ì¸ ì™„ë£Œ (SSH ë³´í˜¸ë¨)"
          
    - name: ğŸš€ ì„œë²„ ë°°í¬
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        port: 22
        timeout: 120s
        command_timeout: 30m
        script: |
          # ë°°í¬ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          cd /var/www/mindgarden
          
          # ì„œë¹„ìŠ¤ ì¤‘ì§€
          sudo systemctl stop mindgarden.service
          
          # ë°±ì—… ìƒì„±
          if [ -f app.jar ]; then
            cp app.jar app.jar.backup.$(date +%Y%m%d_%H%M%S)
          fi
          
          # í”„ë¡ íŠ¸ì—”ë“œ ë°±ì—…
          if [ -d frontend ]; then
            tar -czf frontend.backup.$(date +%Y%m%d_%H%M%S).tar.gz frontend/
          fi
          
    - name: ğŸ“¤ ë°±ì—”ë“œ íŒŒì¼ ì—…ë¡œë“œ
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        port: 22
        timeout: 120s
        source: "target/consultation-management-system-1.0.0.jar"
        target: "/var/www/mindgarden/"
        strip_components: 1
        overwrite: true
        
    - name: ğŸ“¤ í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ ì—…ë¡œë“œ
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        port: 22
        timeout: 120s
        source: "frontend/build/*"
        target: "/var/www/html/"
        strip_components: 2
        overwrite: true
        
    - name: ğŸ“¤ ì„¤ì • íŒŒì¼ ì—…ë¡œë“œ
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        port: 22
        timeout: 120s
        source: "deployment/application-production.yml"
        target: "/var/www/mindgarden/"
        strip_components: 1
        overwrite: true
        
    # PL/SQL í”„ë¡œì‹œì € ì—…ë¡œë“œëŠ” í•„ìš”í•  ë•Œë§Œ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰
    # - name: ğŸ“¤ PL/SQL í”„ë¡œì‹œì € ì—…ë¡œë“œ
    #   uses: appleboy/scp-action@v0.1.7
    #   with:
    #     host: ${{ secrets.PRODUCTION_HOST }}
    #     username: ${{ secrets.PRODUCTION_USER }}
    #     key: ${{ secrets.PRODUCTION_SSH_KEY }}
    #     port: 22
    #     timeout: 120s
    #     source: "sql/production_all_missing_procedures.sql"
    #     target: "/tmp/"
    #     strip_components: 1
    #     overwrite: true
        
    - name: ğŸ“¤ ë©”ë‰´ ì—…ë°ì´íŠ¸ SQL ì—…ë¡œë“œ
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        port: 22
        timeout: 120s
        source: "src/main/resources/sql/update_all_role_menus.sql"
        target: "/tmp/"
        strip_components: 3
        overwrite: true
        
    - name: ğŸ“¤ ë§¤í•‘ ìˆ˜ì • í”„ë¡œì‹œì € ì—…ë¡œë“œ
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        port: 22
        timeout: 120s
        source: "sql/mapping_update_procedures_mysql.sql"
        target: "/tmp/mapping_update_procedures_mysql.sql"
        strip_components: 1
        overwrite: true
        
    # ë©”ì‹œì§€ ê¶Œí•œ SQL ì—…ë¡œë“œ - ê¶Œí•œ ì˜¤ë¥˜ë¡œ ì£¼ì„ ì²˜ë¦¬
    # SQL íŒŒì¼ì€ í•œ ë²ˆë§Œ ì‹¤í–‰ë˜ì–´ì•¼ í•¨ - ìˆ˜ë™ ì‹¤í–‰ í•„ìš”
    # - name: ğŸ“¤ ë©”ì‹œì§€ ê¶Œí•œ SQL ì—…ë¡œë“œ
    #   uses: appleboy/scp-action@v0.1.7
    #   with:
    #     host: ${{ secrets.PRODUCTION_HOST }}
    #     username: ${{ secrets.PRODUCTION_USER }}
    #     key: ${{ secrets.PRODUCTION_SSH_KEY }}
    #     port: 22
    #     timeout: 120s
    #     source: "sql/add_message_management_permissions.sql"
    #     target: "/tmp/"
    #     strip_components: 1
    #     overwrite: true
        
    # ë©”ì‹œì§€ ê¶Œí•œ ê°•ì œ ì¶”ê°€ SQLì€ í•œ ë²ˆë§Œ ì‹¤í–‰ë˜ì–´ì•¼ í•¨ - ìˆ˜ë™ ì‹¤í–‰ í•„ìš”
    # - name: ğŸ“¤ ë©”ì‹œì§€ ê¶Œí•œ ê°•ì œ ì¶”ê°€ SQL ì—…ë¡œë“œ
    #   uses: appleboy/scp-action@v0.1.7
    #   with:
    #     host: ${{ secrets.PRODUCTION_HOST }}
    #     username: ${{ secrets.PRODUCTION_USER }}
    #     key: ${{ secrets.PRODUCTION_SSH_KEY }}
    #     port: 22
    #     timeout: 120s
    #     source: "sql/add_message_management_permissions_force.sql"
    #     target: "/tmp/"
    #     strip_components: 1
    #     overwrite: true
        
    # SQL íŒŒì¼ ê¶Œí•œ ì„¤ì •ì€ ë©”ë‰´ ì—…ë°ì´íŠ¸ê°€ í•„ìš”í•œ ê²½ìš°ì—ë§Œ ì‹¤í–‰
    # - name: ğŸ”§ SQL íŒŒì¼ ê¶Œí•œ ì„¤ì •
    #   uses: appleboy/ssh-action@v1.1.0
    #   with:
    #     host: ${{ secrets.PRODUCTION_HOST }}
    #     username: ${{ secrets.PRODUCTION_USER }}
    #     key: ${{ secrets.PRODUCTION_SSH_KEY }}
    #     port: 22
    #     timeout: 60s
    #     script: |
    #       # SQL íŒŒì¼ ê¶Œí•œ ì„¤ì •
    #       sudo chmod 644 /tmp/update_all_role_menus.sql
    #       echo "âœ… SQL íŒŒì¼ ê¶Œí•œ ì„¤ì • ì™„ë£Œ"
        
    - name: ğŸ”§ í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ ê¶Œí•œ ì„¤ì •
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        port: 22
        timeout: 120s
        command_timeout: 10m
        script: |
          # í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ ê¶Œí•œ ì„¤ì •
          sudo chown -R www-data:www-data /var/www/html/
          sudo chmod -R 755 /var/www/html/
          
          # CSS íŒŒì¼ ê¶Œí•œ íŠ¹ë³„ ì„¤ì •
          sudo find /var/www/html/ -name "*.css" -exec chmod 644 {} \;
          sudo find /var/www/html/ -name "*.js" -exec chmod 644 {} \;
          
          echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ ê¶Œí•œ ì„¤ì • ì™„ë£Œ"
        
    # ì°¸ê³ : ë©”ë‰´ êµ¬ì¡° ì—…ë°ì´íŠ¸ëŠ” í•„ìš”í•  ë•Œë§Œ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰
    # sudo mysql -u root -p'!QAZ2wsx#EDC4rfv' mindgarden < /tmp/update_all_role_menus.sql
        
    - name: ğŸ”„ ì„œë¹„ìŠ¤ ì¬ì‹œì‘
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        port: 22
        timeout: 60s
        command_timeout: 5m
        script: |
          cd /var/www/mindgarden
          
          # JAR íŒŒì¼ëª… ë³€ê²½
          if [ -f consultation-management-system-1.0.0.jar ]; then
            mv consultation-management-system-1.0.0.jar app.jar
          fi
          
          # ê¶Œí•œ ì„¤ì •
          chmod +x app.jar
          
          # ì„œë¹„ìŠ¤ ì¬ì‹œì‘
          echo "ğŸ”„ ì„œë¹„ìŠ¤ ì¬ì‹œì‘..."
          sudo systemctl stop mindgarden.service || true
          sleep 5
          sudo systemctl start mindgarden.service
          echo "â³ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ëŒ€ê¸° ì¤‘ (30ì´ˆ)..."
          sleep 30
          
          # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
          echo "ğŸ” ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸..."
          sudo systemctl status mindgarden.service --no-pager | head -10
          
          # ì„œë¹„ìŠ¤ í™œì„±í™” ìƒíƒœ í™•ì¸
          if sudo systemctl is-active --quiet mindgarden.service; then
            echo "âœ… ì„œë¹„ìŠ¤ ì •ìƒ ì‹œì‘ë¨"
            # ì„œë¹„ìŠ¤ ìƒíƒœ ìƒì„¸ ì¶œë ¥
            sudo systemctl status mindgarden.service --no-pager -l | head -20
          else
            echo "âŒ ì„œë¹„ìŠ¤ ì‹œì‘ ì‹¤íŒ¨ - ì¬ì‹œë„..."
            echo "ğŸ“‹ ì„œë¹„ìŠ¤ ìƒíƒœ ìƒì„¸:"
            sudo systemctl status mindgarden.service --no-pager -l
            echo ""
            echo "ğŸ“‹ ì„œë¹„ìŠ¤ ë¡œê·¸:"
            sudo journalctl -u mindgarden.service --no-pager -n 30
            sudo systemctl restart mindgarden.service
            sleep 30
            echo "â³ ì¬ì‹œì‘ í›„ ëŒ€ê¸° ì™„ë£Œ"
          fi
          
          # ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ì—…ë°ì´íŠ¸ëŠ” ë³„ë„ ì›Œí¬í”Œë¡œìš°ì—ì„œ ìˆ˜ë™ ì‹¤í–‰
          echo "â„¹ï¸ DB ìŠ¤í‚¤ë§ˆ ì—…ë°ì´íŠ¸ëŠ” ë³„ë„ ì›Œí¬í”Œë¡œìš°ì—ì„œ ìˆ˜ë™ ì‹¤í–‰í•˜ì„¸ìš”"
          echo "â„¹ï¸ Actions > 'Fix Production Database' ì›Œí¬í”Œë¡œìš° ì‚¬ìš©"
          
          # ë©”ì‹œì§€ ê´€ë¦¬ ê¶Œí•œ í™•ì¸ (SQL íŒŒì¼ ì—…ë¡œë“œëŠ” ì£¼ì„ ì²˜ë¦¬ë¨)
          echo "ğŸ”§ ë©”ì‹œì§€ ê´€ë¦¬ ê¶Œí•œ í™•ì¸ ì‹œì‘..."
          EXISTING_COUNT=$(mysql -u mindgarden -p'mindgarden2025' mind_garden -N -e "SELECT COUNT(*) FROM role_permissions WHERE permission_code IN ('MESSAGE_MANAGE', 'MESSAGE_VIEW') AND role_name='BRANCH_SUPER_ADMIN' AND is_active=true;" 2>/dev/null || echo "0")
          
          if [ "$EXISTING_COUNT" -eq "0" ]; then
            echo "âš ï¸ ë©”ì‹œì§€ ê¶Œí•œì´ ì—†ìŒ - ìˆ˜ë™ìœ¼ë¡œ SQL ì‹¤í–‰ í•„ìš”"
            echo "âš ï¸ ìš´ì˜ ì„œë²„ SSH ì ‘ì† í›„ SQL ì‹¤í–‰:"
            echo "   mysql -u mindgarden -p'mindgarden2025' mind_garden < /path/to/sql/add_message_management_permissions_force.sql"
          else
            echo "âœ… ë©”ì‹œì§€ ê´€ë¦¬ ê¶Œí•œì´ ì´ë¯¸ ì¡´ì¬í•¨ (${EXISTING_COUNT}ê°œ)"
          fi
          
          # ë§¤í•‘ ìˆ˜ì • í”„ë¡œì‹œì € ë°°í¬
          echo "ğŸ”§ ë§¤í•‘ ìˆ˜ì • í”„ë¡œì‹œì € ë°°í¬ ì‹œì‘..."
          if [ -f /tmp/mapping_update_procedures_mysql.sql ]; then
            echo "ğŸ“‹ ë§¤í•‘ ìˆ˜ì • í”„ë¡œì‹œì € íŒŒì¼ í™•ì¸ë¨"
            
            # DROP êµ¬ë¬¸ ì œê±° (ê¶Œí•œ ì˜¤ë¥˜ ë°©ì§€) - DROP ì—†ì´ CREATEë§Œ ì‹œë„
            echo "ğŸ“‹ DROP êµ¬ë¬¸ ì œê±°í•œ ì„ì‹œ íŒŒì¼ ìƒì„±..."
            sed '/^DROP PROCEDURE/d' /tmp/mapping_update_procedures_mysql.sql > /tmp/mapping_proc_no_drop.sql || cp /tmp/mapping_update_procedures_mysql.sql /tmp/mapping_proc_no_drop.sql
            
            # í”„ë¡œì‹œì € ë°°í¬ ì‹¤í–‰ (DROP ì—†ì´)
            echo "ğŸ“‹ í”„ë¡œì‹œì € ë°°í¬ ì‹¤í–‰..."
            mysql -h localhost -u mindgarden -p'mindgarden2025' mind_garden < /tmp/mapping_proc_no_drop.sql 2>&1 | tee /tmp/procedure_deploy.log
            
            DEPLOY_RESULT=${PIPESTATUS[0]}
            
            # DROP ê¶Œí•œ ì˜¤ë¥˜ë¡œ ì‹¤íŒ¨í•œ ê²½ìš°, rootë¡œ ì¬ì‹œë„
            if [ $DEPLOY_RESULT -ne 0 ] && grep -q "Access denied\|DROP PROCEDURE\|SYSTEM_USER" /tmp/procedure_deploy.log 2>/dev/null; then
              echo "âš ï¸ DROP ê¶Œí•œ ì˜¤ë¥˜ ê°ì§€ - root ê¶Œí•œìœ¼ë¡œ ì¬ì‹œë„..."
              sudo mysql -h localhost -u root -pmindgarden2025 mind_garden < /tmp/mapping_update_procedures_mysql.sql 2>&1 | tee /tmp/procedure_deploy_root.log
              
              if [ ${PIPESTATUS[0]} -eq 0 ]; then
                echo "âœ… root ê¶Œí•œìœ¼ë¡œ í”„ë¡œì‹œì € ë°°í¬ ì™„ë£Œ"
                DEPLOY_RESULT=0
              else
                echo "âŒ root ê¶Œí•œìœ¼ë¡œë„ ë°°í¬ ì‹¤íŒ¨"
                cat /tmp/procedure_deploy_root.log || true
                rm -f /tmp/procedure_deploy_root.log
              fi
            fi
            
            if [ $DEPLOY_RESULT -eq 0 ]; then
              echo "âœ… ë§¤í•‘ ìˆ˜ì • í”„ë¡œì‹œì € ë°°í¬ ì™„ë£Œ"
            else
              echo "âŒ ë§¤í•‘ ìˆ˜ì • í”„ë¡œì‹œì € ë°°í¬ ì‹¤íŒ¨"
              echo "ğŸ“‹ ë°°í¬ ë¡œê·¸ (ì˜¤ë¥˜ í™•ì¸):"
              cat /tmp/procedure_deploy.log || true
              echo "âš ï¸ í”„ë¡œì‹œì € ë°°í¬ ì‹¤íŒ¨í•´ë„ ì„œë¹„ìŠ¤ëŠ” ê³„ì† ì§„í–‰"
            fi
            
            rm -f /tmp/mapping_proc_no_drop.sql /tmp/procedure_deploy.log
            
            # í”„ë¡œì‹œì € í™•ì¸
            echo "ğŸ“‹ ìµœì¢… í”„ë¡œì‹œì € í™•ì¸:"
            mysql -h localhost -u mindgarden -p'mindgarden2025' mind_garden -e "
            SELECT 
                ROUTINE_NAME,
                CREATED,
                LAST_ALTERED,
                CASE 
                    WHEN ROUTINE_DEFINITION LIKE '%tax_included%' THEN 'âœ… ìµœì‹ ë²„ì „'
                    ELSE 'âš ï¸ êµ¬ë²„ì „'
                END AS 'ë²„ì „'
            FROM information_schema.ROUTINES 
            WHERE ROUTINE_SCHEMA = 'mind_garden' 
            AND ROUTINE_TYPE = 'PROCEDURE' 
            AND ROUTINE_NAME = 'UpdateMappingInfo';
            " 2>/dev/null || true
            
            rm -f /tmp/mapping_update_procedures_mysql.sql /tmp/procedure_deploy.log
          else
            echo "âš ï¸ ë§¤í•‘ ìˆ˜ì • í”„ë¡œì‹œì € íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          fi
          
          # PL/SQL í”„ë¡œì‹œì € ë“±ë¡
          echo "ğŸ”§ PL/SQL í”„ë¡œì‹œì € ë“±ë¡ ì‹œì‘..."
          if [ -f /tmp/production_all_missing_procedures.sql ]; then
            # íŒŒì¼ ë‚´ìš© í™•ì¸
            echo "ğŸ“‹ íŒŒì¼ ë‚´ìš© í™•ì¸:"
            head -5 /tmp/production_all_missing_procedures.sql
            # í™˜ê²½ë³€ìˆ˜ ëª…ì‹œì  ì„¤ì •
            export DB_HOST="localhost"
            export DB_USERNAME="mindgarden"
            export DB_PASSWORD="mindgarden2025"
            export DB_NAME="mind_garden"
            
            echo "ğŸ“‹ MySQL ì—°ê²° ì •ë³´ í™•ì¸..."
            echo "DB_HOST: $DB_HOST"
            echo "DB_USERNAME: $DB_USERNAME"
            echo "DB_NAME: $DB_NAME"
            
            # MySQL ì—°ê²° í…ŒìŠ¤íŠ¸
            mysql -h $DB_HOST -u $DB_USERNAME -p$DB_PASSWORD -e "SELECT 1;" $DB_NAME
            
            if [ $? -eq 0 ]; then
              echo "âœ… MySQL ì—°ê²° ì„±ê³µ - í”„ë¡œì‹œì € ë“±ë¡ ì‹œì‘"
              mysql -h $DB_HOST -u $DB_USERNAME -p$DB_PASSWORD $DB_NAME < /tmp/production_all_missing_procedures.sql
              
              if [ $? -eq 0 ]; then
                echo "âœ… ëª¨ë“  ëˆ„ë½ëœ PL/SQL í”„ë¡œì‹œì € ë“±ë¡ ì™„ë£Œ"
                
                # ë“±ë¡ëœ í”„ë¡œì‹œì € í™•ì¸
                echo "ğŸ“‹ ë“±ë¡ëœ í”„ë¡œì‹œì € ëª©ë¡:"
                mysql -h $DB_HOST -u $DB_USERNAME -p$DB_PASSWORD $DB_NAME -e "
                SELECT ROUTINE_NAME, CREATED 
                FROM information_schema.ROUTINES 
                WHERE ROUTINE_SCHEMA = DATABASE() 
                AND ROUTINE_TYPE = 'PROCEDURE' 
                ORDER BY CREATED DESC;
                "
              else
                echo "âŒ PL/SQL í”„ë¡œì‹œì € ë“±ë¡ ì‹¤íŒ¨"
                exit 1
              fi
            else
              echo "âŒ MySQL ì—°ê²° ì‹¤íŒ¨ - í”„ë¡œì‹œì € ë“±ë¡ ê±´ë„ˆëœ€"
            fi
            
            rm -f /tmp/production_all_missing_procedures.sql
          else
            echo "âš ï¸ PL/SQL í”„ë¡œì‹œì € íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          fi
          
    - name: ğŸ¥ í—¬ìŠ¤ì²´í¬
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        script: |
          echo "ğŸ¥ í—¬ìŠ¤ì²´í¬ ì‹œì‘..."
          
          # 60ì´ˆ ëŒ€ê¸° í›„ í—¬ìŠ¤ì²´í¬ (ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™” ì‹œê°„ í™•ë³´)
          echo "â³ ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘ (60ì´ˆ)..."
          sleep 60
          
          # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
          echo "ğŸ” ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸..."
          if sudo systemctl is-active --quiet mindgarden.service; then
            echo "âœ… ì„œë¹„ìŠ¤ ì •ìƒ ì‹¤í–‰ ì¤‘"
          else
            echo "âŒ ì„œë¹„ìŠ¤ ì‹¤í–‰ ì‹¤íŒ¨"
            echo "ğŸ“‹ ì„œë¹„ìŠ¤ ìƒíƒœ ìƒì„¸:"
            sudo systemctl status mindgarden.service --no-pager -l
            echo ""
            echo "ğŸ“‹ ìµœê·¼ ì„œë¹„ìŠ¤ ë¡œê·¸:"
            sudo journalctl -u mindgarden.service --no-pager -n 50
            exit 1
          fi
          
          # í¬íŠ¸ ë¦¬ìŠ¤ë‹ í™•ì¸
          echo "ğŸ” í¬íŠ¸ 8080 ë¦¬ìŠ¤ë‹ í™•ì¸..."
          if netstat -tlnp 2>/dev/null | grep -q ":8080 " || ss -tlnp 2>/dev/null | grep -q ":8080 "; then
            echo "âœ… í¬íŠ¸ 8080 ë¦¬ìŠ¤ë‹ ì¤‘"
          else
            echo "âŒ í¬íŠ¸ 8080 ë¦¬ìŠ¤ë‹ ì•ˆ ë¨"
            echo "ğŸ“‹ ì„œë¹„ìŠ¤ ë¡œê·¸ í™•ì¸:"
            sudo journalctl -u mindgarden.service --no-pager -n 100 | tail -50
          fi
          
          # HTTP í—¬ìŠ¤ì²´í¬ (ì¬ì‹œë„ 3íšŒ)
          echo "ğŸ” HTTP í—¬ìŠ¤ì²´í¬ ì‹œì‘..."
          for i in {1..3}; do
            if curl -f -s http://localhost:8080/actuator/health > /dev/null 2>&1; then
              echo "âœ… HTTP í—¬ìŠ¤ì²´í¬ í†µê³¼ (ì‹œë„ $i)"
              curl -s http://localhost:8080/actuator/health | head -10
              break
            else
              echo "â³ HTTP í—¬ìŠ¤ì²´í¬ ì¬ì‹œë„ ì¤‘... (ì‹œë„ $i/3)"
              if [ $i -lt 3 ]; then
                sleep 10
              else
                echo "âŒ HTTP í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ (3íšŒ ì‹œë„ í›„ ì‹¤íŒ¨)"
                echo "ğŸ“‹ ì„œë¹„ìŠ¤ ë¡œê·¸ ìµœê·¼ 100ì¤„:"
                sudo journalctl -u mindgarden.service --no-pager -n 100 | tail -50
                echo ""
                echo "ğŸ“‹ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸ í™•ì¸:"
                if [ -f /var/www/mindgarden/logs/mindgarden-prod.log ]; then
                  tail -50 /var/www/mindgarden/logs/mindgarden-prod.log
                fi
                echo ""
                echo "âš ï¸ HTTP í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨í–ˆì§€ë§Œ ë°°í¬ëŠ” ê³„ì† ì§„í–‰ë©ë‹ˆë‹¤."
              fi
            fi
          done
          
          # í”„ë¡ íŠ¸ì—”ë“œ í™•ì¸
          if curl -f -s http://localhost/login > /dev/null 2>&1; then
            echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ì •ìƒ ì ‘ê·¼"
          else
            echo "âŒ í”„ë¡ íŠ¸ì—”ë“œ ì ‘ê·¼ ì‹¤íŒ¨"
          fi
          
          echo "ğŸ‰ ë°°í¬ ì™„ë£Œ!"
          
    - name: ğŸ” ì„œë²„ ìƒíƒœ ìƒì„¸ í™•ì¸ (ë””ë²„ê¹…)
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        script: |
          echo "ğŸ” ìš´ì˜ ì„œë²„ ìƒíƒœ ìƒì„¸ í™•ì¸"
          echo "=================================="
          
          echo ""
          echo "1. ì„œë¹„ìŠ¤ ìƒíƒœ:"
          sudo systemctl status mindgarden.service --no-pager -l | head -30
          
          echo ""
          echo "2. ì„œë¹„ìŠ¤ ë¡œê·¸ (ìµœê·¼ 50ì¤„):"
          sudo journalctl -u mindgarden.service --no-pager -n 50
          
          echo ""
          echo "3. í¬íŠ¸ ë¦¬ìŠ¤ë‹ í™•ì¸:"
          if command -v netstat &> /dev/null; then
            netstat -tlnp 2>/dev/null | grep 8080 || echo "í¬íŠ¸ 8080 ë¦¬ìŠ¤ë‹ ì•ˆ ë¨"
          elif command -v ss &> /dev/null; then
            ss -tlnp 2>/dev/null | grep 8080 || echo "í¬íŠ¸ 8080 ë¦¬ìŠ¤ë‹ ì•ˆ ë¨"
          else
            echo "netstat ë˜ëŠ” ss ëª…ë ¹ì–´ ì—†ìŒ"
          fi
          
          echo ""
          echo "4. Java í”„ë¡œì„¸ìŠ¤ í™•ì¸:"
          ps aux | grep java | grep -v grep || echo "Java í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
          
          echo ""
          echo "5. ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸ (ìµœê·¼ 50ì¤„):"
          if [ -f /var/www/mindgarden/logs/mindgarden-prod.log ]; then
            tail -50 /var/www/mindgarden/logs/mindgarden-prod.log
          else
            echo "ë¡œê·¸ íŒŒì¼ ì—†ìŒ: /var/www/mindgarden/logs/mindgarden-prod.log"
            echo "ëŒ€ì²´ ë¡œê·¸ ìœ„ì¹˜ í™•ì¸:"
            find /var/www/mindgarden -name "*.log" -type f 2>/dev/null | head -5
          fi
          
          echo ""
          echo "6. JAR íŒŒì¼ í™•ì¸:"
          if [ -f /var/www/mindgarden/app.jar ]; then
            ls -lh /var/www/mindgarden/app.jar
          else
            echo "JAR íŒŒì¼ ì—†ìŒ: /var/www/mindgarden/app.jar"
            echo "ë””ë ‰í† ë¦¬ ë‚´ìš©:"
            ls -lh /var/www/mindgarden/ | head -10
          fi
          
          echo ""
          echo "7. í™˜ê²½ ë³€ìˆ˜ í™•ì¸:"
          if [ -f /etc/mindgarden/prod.env ]; then
            echo "í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ì¡´ì¬: /etc/mindgarden/prod.env"
            echo "íŒŒì¼ í¬ê¸°: $(ls -lh /etc/mindgarden/prod.env | awk '{print $5}')"
          else
            echo "í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ì—†ìŒ: /etc/mindgarden/prod.env"
          fi
          
          echo ""
          echo "8. ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰:"
          df -h /var/www/mindgarden 2>/dev/null || df -h /var/www
          
          echo ""
          echo "9. ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰:"
          free -h
          
          echo ""
          echo "=================================="
          
    - name: ğŸ§¹ ë©”ëª¨ë¦¬ ì •ë¦¬
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        script: |
          echo "ğŸ§¹ ë©”ëª¨ë¦¬ ì •ë¦¬ ì‹œì‘..."
          
          # 7ì¼ ì´ìƒ ëœ ë°±ì—… íŒŒì¼ ì‚­ì œ
          cd /var/www/mindgarden
          find . -name "*.backup.*" -type f -mtime +7 -delete || true
          
          # ì‹œìŠ¤í…œ ë©”ëª¨ë¦¬ ì •ë¦¬
          sync
          echo 3 | sudo tee /proc/sys/vm/drop_caches > /dev/null
          
          # ìµœì¢… ì‹œìŠ¤í…œ ìƒíƒœ
          echo "ğŸ’¾ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰:"
          free -h
          echo ""
          echo "ğŸ’¿ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰:"
          df -h /var/www/mindgarden
          echo ""
          echo "ğŸ”§ ì„œë¹„ìŠ¤ ìƒíƒœ:"
          sudo systemctl is-active mindgarden.service
          
          echo "âœ… ë©”ëª¨ë¦¬ ì •ë¦¬ ì™„ë£Œ!"