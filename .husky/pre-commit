#!/bin/sh

# CoreSolution Pre-commit Hook
# 오늘(2025-11-20) 표준화 작업 전체 검증
# 
# 검증 항목:
# - Phase 1: Controller 표준화 (ApiResponse, ErrorResponse, BaseApiController)
# - Phase 2: DTO 표준화 (Deprecated DTO 사용 감지)
# - Phase 3: 권한 관리 표준화 (SecurityUtils, PermissionMatrix)
# - Phase 4: API 경로 표준화 (/api/v1/...)
# - Phase 5: 서비스 레이어 표준화 (인터페이스, BaseService)
# - Phase 6: 로깅 표준화
# - 하드코딩 검증
# - Checkstyle 검증

echo "🔍 CoreSolution Pre-commit 검증 시작..."
echo "📅 표준화 작업 검증 (2025-11-20)"

# 프로젝트 루트로 이동
cd "$(git rev-parse --show-toplevel)" || exit 1

# 색상 정의
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# 에러 카운터
ERROR_COUNT=0
WARNING_COUNT=0

# 변경된 파일 확인
STAGED_JAVA_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.java$')
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

echo "${CYAN}========================================${NC}"
echo "${CYAN}표준화 검증 시작${NC}"
echo "${CYAN}========================================${NC}\n"

# ============================================
# Phase 2: DTO 표준화 검증
# ============================================
echo "${BLUE}[Phase 2] DTO 표준화 검증 중...${NC}"
if [ -f "scripts/validate-dto-standardization.js" ]; then
  if command -v node >/dev/null 2>&1; then
    if [ ! -z "$STAGED_JAVA_FILES" ]; then
      node scripts/validate-dto-standardization.js
      if [ $? -ne 0 ]; then
        echo "${RED}❌ DTO 표준화 검증 실패${NC}"
        ERROR_COUNT=$((ERROR_COUNT + 1))
      else
        echo "${GREEN}✅ DTO 표준화 검증 통과${NC}"
      fi
    else
      echo "${GREEN}✅ 변경된 Java 파일이 없습니다.${NC}"
    fi
  else
    echo "${YELLOW}⚠️ node가 설치되지 않았습니다. DTO 검증을 건너뜁니다.${NC}"
  fi
else
  echo "${YELLOW}⚠️ DTO 검증 스크립트가 없습니다. 건너뜁니다.${NC}"
fi
echo ""

# ============================================
# Phase 3: 권한 관리 표준화 검증
# ============================================
echo "${BLUE}[Phase 3] 권한 관리 표준화 검증 중...${NC}"
if [ ! -z "$STAGED_JAVA_FILES" ]; then
  # SecurityUtils 사용 감지 (Deprecated)
  SECURITY_UTILS_USAGE=$(echo "$STAGED_JAVA_FILES" | xargs grep -l "SecurityUtils\." 2>/dev/null | grep -v "SecurityUtils.java$" || true)
  if [ ! -z "$SECURITY_UTILS_USAGE" ]; then
    echo "${YELLOW}⚠️ SecurityUtils 사용이 감지되었습니다 (Deprecated)${NC}"
    echo "${YELLOW}   다음 파일에서 사용:${NC}"
    echo "$SECURITY_UTILS_USAGE" | sed 's/^/   - /'
    echo "${YELLOW}   → PermissionCheckUtils 또는 DynamicPermissionService 사용을 권장합니다.${NC}"
    WARNING_COUNT=$((WARNING_COUNT + 1))
  fi
  
  # PermissionMatrix 직접 사용 감지 (Deprecated)
  PERMISSION_MATRIX_USAGE=$(echo "$STAGED_JAVA_FILES" | xargs grep -l "PermissionMatrix\." 2>/dev/null | grep -v "PermissionMatrix.java$" || true)
  if [ ! -z "$PERMISSION_MATRIX_USAGE" ]; then
    echo "${YELLOW}⚠️ PermissionMatrix 직접 사용이 감지되었습니다 (Deprecated)${NC}"
    echo "${YELLOW}   다음 파일에서 사용:${NC}"
    echo "$PERMISSION_MATRIX_USAGE" | sed 's/^/   - /'
    echo "${YELLOW}   → DynamicPermissionService 사용을 권장합니다.${NC}"
    WARNING_COUNT=$((WARNING_COUNT + 1))
  fi
  
  if [ -z "$SECURITY_UTILS_USAGE" ] && [ -z "$PERMISSION_MATRIX_USAGE" ]; then
    echo "${GREEN}✅ 권한 관리 표준화 검증 통과${NC}"
  fi
else
  echo "${GREEN}✅ 변경된 Java 파일이 없습니다.${NC}"
fi
echo ""

# ============================================
# Phase 4: API 경로 표준화 검증
# ============================================
echo "${BLUE}[Phase 4] API 경로 표준화 검증 중...${NC}"
if [ ! -z "$STAGED_JAVA_FILES" ]; then
  # Controller 파일에서 /api/ 경로 사용 감지 (레거시)
  CONTROLLER_FILES=$(echo "$STAGED_JAVA_FILES" | grep -i "Controller.java$" || true)
  if [ ! -z "$CONTROLLER_FILES" ]; then
    LEGACY_API_USAGE=$(echo "$CONTROLLER_FILES" | xargs grep -l '@RequestMapping.*"/api/[^v]' 2>/dev/null || true)
    if [ ! -z "$LEGACY_API_USAGE" ]; then
      echo "${YELLOW}⚠️ 레거시 API 경로(/api/...) 사용이 감지되었습니다${NC}"
      echo "${YELLOW}   다음 파일에서 사용:${NC}"
      echo "$LEGACY_API_USAGE" | sed 's/^/   - /'
      echo "${YELLOW}   → /api/v1/... 경로 사용을 권장합니다.${NC}"
      WARNING_COUNT=$((WARNING_COUNT + 1))
    else
      echo "${GREEN}✅ API 경로 표준화 검증 통과${NC}"
    fi
  else
    echo "${GREEN}✅ 변경된 Controller 파일이 없습니다.${NC}"
  fi
else
  echo "${GREEN}✅ 변경된 Java 파일이 없습니다.${NC}"
fi
echo ""

# ============================================
# Phase 5: 서비스 레이어 표준화 검증
# ============================================
echo "${BLUE}[Phase 5] 서비스 레이어 표준화 검증 중...${NC}"
if [ ! -z "$STAGED_JAVA_FILES" ]; then
  # ServiceImpl 파일에서 인터페이스 없이 구현된 경우 감지
  SERVICE_IMPL_FILES=$(echo "$STAGED_JAVA_FILES" | grep "ServiceImpl.java$" || true)
  if [ ! -z "$SERVICE_IMPL_FILES" ]; then
    for SERVICE_IMPL in $SERVICE_IMPL_FILES; do
      SERVICE_NAME=$(basename "$SERVICE_IMPL" .java | sed 's/Impl$//')
      SERVICE_INTERFACE="src/main/java/$(echo "$SERVICE_IMPL" | sed 's|src/main/java/||' | sed 's|Impl\.java$|.java|')"
      if [ ! -f "$SERVICE_INTERFACE" ]; then
        echo "${YELLOW}⚠️ 인터페이스가 없는 ServiceImpl 발견: ${SERVICE_IMPL}${NC}"
        echo "${YELLOW}   → 서비스 인터페이스 생성을 권장합니다.${NC}"
        WARNING_COUNT=$((WARNING_COUNT + 1))
      fi
    done
    
    if [ -z "$(echo "$SERVICE_IMPL_FILES" | xargs -I {} sh -c 'SERVICE_IMPL={}; SERVICE_NAME=$(basename "$SERVICE_IMPL" .java | sed "s/Impl$//"); SERVICE_INTERFACE="src/main/java/$(echo "$SERVICE_IMPL" | sed "s|src/main/java/||" | sed "s|Impl\.java$|.java|")"; [ ! -f "$SERVICE_INTERFACE" ] && echo "$SERVICE_IMPL"')" ]; then
      echo "${GREEN}✅ 서비스 레이어 표준화 검증 통과${NC}"
    fi
  else
    echo "${GREEN}✅ 변경된 ServiceImpl 파일이 없습니다.${NC}"
  fi
else
  echo "${GREEN}✅ 변경된 Java 파일이 없습니다.${NC}"
fi
echo ""

# ============================================
# Phase 1: Controller 표준화 검증
# ============================================
echo "${BLUE}[Phase 1] Controller 표준화 검증 중...${NC}"
if [ ! -z "$STAGED_JAVA_FILES" ]; then
  CONTROLLER_FILES=$(echo "$STAGED_JAVA_FILES" | grep -i "Controller.java$" || true)
  if [ ! -z "$CONTROLLER_FILES" ]; then
    # BaseApiController 상속 여부 확인
    NOT_EXTENDING_BASE=$(echo "$CONTROLLER_FILES" | xargs grep -L "extends BaseApiController" 2>/dev/null || true)
    if [ ! -z "$NOT_EXTENDING_BASE" ]; then
      echo "${YELLOW}⚠️ BaseApiController를 상속하지 않는 Controller 발견${NC}"
      echo "${YELLOW}   다음 파일:${NC}"
      echo "$NOT_EXTENDING_BASE" | sed 's/^/   - /'
      echo "${YELLOW}   → BaseApiController 상속을 권장합니다.${NC}"
      WARNING_COUNT=$((WARNING_COUNT + 1))
    else
      echo "${GREEN}✅ Controller 표준화 검증 통과${NC}"
    fi
  else
    echo "${GREEN}✅ 변경된 Controller 파일이 없습니다.${NC}"
  fi
else
  echo "${GREEN}✅ 변경된 Java 파일이 없습니다.${NC}"
fi
echo ""

# ============================================
# Checkstyle 검증 (Java 코드)
# ============================================
echo "${BLUE}[Checkstyle] Java 코드 품질 검증 중...${NC}"
if [ -f "pom.xml" ] && command -v mvn >/dev/null 2>&1; then
  if [ ! -z "$STAGED_JAVA_FILES" ]; then
    echo "${BLUE}   변경된 Java 파일 검사 중...${NC}"
    # Checkstyle은 Maven 빌드 시 자동 실행되므로 여기서는 경고만
    echo "${GREEN}✅ Checkstyle 검증은 Maven 빌드 시 자동 실행됩니다.${NC}"
    echo "${YELLOW}   💡 mvn checkstyle:check 실행하여 상세 검증 가능${NC}"
  else
    echo "${GREEN}✅ 변경된 Java 파일이 없습니다.${NC}"
  fi
else
  echo "${YELLOW}⚠️ Maven이 설치되지 않았거나 pom.xml이 없습니다. Checkstyle 검증을 건너뜁니다.${NC}"
fi
echo ""

# ============================================
# 하드코딩 검증
# ============================================
echo "${BLUE}[하드코딩] 하드코딩 검증 중...${NC}"
if [ -f "scripts/check-hardcoding.js" ]; then
  if command -v node >/dev/null 2>&1; then
    if [ ! -z "$STAGED_FILES" ]; then
      STAGED_CODE_FILES=$(echo "$STAGED_FILES" | grep -E '\.(java|js|jsx|ts|tsx)$' || true)
      if [ ! -z "$STAGED_CODE_FILES" ]; then
        node scripts/check-hardcoding.js
        if [ $? -ne 0 ]; then
          echo "${YELLOW}⚠️ 하드코딩이 감지되었습니다. (경고)${NC}"
          WARNING_COUNT=$((WARNING_COUNT + 1))
        else
          echo "${GREEN}✅ 하드코딩 검증 통과${NC}"
        fi
      else
        echo "${GREEN}✅ 변경된 코드 파일이 없습니다.${NC}"
      fi
    else
      echo "${GREEN}✅ 변경된 파일이 없습니다.${NC}"
    fi
  else
    echo "${YELLOW}⚠️ node가 설치되지 않았습니다. 하드코딩 검증을 건너뜁니다.${NC}"
  fi
else
  echo "${YELLOW}⚠️ 하드코딩 검증 스크립트가 없습니다. 건너뜁니다.${NC}"
fi
echo ""

# ============================================
# 커밋 메시지 검사
# ============================================
echo "${BLUE}[커밋 메시지] 커밋 메시지 검사 중...${NC}"
COMMIT_MSG_FILE=$1
if [ -f "$COMMIT_MSG_FILE" ]; then
  COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")
  
  # 커밋 메시지 길이 검사
  if [ ${#COMMIT_MSG} -lt 10 ]; then
    echo "${RED}❌ 커밋 메시지가 너무 짧습니다 (최소 10자)${NC}"
    ERROR_COUNT=$((ERROR_COUNT + 1))
  fi
  
  # 금지된 키워드 검사
  if echo "$COMMIT_MSG" | grep -qi "wip\|temp\|test\|debug"; then
    echo "${YELLOW}⚠️ 커밋 메시지에 임시 키워드가 포함되어 있습니다:${NC}"
    echo "$COMMIT_MSG"
  fi
  
  if [ ${#COMMIT_MSG} -ge 10 ]; then
    echo "${GREEN}✅ 커밋 메시지 검사 통과${NC}"
  fi
else
  echo "${YELLOW}⚠️ 커밋 메시지 파일을 찾을 수 없습니다.${NC}"
fi
echo ""

# ============================================
# 결과 출력
# ============================================
echo "${CYAN}========================================${NC}"
echo "${CYAN}검증 결과${NC}"
echo "${CYAN}========================================${NC}\n"

if [ $ERROR_COUNT -eq 0 ]; then
  if [ $WARNING_COUNT -eq 0 ]; then
    echo "${GREEN}🎉 모든 검증을 통과했습니다! 커밋을 진행합니다.${NC}"
    exit 0
  else
    echo "${YELLOW}⚠️ $WARNING_COUNT 개의 경고가 있습니다.${NC}"
    echo "${GREEN}✅ 에러는 없습니다. 커밋을 진행합니다.${NC}"
    exit 0
  fi
else
  echo "${RED}❌ $ERROR_COUNT 개의 검증이 실패했습니다. 커밋을 중단합니다.${NC}"
  if [ $WARNING_COUNT -gt 0 ]; then
    echo "${YELLOW}⚠️ 추가로 $WARNING_COUNT 개의 경고가 있습니다.${NC}"
  fi
  echo ""
  echo "${YELLOW}💡 해결 방법:${NC}"
  echo "1. DTO 표준화 검증 실패:"
  echo "   node scripts/validate-dto-standardization.js"
  echo "   - PaymentRequest → PaymentCreateRequest"
  echo "   - EmailRequest → EmailSendRequest"
  echo "   - AuthRequest → LoginRequest"
  echo ""
  echo "2. 권한 관리 표준화:"
  echo "   - SecurityUtils → PermissionCheckUtils 또는 DynamicPermissionService"
  echo "   - PermissionMatrix 직접 사용 금지"
  echo ""
  echo "3. API 경로 표준화:"
  echo "   - /api/... → /api/v1/..."
  echo ""
  echo "4. 서비스 레이어 표준화:"
  echo "   - ServiceImpl은 인터페이스를 구현해야 함"
  echo ""
  echo "5. Controller 표준화:"
  echo "   - BaseApiController 상속 권장"
  echo ""
  echo "${BLUE}🔧 자동 검증 명령어:${NC}"
  echo "node scripts/validate-dto-standardization.js"
  echo "mvn validate"
  echo "mvn checkstyle:check"
  exit 1
fi

