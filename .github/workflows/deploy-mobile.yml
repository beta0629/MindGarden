name: ðŸ“± MindGarden ëª¨ë°”ì¼ ì•± ë¹Œë“œ

on:
  push:
    branches: [ main ]
    paths:
      - 'mobile/**'
      - '.github/workflows/deploy-mobile.yml'
  workflow_dispatch:
    inputs:
      platform:
        description: 'ë¹Œë“œí•  í”Œëž«í¼ (android, ios, both)'
        required: true
        default: 'both'
        type: choice
        options:
          - android
          - ios
          - both

jobs:
  build-android:
    name: ðŸ¤– Android ë¹Œë“œ
    runs-on: ubuntu-latest
    if: github.event.inputs.platform == 'android' || github.event.inputs.platform == 'both' || (github.event.inputs.platform == '' && github.event_name == 'push')
    
    steps:
    - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0
        
    - name: ðŸ“ ë””ë ‰í† ë¦¬ í™•ì¸
      run: |
        echo "í˜„ìž¬ ë””ë ‰í† ë¦¬: $(pwd)"
        echo "ë””ë ‰í† ë¦¬ êµ¬ì¡°:"
        ls -la
        echo "mobile í´ë” í™•ì¸:"
        ls -la mobile/ || echo "mobile í´ë” ì—†ìŒ"
      
    - name: â˜• Java 17 ì„¤ì • (Android ë¹Œë“œìš©)
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ðŸ“¦ Node.js 20 ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: ðŸ“ mobile ë””ë ‰í† ë¦¬ í™•ì¸
      run: |
        if [ ! -d "mobile" ]; then
          echo "âŒ mobile ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤!"
          echo "í˜„ìž¬ ë””ë ‰í† ë¦¬: $(pwd)"
          echo "ë””ë ‰í† ë¦¬ ëª©ë¡:"
          ls -la
          exit 1
        fi
        echo "âœ… mobile ë””ë ‰í† ë¦¬ í™•ì¸ë¨"
        ls -la mobile/
        
    - name: ðŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        cd mobile
        npm ci
        
    - name: ðŸ”§ Android SDK ì„¤ì •
      uses: android-actions/setup-android@v3
      with:
        api-level: 33
        build-tools: 33.0.0
        target: android-33
        
    - name: ðŸ” ë¦´ë¦¬ì¦ˆ í‚¤ìŠ¤í† ì–´ ì„¤ì • (ì„ íƒì‚¬í•­)
      if: env.ANDROID_KEYSTORE_BASE64 != ''
      env:
        ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      run: |
        if [ -n "$ANDROID_KEYSTORE_BASE64" ]; then
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > mobile/android/app/my-release-key.keystore
          echo "âœ… í‚¤ìŠ¤í† ì–´ íŒŒì¼ ìƒì„± ì™„ë£Œ"
        else
          echo "â„¹ï¸ í‚¤ìŠ¤í† ì–´ê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ - Debug ë¹Œë“œë¡œ ì§„í–‰"
        fi
        
    - name: ðŸ—ï¸ Android Release ë¹Œë“œ
      run: |
        cd mobile/android
        ./gradlew assembleRelease
        
    - name: ðŸ“¦ Android AAB ë¹Œë“œ (Google Play ì—…ë¡œë“œìš©)
      run: |
        cd mobile/android
        ./gradlew bundleRelease
        
    - name: ðŸ“¤ ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: android-release
        path: |
          mobile/android/app/build/outputs/apk/release/app-release.apk
          mobile/android/app/build/outputs/bundle/release/app-release.aab
        retention-days: 30
        
    - name: ðŸ“‹ ë¹Œë“œ ì •ë³´ ì¶œë ¥
      run: |
        echo "ðŸ“± Android ë¹Œë“œ ì™„ë£Œ"
        echo "APK ìœ„ì¹˜: mobile/android/app/build/outputs/apk/release/app-release.apk"
        echo "AAB ìœ„ì¹˜: mobile/android/app/build/outputs/bundle/release/app-release.aab"
        ls -lh mobile/android/app/build/outputs/apk/release/ || true
        ls -lh mobile/android/app/build/outputs/bundle/release/ || true

  build-ios:
    name: ðŸŽ iOS ë¹Œë“œ
    runs-on: macos-latest
    if: github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'both' || (github.event.inputs.platform == '' && github.event_name == 'push')
    
    steps:
    - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0
      
    - name: ðŸ“¦ Node.js 20 ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: ðŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        cd mobile
        npm ci
        
    - name: ðŸŽ CocoaPods ì„¤ì¹˜
      run: |
        cd mobile/ios
        sudo gem install cocoapods
        pod install
        
    - name: ðŸ—ï¸ iOS Archive ë¹Œë“œ
      run: |
        cd mobile/ios
        xcodebuild -workspace MindGardenMobile.xcworkspace \
          -scheme MindGardenMobile \
          -configuration Release \
          -sdk iphoneos \
          -archivePath build/MindGardenMobile.xcarchive \
          archive \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
          
    - name: ðŸ“¦ IPA ìƒì„±
      run: |
        cd mobile/ios
        xcodebuild -exportArchive \
          -archivePath build/MindGardenMobile.xcarchive \
          -exportPath build \
          -exportOptionsPlist ExportOptions.plist || echo "ExportOptions.plist ì—†ìŒ - IPA ìƒì„± ê±´ë„ˆëœ€"
          
    - name: ðŸ“¤ ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: ios-release
        path: |
          mobile/ios/build/MindGardenMobile.xcarchive
          mobile/ios/build/*.ipa
        retention-days: 30
        
    - name: ðŸ“‹ ë¹Œë“œ ì •ë³´ ì¶œë ¥
      run: |
        echo "ðŸŽ iOS ë¹Œë“œ ì™„ë£Œ"
        echo "Archive ìœ„ì¹˜: mobile/ios/build/MindGardenMobile.xcarchive"
        ls -lh mobile/ios/build/ || true

  notify:
    name: ðŸ“¢ ë¹Œë“œ ì™„ë£Œ ì•Œë¦¼
    runs-on: ubuntu-latest
    needs: [build-android, build-ios]
    if: always()
    
    steps:
    - name: ðŸ“¥ ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
      uses: actions/download-artifact@v4
      with:
        pattern: '*-release'
        merge-multiple: true
        path: artifacts
        
    - name: ðŸ“‹ ë¹Œë“œ ìš”ì•½
      run: |
        echo "## ðŸ“± ëª¨ë°”ì¼ ì•± ë¹Œë“œ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ¤– Android" >> $GITHUB_STEP_SUMMARY
        if [ -d "artifacts/android-release" ]; then
          echo "âœ… Android ë¹Œë“œ ì„±ê³µ" >> $GITHUB_STEP_SUMMARY
          ls -lh artifacts/android-release/ >> $GITHUB_STEP_SUMMARY || true
        else
          echo "âš ï¸ Android ë¹Œë“œ ì‹¤íŒ¨ ë˜ëŠ” ê±´ë„ˆëœ€" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŽ iOS" >> $GITHUB_STEP_SUMMARY
        if [ -d "artifacts/ios-release" ]; then
          echo "âœ… iOS ë¹Œë“œ ì„±ê³µ" >> $GITHUB_STEP_SUMMARY
          ls -lh artifacts/ios-release/ >> $GITHUB_STEP_SUMMARY || true
        else
          echo "âš ï¸ iOS ë¹Œë“œ ì‹¤íŒ¨ ë˜ëŠ” ê±´ë„ˆëœ€" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“¥ ë¹Œë“œ íŒŒì¼ì€ GitHub Actionsì˜ Artifactsì—ì„œ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY

