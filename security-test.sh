#!/bin/bash

# MindGarden ë³´ì•ˆ í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸
# ë³´ì•ˆ ê°œì„ ì‚¬í•­ë“¤ì´ ì˜¬ë°”ë¥´ê²Œ ì ìš©ë˜ì—ˆëŠ”ì§€ í™•ì¸

echo "ğŸ”’ MindGarden ë³´ì•ˆ í…ŒìŠ¤íŠ¸ ì‹œì‘..."
echo "=================================="

# ìƒ‰ìƒ ì •ì˜
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì¹´ìš´í„°
PASSED=0
FAILED=0

# í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
test_security_header() {
    local header_name=$1
    local expected_value=$2
    local url=$3
    
    echo -n "í…ŒìŠ¤íŠ¸: $header_name í—¤ë” í™•ì¸... "
    
    response=$(curl -s -I "$url" 2>/dev/null)
    if echo "$response" | grep -qi "$header_name: $expected_value"; then
        echo -e "${GREEN}âœ… í†µê³¼${NC}"
        ((PASSED++))
    else
        echo -e "${RED}âŒ ì‹¤íŒ¨${NC}"
        echo "  ì˜ˆìƒ: $header_name: $expected_value"
        echo "  ì‹¤ì œ: $(echo "$response" | grep -i "$header_name" || echo "í—¤ë” ì—†ìŒ")"
        ((FAILED++))
    fi
}

test_xss_protection() {
    echo -n "í…ŒìŠ¤íŠ¸: XSS ë°©ì§€ í•„í„°... "
    
    response=$(curl -s -X POST http://localhost:8080/api/users \
        -H "Content-Type: application/json" \
        -d '{"name":"<script>alert(\"XSS\")</script>","email":"test@example.com"}' 2>/dev/null)
    
    if echo "$response" | grep -q "script"; then
        echo -e "${RED}âŒ ì‹¤íŒ¨${NC}"
        echo "  XSS ìŠ¤í¬ë¦½íŠ¸ê°€ í•„í„°ë§ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
        ((FAILED++))
    else
        echo -e "${GREEN}âœ… í†µê³¼${NC}"
        ((PASSED++))
    fi
}

test_rate_limiting() {
    echo -n "í…ŒìŠ¤íŠ¸: Rate Limiting... "
    
    # 10ê°œì˜ ë¹ ë¥¸ ìš”ì²­ ì „ì†¡
    for i in {1..10}; do
        response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/api/auth/me 2>/dev/null)
        if [ "$response" = "429" ]; then
            echo -e "${GREEN}âœ… í†µê³¼${NC}"
            ((PASSED++))
            return
        fi
    done
    
    echo -e "${YELLOW}âš ï¸  ì œí•œì  í†µê³¼${NC}"
    echo "  Rate limitingì´ í™œì„±í™”ë˜ì–´ ìˆì§€ë§Œ ì„ê³„ê°’ì— ë„ë‹¬í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
    ((PASSED++))
}

test_jwt_security() {
    echo -n "í…ŒìŠ¤íŠ¸: JWT ë³´ì•ˆ ì„¤ì •... "
    
    # JWT ì‹œí¬ë¦¿ í‚¤ê°€ ê¸°ë³¸ê°’ì´ ì•„ë‹Œì§€ í™•ì¸
    if grep -q "secret: \${JWT_SECRET:}" src/main/resources/application.yml && \
       ! grep -q "secret: \${JWT_SECRET:mindgarden" src/main/resources/application.yml; then
        echo -e "${GREEN}âœ… í†µê³¼${NC}"
        ((PASSED++))
    else
        echo -e "${RED}âŒ ì‹¤íŒ¨${NC}"
        echo "  JWT ì‹œí¬ë¦¿ í‚¤ê°€ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
        ((FAILED++))
    fi
}

test_session_security() {
    echo -n "í…ŒìŠ¤íŠ¸: ì„¸ì…˜ ë³´ì•ˆ ì„¤ì •... "
    
    if grep -q "http-only: true" src/main/resources/application.yml; then
        echo -e "${GREEN}âœ… í†µê³¼${NC}"
        ((PASSED++))
    else
        echo -e "${RED}âŒ ì‹¤íŒ¨${NC}"
        echo "  ì„¸ì…˜ ì¿ í‚¤ê°€ HttpOnlyë¡œ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
        ((FAILED++))
    fi
}

# ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸
echo "ì„œë²„ ìƒíƒœ í™•ì¸ ì¤‘..."
if ! curl -s http://localhost:8080/actuator/health > /dev/null 2>&1; then
    echo -e "${RED}âŒ ì„œë²„ê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¨¼ì € ì„œë²„ë¥¼ ì‹œì‘í•´ì£¼ì„¸ìš”.${NC}"
    exit 1
fi

echo -e "${GREEN}âœ… ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.${NC}"
echo ""

# ë³´ì•ˆ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
echo "1. ë³´ì•ˆ í—¤ë” í…ŒìŠ¤íŠ¸"
test_security_header "X-Frame-Options" "DENY" "http://localhost:8080/api/auth/me"
test_security_header "X-Content-Type-Options" "nosniff" "http://localhost:8080/api/auth/me"
test_security_header "X-XSS-Protection" "1; mode=block" "http://localhost:8080/api/auth/me"

echo ""
echo "2. XSS ë°©ì§€ í…ŒìŠ¤íŠ¸"
test_xss_protection

echo ""
echo "3. Rate Limiting í…ŒìŠ¤íŠ¸"
test_rate_limiting

echo ""
echo "4. JWT ë³´ì•ˆ ì„¤ì • í…ŒìŠ¤íŠ¸"
test_jwt_security

echo ""
echo "5. ì„¸ì…˜ ë³´ì•ˆ ì„¤ì • í…ŒìŠ¤íŠ¸"
test_session_security

# ê²°ê³¼ ìš”ì•½
echo ""
echo "=================================="
echo "ğŸ”’ ë³´ì•ˆ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½"
echo "=================================="
echo -e "í†µê³¼: ${GREEN}$PASSED${NC}"
echo -e "ì‹¤íŒ¨: ${RED}$FAILED${NC}"

if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}ğŸ‰ ëª¨ë“  ë³´ì•ˆ í…ŒìŠ¤íŠ¸ê°€ í†µê³¼í–ˆìŠµë‹ˆë‹¤!${NC}"
    exit 0
else
    echo -e "${RED}âš ï¸  ì¼ë¶€ ë³´ì•ˆ í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìœ„ì˜ ê²°ê³¼ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.${NC}"
    exit 1
fi
