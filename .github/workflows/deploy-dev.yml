name: ğŸ§ª MindGarden ê°œë°œ ì„œë²„ ë°°í¬

on:
  push:
    branches: [ develop ]
    # develop ë¸Œëœì¹˜ì— pushí•˜ë©´ ìë™ìœ¼ë¡œ ê°œë°œ ì„œë²„ì— ë°°í¬
    # main ë¸Œëœì¹˜ëŠ” ìš´ì˜ ë°°í¬ìš©ì´ë¯€ë¡œ ê°œë°œ ë°°í¬ì—ì„œ ì œì™¸
  workflow_dispatch:
    # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  deploy:
    name: ğŸ—ï¸ ê°œë°œ ì„œë²„ ë¹Œë“œ ë° ë°°í¬
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: â˜• Java 17 ì„¤ì •
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ğŸ“¦ Node.js 18 ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: ğŸ”§ Maven ìºì‹œ ì„¤ì •
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: ğŸ—ï¸ ë°±ì—”ë“œ ë¹Œë“œ
      run: mvn clean package -DskipTests
      
    - name: ğŸ“¦ í”„ë¡ íŠ¸ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        cd frontend
        npm ci
        
    - name: ğŸ—ï¸ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ
      run: |
        cd frontend
        npm run build:ci
        
    - name: ğŸ” ê°œë°œ ì„œë²„ SSH ì—°ê²° í…ŒìŠ¤íŠ¸
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.DEV_SERVER_HOST }}
        username: ${{ secrets.DEV_SERVER_USER }}
        key: ${{ secrets.DEV_SERVER_SSH_KEY }}
        port: 22
        timeout: 30s
        script: |
          echo "âœ… ê°œë°œ ì„œë²„ SSH ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ: $(date)"
          echo "ì„œë²„ ì •ë³´: $(uname -a)"
          echo "í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
          
    - name: ğŸš€ ê°œë°œ ì„œë²„ ë°°í¬ ì¤€ë¹„
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.DEV_SERVER_HOST }}
        username: ${{ secrets.DEV_SERVER_USER }}
        key: ${{ secrets.DEV_SERVER_SSH_KEY }}
        port: 22
        timeout: 120s
        command_timeout: 30m
        script: |
          # ë°°í¬ ë””ë ‰í† ë¦¬ ìƒì„± (ì—†ìœ¼ë©´ ìƒì„±)
          mkdir -p /var/www/mindgarden-dev
          cd /var/www/mindgarden-dev
          
          # ì„œë¹„ìŠ¤ ì¤‘ì§€ (ìˆìœ¼ë©´)
          if systemctl is-active --quiet mindgarden-dev.service 2>/dev/null; then
            echo "ğŸ›‘ ê¸°ì¡´ ì„œë¹„ìŠ¤ ì¤‘ì§€ ì¤‘..."
            sudo systemctl stop mindgarden-dev.service || true
          fi
          
          # ë°±ì—… ìƒì„±
          if [ -f app.jar ]; then
            BACKUP_DIR="/var/www/mindgarden-dev/backups"
            mkdir -p $BACKUP_DIR
            cp app.jar $BACKUP_DIR/app.jar.backup.$(date +%Y%m%d_%H%M%S)
            echo "âœ… ë°±ì—”ë“œ ë°±ì—… ì™„ë£Œ"
          fi
          
          if [ -d frontend ]; then
            BACKUP_DIR="/var/www/mindgarden-dev/backups"
            mkdir -p $BACKUP_DIR
            tar -czf $BACKUP_DIR/frontend.backup.$(date +%Y%m%d_%H%M%S).tar.gz frontend/ 2>/dev/null || true
            echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ë°±ì—… ì™„ë£Œ"
          fi
          
    - name: ğŸ“¤ ë°±ì—”ë“œ íŒŒì¼ ì—…ë¡œë“œ (ê°œë°œ ì„œë²„)
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.DEV_SERVER_HOST }}
        username: ${{ secrets.DEV_SERVER_USER }}
        key: ${{ secrets.DEV_SERVER_SSH_KEY }}
        port: 22
        timeout: 120s
        source: "target/consultation-management-system-1.0.0.jar"
        target: "/var/www/mindgarden-dev/"
        strip_components: 1
        overwrite: true
        
    - name: ğŸ“¤ í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ ì—…ë¡œë“œ (ê°œë°œ ì„œë²„)
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.DEV_SERVER_HOST }}
        username: ${{ secrets.DEV_SERVER_USER }}
        key: ${{ secrets.DEV_SERVER_SSH_KEY }}
        port: 22
        timeout: 120s
        source: "frontend/build/*"
        target: "/var/www/html-dev/"
        strip_components: 2
        overwrite: true
        
    - name: ğŸ“¤ Nginx ì„¤ì • íŒŒì¼ ì—…ë¡œë“œ (ê°œë°œ ì„œë²„)
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.DEV_SERVER_HOST }}
        username: ${{ secrets.DEV_SERVER_USER }}
        key: ${{ secrets.DEV_SERVER_SSH_KEY }}
        port: 22
        timeout: 120s
        source: "config/nginx/dev.m-garden.co.kr.conf"
        target: "/tmp/"
        strip_components: 1
        overwrite: true
        
    - name: ğŸ“¤ ê°œë°œ ì„œë²„ ì„¤ì • íŒŒì¼ ì—…ë¡œë“œ
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.DEV_SERVER_HOST }}
        username: ${{ secrets.DEV_SERVER_USER }}
        key: ${{ secrets.DEV_SERVER_SSH_KEY }}
        port: 22
        timeout: 120s
        source: "src/main/resources/application-dev.yml"
        target: "/var/www/mindgarden-dev/"
        strip_components: 2
        overwrite: true
        
    - name: ğŸ”„ ê°œë°œ ì„œë²„ ì„œë¹„ìŠ¤ ì¬ì‹œì‘
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.DEV_SERVER_HOST }}
        username: ${{ secrets.DEV_SERVER_USER }}
        key: ${{ secrets.DEV_SERVER_SSH_KEY }}
        port: 22
        timeout: 60s
        command_timeout: 5m
        script: |
          cd /var/www/mindgarden-dev
          
          # JAR íŒŒì¼ëª… ë³€ê²½
          if [ -f consultation-management-system-1.0.0.jar ]; then
            mv consultation-management-system-1.0.0.jar app.jar
          fi
          
          # ê¶Œí•œ ì„¤ì •
          chmod +x app.jar
          
          # systemd ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„± (ì—†ìœ¼ë©´)
          if [ ! -f /etc/systemd/system/mindgarden-dev.service ]; then
            echo "ğŸ“ systemd ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„± ì¤‘..."
            sudo bash -c "cat > /etc/systemd/system/mindgarden-dev.service" << 'SYSTEMD_EOF'
[Unit]
Description=MindGarden Development Server
After=network.target mysql.service

[Service]
Type=simple
User=root
WorkingDirectory=/var/www/mindgarden-dev
EnvironmentFile=/etc/mindgarden/dev.env
ExecStart=/usr/bin/java -jar /var/www/mindgarden-dev/app.jar --spring.profiles.active=dev
Restart=on-failure
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
SYSTEMD_EOF
            sudo systemctl daemon-reload
            sudo systemctl enable mindgarden-dev.service
            echo "âœ… systemd ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„± ì™„ë£Œ"
          fi
          
          # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„±/ì—…ë°ì´íŠ¸ (ì—†ìœ¼ë©´)
          if [ ! -f /etc/mindgarden/dev.env ]; then
            echo "ğŸ“ í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„± ì¤‘..."
            sudo mkdir -p /etc/mindgarden
            sudo tee /etc/mindgarden/dev.env > /dev/null << 'ENVEOF'
# ê°œë°œ ì„œë²„ í™˜ê²½ ë³€ìˆ˜
DB_HOST=beta0629.cafe24.com
DB_PORT=3306
DB_NAME=mind_garden
DB_USERNAME=mindgarden_dev
DB_PASSWORD=MindGardenDev2025!@#
JWT_SECRET=dev-jwt-secret-key-change-me
PERSONAL_DATA_ENCRYPTION_KEY=dev-encryption-key-32-chars-long
PERSONAL_DATA_ENCRYPTION_IV=dev-iv-16-chars
SERVER_PORT=8080
FRONTEND_BASE_URL=http://dev.m-garden.co.kr
ENVEOF
            sudo chmod 600 /etc/mindgarden/dev.env
            echo "âœ… í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„± ì™„ë£Œ"
          fi
          
          # ì„œë¹„ìŠ¤ ì¬ì‹œì‘
          echo "ğŸ”„ ê°œë°œ ì„œë²„ ì„œë¹„ìŠ¤ ì¬ì‹œì‘..."
          sudo systemctl daemon-reload
          sudo systemctl stop mindgarden-dev.service || true
          sleep 5
          sudo systemctl start mindgarden-dev.service
          sleep 15
          
          # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
          echo "ğŸ” ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸..."
          sudo systemctl status mindgarden-dev.service --no-pager | head -15
          
          # ì„œë¹„ìŠ¤ í™œì„±í™” ìƒíƒœ í™•ì¸
          if sudo systemctl is-active --quiet mindgarden-dev.service; then
            echo "âœ… ê°œë°œ ì„œë²„ ì„œë¹„ìŠ¤ ì •ìƒ ì‹œì‘ë¨"
          else
            echo "âŒ ì„œë¹„ìŠ¤ ì‹œì‘ ì‹¤íŒ¨ - ì¬ì‹œë„..."
            sudo systemctl restart mindgarden-dev.service
            sleep 15
            sudo systemctl status mindgarden-dev.service --no-pager | head -15
          fi
          
          # Nginx ì„¤ì • ì—…ë°ì´íŠ¸ (ì„¤ì • íŒŒì¼ì´ ì—…ë¡œë“œëœ ê²½ìš°)
          if [ -f /tmp/dev.m-garden.co.kr.conf ]; then
            echo "ğŸŒ Nginx ì„¤ì • ì—…ë°ì´íŠ¸ ì¤‘..."
            sudo cp /tmp/dev.m-garden.co.kr.conf /etc/nginx/sites-available/dev.m-garden.co.kr.conf
            sudo ln -sf /etc/nginx/sites-available/dev.m-garden.co.kr.conf /etc/nginx/sites-enabled/
            
            # í”„ë¡ íŠ¸ì—”ë“œ ë””ë ‰í† ë¦¬ ê¶Œí•œ ì„¤ì •
            sudo chown -R www-data:www-data /var/www/html-dev
            sudo chmod -R 755 /var/www/html-dev
            
            # Nginx ì„¤ì • í…ŒìŠ¤íŠ¸
            if sudo nginx -t; then
              sudo systemctl reload nginx
              echo "âœ… Nginx ì„¤ì • ì—…ë°ì´íŠ¸ ì™„ë£Œ"
            else
              echo "âš ï¸ Nginx ì„¤ì • ì˜¤ë¥˜ - ìˆ˜ë™ í™•ì¸ í•„ìš”"
            fi
          fi
          
    - name: ğŸ¥ ê°œë°œ ì„œë²„ í—¬ìŠ¤ì²´í¬
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.DEV_SERVER_HOST }}
        username: ${{ secrets.DEV_SERVER_USER }}
        key: ${{ secrets.DEV_SERVER_SSH_KEY }}
        port: 22
        timeout: 30s
        script: |
          echo "ğŸ¥ ê°œë°œ ì„œë²„ í—¬ìŠ¤ì²´í¬ ì‹œì‘..."
          sleep 5
          
          # Health Check (ìµœëŒ€ 3íšŒ ì¬ì‹œë„)
          for i in {1..3}; do
            if curl -f -s http://localhost:8080/actuator/health > /dev/null 2>&1; then
              echo "âœ… ê°œë°œ ì„œë²„ í—¬ìŠ¤ì²´í¬ ì„±ê³µ (ì‹œë„ $i)"
              curl -s http://localhost:8080/actuator/health | head -5
              exit 0
            else
              echo "â³ í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° ì¤‘... (ì‹œë„ $i/3)"
              sleep 10
            fi
          done
          
          echo "âš ï¸ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ - ì„œë¹„ìŠ¤ ë¡œê·¸ í™•ì¸ í•„ìš”"
          sudo journalctl -u mindgarden-dev.service --no-pager -n 50
          exit 1

