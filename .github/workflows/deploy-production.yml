name: Deploy to Production

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.gitignore'

  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸš€ ë°°í¬ ì‹œì‘
      run: echo "MindGarden ìš´ì˜ ì„œë²„ ë°°í¬ ì‹œì‘..."

    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: â˜• Java 17 ì„¤ì •
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: ğŸ“¦ Maven ìºì‹œ
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: ğŸ”¨ ë°±ì—”ë“œ ë¹Œë“œ
      run: mvn clean package -DskipTests

    - name: ğŸ“± Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: ğŸ¨ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ
      run: |
        cd frontend
        npm ci
        REACT_APP_API_BASE_URL=http://m-garden.co.kr npm run build
        cd ..

    - name: ğŸ“¤ ì„œë²„ ë°°í¬
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        script: |
          # ê¸°ì¡´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¤‘ì§€ (systemd service)
          sudo systemctl stop mindgarden.service || true
          sleep 5
          
          # ë°±ì—… ìƒì„±
          mkdir -p /var/www/mindgarden-backup/$(date +%Y%m%d_%H%M%S)
          cp /var/www/mindgarden/app.jar /var/www/mindgarden-backup/$(date +%Y%m%d_%H%M%S)/ 2>/dev/null || true
          
          # ë””ë ‰í† ë¦¬ ì¤€ë¹„
          mkdir -p /var/www/mindgarden
          cd /var/www/mindgarden

    - name: ğŸ“ íŒŒì¼ ì—…ë¡œë“œ
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        source: |
          target/consultation-management-system-*.jar
          frontend/build/*
          deployment/application-production.yml
          deployment/memory-management.sh
          deployment/oauth2-callback-test.sh
          deployment/deploy-common-codes.sh
          deployment/complete-common-codes-migration.sql
        target: /var/www/mindgarden/
        strip_components: 1

    - name: ğŸ”„ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¬ì‹œì‘
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        script: |
          cd /var/www/mindgarden
          
          # JAR íŒŒì¼ ì´ë¦„ ë³€ê²½
          mv consultation-management-system-*.jar app.jar 2>/dev/null || true
          
          # í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ ë°°í¬
          sudo cp -r build/* /var/www/html/ 2>/dev/null || true
          
          # ê³µí†µì½”ë“œ ë°°í¬
          chmod +x deployment/deploy-common-codes.sh
          ./deployment/deploy-common-codes.sh || echo "âš ï¸ ê³µí†µì½”ë“œ ë°°í¬ ì‹¤íŒ¨ (ê³„ì† ì§„í–‰)"
          
          # systemd service ì¬ì‹œì‘
          sudo systemctl daemon-reload
          sudo systemctl start mindgarden.service
          sudo systemctl enable mindgarden.service
          
          # ì‹œì‘ ëŒ€ê¸°
          sleep 15
          
          # ìƒíƒœ í™•ì¸
          if curl -f http://localhost:8081/actuator/health; then
            echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì„±ê³µ"
          else
            echo "âŒ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹¤íŒ¨"
            sudo systemctl status mindgarden.service --no-pager
            tail -n 50 /var/www/mindgarden/app.log || sudo journalctl -u mindgarden.service -n 50 --no-pager
            exit 1
          fi

    - name: ğŸ” ë°°í¬ ê²€ì¦
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        script: |
          cd /var/www/mindgarden
          ./oauth2-callback-test.sh || echo "OAuth2 í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ"
          ./memory-management.sh check || echo "ë©”ëª¨ë¦¬ ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ"
          
          # ìµœì¢… ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
          sudo systemctl is-active mindgarden.service
          echo "ğŸ” MindGarden ì„œë¹„ìŠ¤ ìƒíƒœ: $(sudo systemctl is-active mindgarden.service)"

    - name: ğŸ“¢ ë°°í¬ ì™„ë£Œ ì•Œë¦¼
      run: |
        echo "ğŸ‰ MindGarden ìš´ì˜ ì„œë²„ ë°°í¬ ì™„ë£Œ!"
        echo "ğŸŒ ì ‘ì† URL: http://m-garden.co.kr"
        echo "ğŸ” API ìƒíƒœ: http://m-garden.co.kr/api/actuator/health"
