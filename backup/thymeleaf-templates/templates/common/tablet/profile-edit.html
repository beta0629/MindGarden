<!-- 공통 프로필 편집 컨텐츠 -->
<div th:fragment="content" class="tablet-profile-edit-page">
    <!-- Bootstrap Icons CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <!-- 프로필 편집 페이지 전용 CSS -->
    <style>
        .tablet-profile-edit-page {
            padding: 1.5rem;
            padding-bottom: 120px;
            max-width: 1400px;
            margin: 0 auto;
            text-align: center;
            min-width: 768px;
            width: 100%;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        
        .profile-edit-header {
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .profile-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .profile-subtitle {
            font-size: 1.1rem;
            color: #7f8c8d;
            margin-bottom: 0;
            line-height: 1.6;
        }
        
        .form-section {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .section-title i {
            color: #3498db;
            font-size: 1.3rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }
        
        .form-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3498db;
            background: white;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .form-input.error {
            border-color: #e74c3c;
            background: #fdf2f2;
        }
        
        .form-help {
            font-size: 0.9rem;
            color: #6c757d;
            margin-top: 0.25rem;
            font-style: italic;
        }
        
        .error-message {
            color: #e74c3c;
            font-size: 0.9rem;
            margin-top: 0.25rem;
            min-height: 1.2rem;
        }
        
        .image-upload {
            text-align: center;
        }
        
        .image-preview {
            width: 200px;
            height: 200px;
            border: 3px dashed #bdc3c7;
            border-radius: 20px;
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
            position: relative;
        }
        
        .image-preview:hover {
            border-color: #3498db;
            background: #e3f2fd;
        }
        
        .image-preview.has-image {
            border-style: solid;
            border-color: #27ae60;
        }
        
        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 17px;
        }
        
        .upload-icon {
            font-size: 3rem;
            color: #bdc3c7;
        }
        
        .remove-image {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #e74c3c;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .upload-text {
            font-size: 1rem;
            color: #2c3e50;
            margin-bottom: 1rem;
            font-weight: 500;
        }
        
        .upload-tips {
            background: #e8f4fd;
            border-radius: 12px;
            padding: 1rem;
            text-align: left;
        }
        
        .upload-tips p {
            margin: 0.5rem 0;
            color: #2980b9;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .upload-tips i {
            color: #3498db;
            font-size: 1rem;
        }
        
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: background-color 0.2s ease;
        }
        
        .checkbox-item:hover {
            background: #f8f9fa;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #3498db;
        }
        
        .form-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(149, 165, 166, 0.3);
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(149, 165, 166, 0.4);
        }
        
        .btn-cancel {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }
        
        .btn-cancel:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }
        
        .help-section {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            margin-top: 2rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .help-section h4 {
            color: #2c3e50;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .help-section i {
            color: #f39c12;
        }
        
        .help-content p {
            color: #7f8c8d;
            margin-bottom: 1rem;
            line-height: 1.6;
        }
        
        .help-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .help-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            text-decoration: none;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
        }
        
        .help-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(243, 156, 18, 0.4);
            text-decoration: none;
            color: white;
        }
        
        .success-message {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 1rem 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            text-align: center;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
            display: none;
        }
        
        /* 태블릿 고정 레이아웃 */
        @media (min-width: 768px) {
            .tablet-profile-edit-page {
                min-width: 768px;
                width: 100%;
                max-width: 1400px;
                margin: 0 auto;
            }
        }
    </style>
        <!-- 페이지 헤더 -->
        <div class="profile-edit-header">
            <h1 class="profile-title" th:text="${user?.role == 'CLIENT' ? '내담자 프로필 편집' : 
                                                   user?.role == 'CONSULTANT' ? '상담사 프로필 편집' : 
                                                   '관리자 프로필 편집'}">
                프로필 편집
            </h1>
            <p class="profile-subtitle" th:text="${user?.role == 'CLIENT' ? '내담자님의 정보를 업데이트하고 프로필을 완성해주세요' : 
                                                      user?.role == 'CONSULTANT' ? '상담사님의 정보를 업데이트하고 프로필을 완성해주세요' : 
                                                      '관리자님의 정보를 업데이트하고 프로필을 완성해주세요'}">
                사용자님의 정보를 업데이트하고 프로필을 완성해주세요
            </p>
        </div>
        
        <!-- 성공 메시지 -->
        <div id="successMessage" class="success-message"></div>
        
        <!-- 프로필 편집 폼 -->
        <form id="profileForm" class="profile-form">
            <!-- 기본 정보 섹션 -->
            <div class="form-section">
                <h3 class="section-title">
                    <i class="bi bi-person-circle"></i>
                    기본 정보
                </h3>
                
                <div class="form-group">
                    <label for="name" class="form-label">이름 *</label>
                    <input type="text" id="name" name="name" class="form-input" th:value="${user?.name}" required>
                    <div class="error-message"></div>
                </div>
                
                <div class="form-group">
                    <label for="nickname" class="form-label">닉네임</label>
                    <input type="text" id="nickname" name="nickname" class="form-input" placeholder="닉네임을 입력하세요">
                    <div class="error-message"></div>
                </div>
                
                <div class="form-group">
                    <label for="email" class="form-label">이메일</label>
                    <input type="email" id="email" name="email" class="form-input" th:value="${user?.email}" readonly>
                    <small class="form-help">이메일은 변경할 수 없습니다</small>
                </div>
                
                <!-- 상담사 전용 필드 -->
                <div class="form-group" th:if="${user?.role == 'CONSULTANT'}">
                    <label for="specialization" class="form-label">전문 분야</label>
                    <select id="specialization" name="specialization" class="form-input">
                        <option value="">전문 분야를 선택하세요</option>
                        <option value="COUNSELING">상담 심리학</option>
                        <option value="PSYCHOLOGY">심리학</option>
                        <option value="SOCIAL_WORK">사회복지학</option>
                        <option value="EDUCATION">교육학</option>
                        <option value="MEDICAL">의학/정신의학</option>
                        <option value="OTHER">기타</option>
                    </select>
                    <div class="error-message"></div>
                </div>
                
                <!-- 상담사 전용 필드 -->
                <div class="form-group" th:if="${user?.role == 'CONSULTANT'}">
                    <label for="experience" class="form-label">경력 (년)</label>
                    <input type="number" id="experience" name="experience" class="form-input" min="0" max="50" placeholder="경력 연수를 입력하세요">
                    <div class="error-message"></div>
                </div>
                
                <!-- 상담사 전용 필드 -->
                <div class="form-group" th:if="${user?.role == 'CONSULTANT'}">
                    <label for="introduction" class="form-label">자기소개</label>
                    <textarea id="introduction" name="introduction" class="form-input" rows="4" 
                              placeholder="상담사님에 대해 간단히 소개해주세요"></textarea>
                    <div class="error-message"></div>
                </div>
            </div>
            
            <!-- 이미지 업로드 섹션 -->
            <div class="form-section">
                <h3 class="section-title">
                    <i class="bi bi-camera"></i>
                    프로필 이미지
                </h3>
                
                <div class="image-upload">
                    <div class="image-preview" id="imagePreview" onclick="document.getElementById('imageInput').click()">
                        <i class="bi bi-camera upload-icon"></i>
                        <button type="button" class="remove-image" onclick="removeImage()">×</button>
                    </div>
                    <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
                    <p class="upload-text">
                        <strong>클릭하여 이미지 선택</strong> 또는 이미지를 여기로 드래그하세요
                    </p>
                    <div class="upload-tips">
                        <p><i class="bi bi-info-circle"></i> 권장 크기: 300x300px 이상</p>
                        <p><i class="bi bi-info-circle"></i> 지원 형식: JPG, PNG, GIF</p>
                        <p><i class="bi bi-info-circle"></i> 최대 크기: 5MB</p>
                    </div>
                </div>
            </div>
            
            <!-- 추가 정보 섹션 -->
            <div class="form-section">
                <h3 class="section-title">
                    <i class="bi bi-gear"></i>
                    추가 설정
                </h3>
                
                <div class="form-group">
                    <label for="notification" class="form-label">알림 설정</label>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" name="emailNotification" checked>
                            <span class="checkmark"></span>
                            이메일 알림 받기
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="smsNotification">
                            <span class="checkmark"></span>
                            SMS 알림 받기
                        </label>
                    </div>
                </div>
                
                <!-- 상담사 전용 설정 -->
                <div class="form-group" th:if="${user?.role == 'CONSULTANT'}">
                    <label for="consultantSettings" class="form-label">상담사 설정</label>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" name="availableForConsultation" checked>
                            <span class="checkmark"></span>
                            상담 가능 상태로 표시
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="showInDirectory">
                            <span class="checkmark"></span>
                            상담사 디렉토리에 표시
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- 버튼 -->
            <div class="form-buttons">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-circle"></i>
                    프로필 저장
                </button>
                <button type="button" class="btn btn-secondary" onclick="resetForm()">
                    <i class="bi bi-arrow-clockwise"></i>
                    초기화
                </button>
                <button type="button" class="btn btn-cancel" onclick="goBack()">
                    <i class="bi bi-x-circle"></i>
                    취소
                </button>
            </div>
        </form>
        
        <!-- 도움말 섹션 -->
        <div class="help-section">
            <h4><i class="bi bi-question-circle"></i> 도움이 필요하신가요?</h4>
            <div class="help-content">
                <p>프로필 편집에 문제가 있으시다면 고객센터에 문의해주세요.</p>
                <div class="help-actions">
                    <a href="#" class="help-link">
                        <i class="bi bi-chat-dots"></i>
                        고객센터 문의
                    </a>
                    <a href="#" class="help-link">
                        <i class="bi bi-book"></i>
                        사용자 가이드
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 페이지별 JavaScript -->
    <script th:fragment="additionalScripts">
        let selectedFile = null;
        
        // 이미지 선택 처리
        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (file) {
                // 파일 유효성 검사
                if (!file.type.startsWith('image/')) {
                    alert('이미지 파일만 선택할 수 있습니다.');
                    return;
                }
                
                if (file.size > 5 * 1024 * 1024) { // 5MB 제한
                    alert('파일 크기는 5MB 이하여야 합니다.');
                    return;
                }
                
                selectedFile = file;
                displayImage(file);
            }
        }
        
        // 이미지 표시
        function displayImage(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('imagePreview');
                preview.innerHTML = `
                    <img src="${e.target.result}" alt="프로필 이미지">
                    <button type="button" class="remove-image" onclick="removeImage()">×</button>
                `;
                preview.classList.add('has-image');
            };
            reader.readAsDataURL(file);
        }
        
        // 이미지 제거
        function removeImage() {
            selectedFile = null;
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '<i class="bi bi-camera upload-icon"></i>';
            preview.classList.remove('has-image');
            document.getElementById('imageInput').value = '';
        }
        
        // 폼 제출 처리
        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // 기본 유효성 검사
            const name = document.getElementById('name').value.trim();
            if (!name) {
                showFieldError('name', '이름을 입력해주세요.');
                return;
            }
            
            // FormData 생성
            const formData = new FormData();
            formData.append('name', name);
            
            const nickname = document.getElementById('nickname').value.trim();
            if (nickname) {
                formData.append('nickname', nickname);
            }
            
            if (selectedFile) {
                formData.append('profileImage', selectedFile);
            }
            
            // 상담사 전용 필드 추가
            const userRole = '[[${user?.role}]]';
            if (userRole === 'CONSULTANT') {
                const specialization = document.getElementById('specialization')?.value;
                if (specialization) {
                    formData.append('specialization', specialization);
                }
                
                const experience = document.getElementById('experience')?.value;
                if (experience) {
                    formData.append('experience', experience);
                }
                
                const introduction = document.getElementById('introduction')?.value;
                if (introduction) {
                    formData.append('introduction', introduction);
                }
                
                const availableForConsultation = document.querySelector('input[name="availableForConsultation"]')?.checked;
                formData.append('availableForConsultation', availableForConsultation);
                
                const showInDirectory = document.querySelector('input[name="showInDirectory"]')?.checked;
                formData.append('showInDirectory', showInDirectory);
            }
            
            try {
                // 역할별 API 엔드포인트 결정
                let apiEndpoint = '';
                switch (userRole) {
                    case 'CLIENT':
                        apiEndpoint = '/api/client/profile/update';
                        break;
                    case 'CONSULTANT':
                        apiEndpoint = '/api/consultant/profile/update';
                        break;
                    case 'ADMIN':
                    case 'SUPER_ADMIN':
                        apiEndpoint = '/api/admin/profile/update';
                        break;
                    default:
                        apiEndpoint = '/api/client/profile/update';
                }
                
                // 프로필 업데이트 API 호출
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showSuccess('프로필이 성공적으로 업데이트되었습니다!');
                    
                    // 프로필 이미지가 업데이트되었다면 헤더에 반영
                    if (selectedFile) {
                        // 이미지 파일을 Data URL로 변환하여 헤더에 저장
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            localStorage.setItem('profileImageUrl', e.target.result);
                        };
                        reader.readAsDataURL(selectedFile);
                    }
                    
                                            // 잠시 후 대시보드로 이동
                        setTimeout(() => {
                            let dashboardUrl = '';
                            switch (userRole) {
                                case 'CLIENT':
                                    dashboardUrl = '/tablet/client/dashboard';
                                    break;
                                case 'CONSULTANT':
                                    dashboardUrl = '/tablet/consultant/dashboard';
                                    break;
                                case 'ADMIN':
                                case 'SUPER_ADMIN':
                                    dashboardUrl = '/tablet/admin/dashboard';
                                    break;
                                default:
                                    dashboardUrl = '/tablet/client/dashboard';
                            }
                            window.location.href = dashboardUrl;
                        }, 2000);
                } else {
                    const error = await response.json();
                    showError(error.message || '프로필 업데이트에 실패했습니다.');
                }
            } catch (error) {
                console.error('프로필 업데이트 오류:', error);
                showError('네트워크 오류가 발생했습니다. 다시 시도해주세요.');
            }
        });
        
        // 필드 오류 표시
        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const errorElement = field.nextElementSibling;
            
            field.classList.add('error');
            errorElement.textContent = message;
        }
        
        // 성공 메시지 표시
        function showSuccess(message) {
            const successElement = document.getElementById('successMessage');
            successElement.textContent = message;
            successElement.style.display = 'block';
            
            // 5초 후 숨김
            setTimeout(() => {
                successElement.style.display = 'none';
            }, 5000);
        }
        
        // 오류 메시지 표시
        function showError(message) {
            // 간단한 알림으로 표시 (기존 알림 시스템 활용)
            if (window.showNotification) {
                window.showNotification(message, 'error');
            } else {
                alert(message);
            }
        }
        
        // 폼 초기화
        function resetForm() {
            if (confirm('입력한 모든 내용이 초기화됩니다. 계속하시겠습니까?')) {
                document.getElementById('profileForm').reset();
                removeImage();
                
                // 오류 메시지 제거
                const errorMessages = document.querySelectorAll('.error-message');
                errorMessages.forEach(msg => msg.textContent = '');
                
                // 오류 스타일 제거
                const errorFields = document.querySelectorAll('.form-input.error');
                errorFields.forEach(field => field.classList.remove('error'));
            }
        }
        
        // 뒤로 가기
        function goBack() {
            if (confirm('저장하지 않은 변경사항이 있습니다. 정말 나가시겠습니까?')) {
                window.history.back();
            }
        }
    </script>
