name: ğŸŒŸ Trinity í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œ ì„œë²„ ë°°í¬

on:
  push:
    branches: [ develop ]
    paths:
      - 'frontend-trinity/**'
      - '.github/workflows/deploy-trinity-dev.yml'
  workflow_dispatch:
    # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  deploy-trinity:
    name: ğŸ—ï¸ Trinity í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ë° ë°°í¬
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Node.js 18 ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend-trinity/package-lock.json
        
    - name: ğŸ“¦ Trinity í”„ë¡ íŠ¸ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        cd frontend-trinity
        npm ci
        
    - name: ğŸ—ï¸ Trinity í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ
      run: |
        cd frontend-trinity
        ESLINT_NO_DEV_ERRORS=true npm run build
        
    - name: ğŸ” Trinity í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ê²°ê³¼ í™•ì¸
      run: |
        echo "ğŸ” Trinity í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ê²°ê³¼ í™•ì¸..."
        if [ -d frontend-trinity/out ]; then
          FILE_COUNT=$(find frontend-trinity/out -type f 2>/dev/null | wc -l)
          if [ "$FILE_COUNT" -gt 0 ]; then
            echo "âœ… frontend-trinity/out ë””ë ‰í† ë¦¬ ìƒì„±ë¨: $FILE_COUNT ê°œ íŒŒì¼"
          else
            echo "âŒ frontend-trinity/out ë””ë ‰í† ë¦¬ê°€ ë¹„ì–´ìˆìŒ!"
            exit 1
          fi
        else
          echo "âŒ frontend-trinity/out ë””ë ‰í† ë¦¬ ì—†ìŒ!"
          exit 1
        fi
        
    - name: ğŸ“¤ Trinity í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ ì—…ë¡œë“œ SCP (ê°œë°œ ì„œë²„)
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.DEV_SERVER_HOST }}
        username: ${{ secrets.DEV_SERVER_USER }}
        key: ${{ secrets.DEV_SERVER_SSH_KEY }}
        port: 22
        timeout: 120s
        source: "frontend-trinity/out/*"
        target: "/var/www/html-trinity/"
        strip_components: 2
        overwrite: true
        
    - name: ğŸ”„ Trinity í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì™„ë£Œ
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.DEV_SERVER_HOST }}
        username: ${{ secrets.DEV_SERVER_USER }}
        key: ${{ secrets.DEV_SERVER_SSH_KEY }}
        port: 22
        timeout: 30s
        script: |
          # Trinity í”„ë¡ íŠ¸ì—”ë“œ ë””ë ‰í† ë¦¬ ìƒì„± ë° ê¶Œí•œ ì„¤ì •
          sudo mkdir -p /var/www/html-trinity
          sudo chown -R www-data:www-data /var/www/html-trinity
          sudo chmod -R 755 /var/www/html-trinity
          echo "âœ… Trinity í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì™„ë£Œ"

