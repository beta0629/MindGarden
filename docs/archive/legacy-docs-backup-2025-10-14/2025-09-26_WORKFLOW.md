# 2025-09-26 작업 워크플로우

## 🔄 전체 작업 흐름

### Phase 1: 문제 분석 및 진단
```
사용자 요청 → 문제 파악 → 원인 분석 → 해결 방안 수립
```

**주요 문제들:**
1. 본사 총관리자 대시보드 경로 오류 (`/hq/dashboard` → `/hq_master/dashboard`)
2. 지점 정보 중복 저장 (`common_codes` + `branches` 테이블)
3. 한글 인코딩 문제 (latin1 → utf8mb4)
4. 메뉴 구조 최적화 필요
5. 통계 대시보드 오류들

### Phase 2: 데이터 마이그레이션
```
기존 데이터 분석 → 마이그레이션 스크립트 작성 → 데이터 이전 → 검증
```

**지점 정보 마이그레이션:**
1. `common_codes` 테이블에서 지점 데이터 추출
2. `branches` 테이블로 데이터 이전
3. 기존 `common_codes`의 'BRANCH' 그룹 데이터 삭제
4. 외래키 참조 업데이트

### Phase 3: 백엔드 수정
```
컨트롤러 수정 → 서비스 로직 변경 → 설정 파일 업데이트 → 테스트
```

**수정된 컨트롤러들:**
- `AdminUserController.java`: 지점 조회 로직 변경
- `AuthController.java`: 로그인 시 지점 정보 처리
- `BranchController.java`: 지점 목록 조회 로직 변경
- `BranchManagementController.java`: 지점 관리 로직 변경
- `HQBranchController.java`: 본사 지점 관리 로직 변경
- `CommonCodeController.java`: 공통코드 API 추가
- `ScheduleController.java`: 통계 API 파라미터 추가

### Phase 4: 프론트엔드 수정
```
API 호출 수정 → 데이터 매핑 변경 → UI 개선 → 반응형 처리
```

**주요 변경사항:**
- `branch.code` → `branch.branchCode`
- `branch.name` → `branch.branchName`
- 메뉴 경로 패턴 추가 (`/hq_master/*`, `/hq/*`)
- 반응형 UI 개선 (한글 텍스트 줄바꿈 방지)

### Phase 5: 인코딩 문제 해결
```
MySQL 설정 → Spring Boot 설정 → 기존 데이터 수정 → 검증
```

**인코딩 설정:**
1. MySQL 서버 설정 파일 수정
2. Spring Boot `application.yml` 설정 수정
3. 기존 깨진 한글 데이터 수동 수정
4. 연결 테스트 및 검증

### Phase 6: 메뉴 구조 최적화
```
메뉴 분석 → 불필요한 메뉴 식별 → 비활성화 → UI 정리
```

**제거된 메뉴들:**
- 상담내역 (본사총관리자용 불필요)
- 상담리포트 (본사총관리자용 불필요)
- 중복된 사용자관리 메뉴
- 상담사기능 (본사총관리자용 불필요)
- 내담자기능 (본사총관리자용 불필요)

### Phase 7: 통계 대시보드 오류 수정
```
오류 분석 → API 엔드포인트 수정 → 프론트엔드 로직 수정 → 테스트
```

**수정된 오류들:**
- 공통코드 API 500 오류
- 필터 기능 작동 안함
- Chart.js prop type 경고
- 스케줄 API 500 오류
- 지점별 재무관리 페이지 오류

### Phase 8: 지점 등록 기능 구현
```
UI 설계 → 백엔드 API 구현 → 프론트엔드 폼 구현 → 카카오 API 통합
```

**새로운 기능:**
- 지점 등록 모달
- 클라이언트 사이드 유효성 검사
- 카카오 주소 API 통합
- 반응형 UI 개선

### Phase 9: 스케줄러 오류 수정
```
오류 로그 분석 → 엔티티 제약조건 확인 → 매핑 로직 수정 → 테스트
```

**스케줄러 오류:**
- `ConsultationMessage.messageType` 필드 길이 제한 (20자) 초과
- 긴 메시지 타입을 짧은 공통코드 값으로 매핑

### Phase 10: 문서화 및 커밋
```
작업 내용 정리 → 문서 업데이트 → Git 커밋 → 푸시
```

## 🛠️ 기술적 워크플로우

### 1. 데이터베이스 마이그레이션
```sql
-- 1. 기존 데이터 백업
CREATE TABLE branches_backup AS SELECT * FROM branches;

-- 2. common_codes에서 branches로 데이터 이전
INSERT INTO branches (branch_name, branch_code, ...) 
SELECT korean_name, code_value, ... FROM common_codes 
WHERE code_group = 'BRANCH';

-- 3. 기존 common_codes 데이터 삭제
UPDATE common_codes SET is_active = false WHERE code_group = 'BRANCH';
```

### 2. 백엔드 리팩토링
```java
// Before: commonCodeService 사용
List<CommonCode> branches = commonCodeService.getActiveCommonCodesByGroup("BRANCH");

// After: branchService 사용
List<BranchResponse> branches = branchService.getAllActiveBranches();
```

### 3. 프론트엔드 데이터 매핑
```javascript
// Before: CommonCode 구조
{ code: 'GANGNAM', name: '강남점' }

// After: Branch 구조
{ branchCode: 'GANGNAM', branchName: '강남점' }
```

### 4. 인코딩 설정
```yaml
# application.yml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/mind_garden?characterSetResults=UTF-8&connection-init-sql=SET NAMES utf8mb4 COLLATE utf8mb4_unicode_ci
```

```ini
# my.cnf
[mysqld]
character-set-server=utf8mb4
collation-server=utf8mb4_unicode_ci
init-connect='SET NAMES utf8mb4'

[mysql]
default-character-set=utf8mb4

[client]
default-character-set=utf8mb4
```

## 📊 작업 순서도

```
시작
  ↓
문제 분석
  ↓
데이터 마이그레이션
  ↓
백엔드 수정
  ↓
프론트엔드 수정
  ↓
인코딩 문제 해결
  ↓
메뉴 구조 최적화
  ↓
통계 대시보드 수정
  ↓
지점 등록 기능 구현
  ↓
스케줄러 오류 수정
  ↓
문서화 및 커밋
  ↓
완료
```

## 🔍 품질 보증 워크플로우

### 1. 코드 검토
- [ ] 백엔드 컨트롤러 로직 검토
- [ ] 프론트엔드 컴포넌트 검토
- [ ] 데이터베이스 스키마 검토
- [ ] API 엔드포인트 검토

### 2. 테스트
- [ ] 단위 테스트 실행
- [ ] 통합 테스트 실행
- [ ] 사용자 시나리오 테스트
- [ ] 성능 테스트

### 3. 검증
- [ ] 한글 인코딩 검증
- [ ] 메뉴 경로 검증
- [ ] API 응답 검증
- [ ] UI 반응성 검증

## 🚀 배포 워크플로우

### 1. 로컬 개발
```bash
# 백엔드 서버 실행
mvn spring-boot:run -Dspring-boot.run.profiles=local

# 프론트엔드 서버 실행
cd frontend && npm start
```

### 2. Git 워크플로우
```bash
# 변경사항 스테이징
git add .

# 커밋
git commit -m "fix: 본사 총관리자 대시보드 경로 수정 및 메뉴 정리"

# 푸시
git push origin main
```

### 3. 자동 배포
- GitHub Actions를 통한 자동 배포
- 백엔드: Maven 빌드 → JAR 파일 생성 → 서버 업로드 → systemd 서비스 재시작
- 프론트엔드: React 빌드 → 정적 파일 서버 업로드

## 📈 성과 측정

### 1. 정량적 지표
- 수정된 파일: 64개
- 추가된 라인: 8,295줄
- 삭제된 라인: 1,232줄
- 해결된 오류: 12개

### 2. 정성적 개선
- 사용자 경험 향상
- 코드 일관성 확보
- 시스템 안정성 개선
- 유지보수성 향상

## 🔄 지속적 개선

### 1. 모니터링
- 오류 로그 모니터링
- 성능 지표 추적
- 사용자 피드백 수집

### 2. 개선 계획
- 추가 메뉴 정리
- 성능 최적화
- 사용자 경험 개선
- 코드 품질 향상
