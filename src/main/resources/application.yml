# 통합 상담관리 시스템 설정 파일
# Spring Boot 3.x + Hibernate 6.x + MySQL 8.x

spring:
  profiles:
    active: local
  
  application:
    name: consultation-management-system
  
  # 데이터베이스 설정
  # 기본값: 개발서버 DB (beta0629.cafe24.com)
  # 로컬 DB 사용: 환경 변수 DB_HOST=localhost 설정
  # 운영서버 DB 사용: 환경 변수 DB_HOST=beta74.cafe24.com 설정
  datasource:
    url: jdbc:mysql://${DB_HOST:beta0629.cafe24.com}:${DB_PORT:3306}/${DB_NAME:mind_garden}?useSSL=false&serverTimezone=Asia/Seoul&characterEncoding=UTF-8&useUnicode=true&characterSetResults=UTF-8&allowPublicKeyRetrieval=true&rewriteBatchedStatements=true&useServerPrepStmts=true
    username: ${DB_USERNAME:mindgarden_dev}
    password: ${DB_PASSWORD:}  # 필수: 환경 변수로 설정 (예: export DB_PASSWORD="MindGardenDev2025!@#")
    driver-class-name: com.mysql.cj.jdbc.Driver
    # 문자셋 설정 추가
    connection-init-sql: "SET NAMES utf8mb4 COLLATE utf8mb4_unicode_ci"
    # HikariCP 연결 풀 설정 (안정적인 데이터베이스 연결)
    hikari:
      # 연결 풀 크기 설정
      minimum-idle: 5                    # 최소 유휴 연결 수
      maximum-pool-size: 20              # 최대 연결 풀 크기
      auto-commit: true                  # 자동 커밋
      # 연결 타임아웃 설정
      connection-timeout: 30000          # 연결 대기 타임아웃 (30초)
      validation-timeout: 5000           # 유효성 검사 타임아웃 (5초)
      idle-timeout: 600000               # 유휴 연결 타임아웃 (10분)
      max-lifetime: 1800000              # 연결 최대 수명 (30분)
      # 연결 유효성 검사
      connection-test-query: SELECT 1    # 연결 유효성 검사 쿼리
      # 연결 누수 감지
      leak-detection-threshold: 60000    # 연결 누수 감지 임계값 (60초)
      # 연결 풀 이름 (로그에서 식별 용이)
      pool-name: MindGardenHikariPool
      # 재시도 설정
      initialization-fail-timeout: 1     # 초기화 실패 시 즉시 실패 (1ms)
      # 연결 등록 정보
      register-mbeans: true              # JMX 모니터링 활성화
  
  # JPA 설정
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true  # SQL 로그 활성화
    # 데이터소스 연결 관리
    open-in-view: false  # OSIV 비활성화 (연결 누수 방지)
    properties:
      hibernate:
        dialect: org.hibernate.dialect.MySQL8Dialect
        format_sql: true
        use_sql_comments: true
        # 연결 관리 및 성능 최적화
        connection:
          provider_disables_autocommit: false
        # JDBC 배치 처리 및 성능 최적화
        jdbc:
          batch_size: 20
          batch_versioned_data: true
          fetch_size: 50  # 배치 페치 크기
        # 로그 레벨 분리 설정
        logging:
          level:
            org.hibernate.SQL: DEBUG          # SQL 쿼리만
            org.hibernate.type.descriptor.sql.BasicBinder: TRACE  # SQL 파라미터
            org.hibernate.engine.transaction.internal: DEBUG      # 트랜잭션
            org.hibernate.resource.transaction: DEBUG             # 트랜잭션 리소스
            org.hibernate.engine.jdbc.spi.SqlExceptionHelper: ERROR  # SQL 예외만
        # 스키마 업데이트 로깅
        hbm2ddl:
          auto: update
          import_files: false
    database-platform: org.hibernate.dialect.MySQL8Dialect
  
  # Thymeleaf 설정
  thymeleaf:
    cache: false
    mode: HTML
    encoding: UTF-8
    servlet:
      content-type: text/html
  
  # 보안 설정 (OAuth2 임시 비활성화)
  # security:
  #   oauth2:
  #     client:
  #       registration:
  #         kakao:
  #           client-id: ${KAKAO_CLIENT_ID:your-kakao-client-id}
  #           client-secret: ${KAKAO_CLIENT_SECRET:your-kakao-client-secret}
  #           redirect-uri: "{baseUrl}/login/oauth2/code/{registrationId}"
  #           client-authentication-method: post
  #           authorization-grant-type: authorization_code
  #           scope:
  #             - profile_nickname
  #             - account_email
  #           client-name: Kakao
  #         naver:
  #           client-id: ${NAVER_CLIENT_ID:your-naver-client-id}
  #           client-secret: ${NAVER_CLIENT_SECRET:your-naver-client-secret}
  #           redirect-uri: "{baseUrl}/login/oauth2/code/{registrationId}"
  #           client-authentication-method: post
  #           authorization-grant-type: authorization_code
  #           scope:
  #             - name
  #             - email
  #           client-name: Naver
  #         facebook:
  #           client-id: ${FACEBOOK_CLIENT_ID:your-facebook-client-id}
  #           client-secret: ${FACEBOOK_CLIENT_SECRET:your-facebook-client-secret}
  #           redirect-uri: "{baseUrl}/login/oauth2/code/{registrationId}"
  #           client-authentication-method: post
  #           authorization-grant-type: authorization_code
  #           scope:
  #             - name
  #             - email
  #           client-name: Facebook
  #         instagram:
  #           client-id: ${INSTAGRAM_CLIENT_ID:your-instagram-client-id}
  #           client-secret: ${INSTAGRAM_CLIENT_SECRET:your-instagram-client-secret}
  #           redirect-uri: "{baseUrl}/login/oauth2/code/{registrationId}"
  #           client-authentication-method: post
  #           authorization-grant-type: authorization_code
  #           scope:
  #             - basic
  #           client-name: Instagram

# JWT 설정
jwt:
  secret: ${JWT_SECRET:}
  expiration: 3600000   # 1시간 (밀리초)
  refresh-expiration: 604800000  # 7일 (밀리초)

# 개인정보 암호화 설정
encryption:
  personal-data:
    active-key-id: ${PERSONAL_DATA_ENCRYPTION_ACTIVE_KEY_ID:}
    key-versions: ${PERSONAL_DATA_ENCRYPTION_KEYS:}
    iv-versions: ${PERSONAL_DATA_ENCRYPTION_IVS:}
    key: ${PERSONAL_DATA_ENCRYPTION_KEY:}
    iv: ${PERSONAL_DATA_ENCRYPTION_IV:}
    algorithm: AES-256
    transformation: AES/CBC/PKCS5Padding

# 결제 시스템 설정
payment:
  toss:
    secret-key: ${PAYMENT_TOSS_SECRET_KEY:}
    base-url: ${PAYMENT_TOSS_BASE_URL:https://api.tosspayments.com}
    simulation-mode: ${PAYMENT_TOSS_SIMULATION_MODE:true}
    test-payment-url: ${PAYMENT_TOSS_TEST_URL:https://checkout.tosspayments.com/v1/test/}
    test-payment-key-prefix: ${PAYMENT_TOSS_TEST_KEY_PREFIX:toss_test_}
  iamport:
    api-key: ${PAYMENT_IAMPORT_API_KEY:}
    api-secret: ${PAYMENT_IAMPORT_API_SECRET:}
    base-url: ${PAYMENT_IAMPORT_BASE_URL:https://api.iamport.kr}
    simulation-mode: ${PAYMENT_IAMPORT_SIMULATION_MODE:true}

# 서버 설정
server:
  port: ${SERVER_PORT:8080}
  servlet:
    context-path: /
    encoding:
      charset: UTF-8
      force: true
    session:
      cookie:
        http-only: true
        secure: false  # 로컬 개발 환경에서는 false, 프로덕션에서는 true
        same-site: strict
        max-age: 3600  # 1시간
  compression:
    enabled: true
    mime-types: text/html,text/xml,text/plain,text/css,text/javascript,application/javascript,application/json
    min-response-size: 1024

# 로깅 설정
logging:
  level:
    # 애플리케이션 로그 (정상 로그 계속 남기기)
    com.mindgarden: INFO
    # Spring 관련 로그
    org.springframework.transaction: INFO
    org.springframework.orm.jpa: INFO
    # 데이터베이스 연결 로그
    com.zaxxer.hikari: INFO
    # SQL 관련 로그 (별도 파일로 분리)
    org.hibernate.SQL: INFO
    org.hibernate.type.descriptor.sql.BasicBinder: INFO
    org.hibernate.engine.transaction.internal: INFO
    org.hibernate.resource.transaction: INFO
    org.hibernate.engine.jdbc.spi.SqlExceptionHelper: ERROR
    # 기타 로그는 INFO 레벨로 (정상 로그 계속 남기기)
    root: INFO
  
  # 로그 파일 설정은 logback-spring.xml에서 관리
  # file:
  #   name: logs/mindgarden.log
  #   max-size: 100MB
  #   max-history: 30
  
  # 로그 패턴 설정은 logback-spring.xml에서 관리
  # pattern:
  #   console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
  #   file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
  
  # SQL/데이터베이스 오류 로그 별도 파일
  config: classpath:logback-spring.xml

# Actuator 설정
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: when-authorized
  prometheus:
    metrics:
      export:
        enabled: true

# 파일 업로드 설정
file:
  upload:
    max-size: 10MB
    allowed-types: jpg,jpeg,png,gif,pdf,doc,docx
    upload-dir: ./uploads

# 상담 시스템 설정
consultation:
  system:
    name: "통합 상담관리 시스템"
    version: "1.0.0"
    max-clients-per-consultant: 20
    session-timeout: 30
    notification:
      enabled: true
      real-time: true
    dashboard:
      max-components: 12
      default-layout: "grid"

# 프론트엔드 설정 (환경 변수 사용)
frontend:
  base-url: ${FRONTEND_BASE_URL:http://localhost:3000}

# SMS 인증 설정 (비용 절약을 위해 사용 여부 제어)
sms:
  auth:
    enabled: ${SMS_AUTH_ENABLED:false}  # 기본값: 비활성화 (비용 절약)
    provider: ${SMS_PROVIDER:nhn}  # nhn, twilio, aligo 등
    api-key: ${SMS_API_KEY:}
    api-secret: ${SMS_API_SECRET:}
    sender-number: ${SMS_SENDER_NUMBER:}
    test-mode: ${SMS_TEST_MODE:true}  # 테스트 모드 (실제 SMS 발송 안함)
    mock-verification-code: ${SMS_MOCK_CODE:123456}  # 테스트용 고정 인증번호

# OpenAI API 설정 (웰니스 컨텐츠 자동 생성)
openai:
  api:
    key: ${OPENAI_API_KEY:}  # 환경 변수로 설정 필수
    url: ${OPENAI_API_URL:https://api.openai.com/v1/chat/completions}
  model: ${OPENAI_MODEL:gpt-3.5-turbo}  # gpt-3.5-turbo 또는 gpt-4
