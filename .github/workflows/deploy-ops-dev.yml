name: ğŸ”§ Ops í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œ ì„œë²„ ë°°í¬

on:
  push:
    branches: [ develop ]
    paths:
      - 'frontend-ops/**'
      - '.github/workflows/deploy-ops-dev.yml'
  workflow_dispatch:
    # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  deploy-ops:
    name: ğŸ—ï¸ Ops í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ë° ë°°í¬
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Node.js 18 ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend-ops/package-lock.json
        
    - name: ğŸ“¦ Ops í”„ë¡ íŠ¸ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        cd frontend-ops
        npm ci
        
    - name: ğŸ—ï¸ Ops í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ
      run: |
        cd frontend-ops
        ESLINT_NO_DEV_ERRORS=true npm run build
        
    - name: ğŸ” Ops í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ê²°ê³¼ í™•ì¸
      run: |
        echo "ğŸ” Ops í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ê²°ê³¼ í™•ì¸..."
        if [ -d frontend-ops/out ]; then
          FILE_COUNT=$(find frontend-ops/out -type f 2>/dev/null | wc -l)
          if [ "$FILE_COUNT" -gt 0 ]; then
            echo "âœ… frontend-ops/out ë””ë ‰í† ë¦¬ ìƒì„±ë¨: $FILE_COUNT ê°œ íŒŒì¼"
          else
            echo "âŒ frontend-ops/out ë””ë ‰í† ë¦¬ê°€ ë¹„ì–´ìˆìŒ!"
            exit 1
          fi
        else
          echo "âŒ frontend-ops/out ë””ë ‰í† ë¦¬ ì—†ìŒ!"
          exit 1
        fi
        
    - name: ğŸ“¤ Ops í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ ì—…ë¡œë“œ SCP (ê°œë°œ ì„œë²„)
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.DEV_SERVER_HOST }}
        username: ${{ secrets.DEV_SERVER_USER }}
        key: ${{ secrets.DEV_SERVER_SSH_KEY }}
        port: 22
        timeout: 120s
        source: "frontend-ops/out/*"
        target: "/var/www/html-ops/"
        strip_components: 2
        overwrite: true
        
    - name: ğŸ”„ Ops í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì™„ë£Œ
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.DEV_SERVER_HOST }}
        username: ${{ secrets.DEV_SERVER_USER }}
        key: ${{ secrets.DEV_SERVER_SSH_KEY }}
        port: 22
        timeout: 30s
        script: |
          # Ops í”„ë¡ íŠ¸ì—”ë“œ ë””ë ‰í† ë¦¬ ìƒì„± ë° ê¶Œí•œ ì„¤ì •
          sudo mkdir -p /var/www/html-ops
          sudo chown -R www-data:www-data /var/www/html-ops
          sudo chmod -R 755 /var/www/html-ops
          echo "âœ… Ops í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì™„ë£Œ"

