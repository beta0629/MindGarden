# 토스페이먼츠 SDK 테스트 계획

**작성일**: 2025-11-20  
**버전**: 1.0.0  
**상태**: 계획 수립 완료  
**우선순위**: P0 (표준화 완료 후 즉시 진행)

---

## 📋 개요

토스페이먼츠 SDK v2 연동이 완료되었으므로, 실제 테스트 환경에서 전체 플로우를 검증해야 합니다.

**테스트 환경**:
- 테스트 키 사용 (`test_ck_...`, `test_sk_...`)
- 로컬 개발 환경
- 실제 토스페이먼츠 테스트 서버 연동

---

## ✅ 사전 준비 사항

### 1. 환경 변수 설정 확인
- [ ] 백엔드 `.env.local` 또는 환경 변수 설정
  - `PAYMENT_TOSS_SECRET_KEY=test_sk_ORzdMaqN3w59ZLadepPbr5AkYXQG`
  - `PAYMENT_TOSS_WEBHOOK_SECRET=09fb9726652b997b8b7f4fe44782cd08f8cda6bb8ed8af243ebe9248d967ba2c`
  - `PAYMENT_TOSS_SIMULATION_MODE=true`
- [ ] Trinity (Next.js) `.env.local` 설정
  - `NEXT_PUBLIC_TOSS_CLIENT_KEY=test_ck_jExPeJWYVQ56w5kKdmpqV49R5gvN`
  - `NEXT_PUBLIC_TOSS_TEST_MODE=true`
- [ ] 웹앱 (React) `.env.local` 설정
  - `REACT_APP_TOSS_CLIENT_KEY=test_ck_jExPeJWYVQ56w5kKdmpqV49R5gvN`
  - `REACT_APP_TOSS_TEST_MODE=true`

### 2. SDK 스크립트 로드 확인
- [ ] `frontend-trinity/app/layout.tsx`에 토스페이먼츠 SDK 스크립트 태그 확인
- [ ] `frontend/public/index.html`에 토스페이먼츠 SDK 스크립트 태그 확인

### 3. 공통 코드 등록 확인
- [ ] `SUBSCRIPTION_STATUS` 코드 그룹 등록 확인
- [ ] `BILLING_CYCLE` 코드 그룹 등록 확인
- [ ] `PG_PROVIDER` 코드 그룹 등록 확인

---

## 🧪 테스트 시나리오

### Phase 1: 기본 기능 테스트 (1일)

#### 1.1 Trinity 홈페이지 - 자동결제 등록 테스트
**목표**: 온보딩 페이지에서 결제 수단 등록이 정상 동작하는지 확인

**테스트 단계**:
1. [ ] Trinity 홈페이지 접속 (`http://localhost:3000`)
2. [ ] 온보딩 페이지 이동 (`/onboarding`)
3. [ ] 기본 정보 입력 (회사명, 업종, 연락처 등)
4. [ ] 요금제 선택
5. [ ] 결제 수단 등록 버튼 클릭
6. [ ] 토스페이먼츠 결제 창 표시 확인
7. [ ] 테스트 카드 정보 입력
   - 카드번호: `1234-5678-9012-3456`
   - 유효기간: `12/25`
   - CVC: `123`
   - 비밀번호: `123456`
8. [ ] 결제 완료 후 콜백 페이지 이동 확인
9. [ ] 성공 메시지 표시 확인
10. [ ] 백엔드 API 호출 확인 (빌링키 저장)

**예상 결과**:
- ✅ 토스페이먼츠 결제 창 정상 표시
- ✅ 결제 완료 후 콜백 페이지 정상 이동
- ✅ 빌링키가 백엔드에 정상 저장됨
- ✅ 온보딩 요청이 정상 생성됨

**에러 케이스 테스트**:
- [ ] 결제 취소 시 콜백 처리 확인
- [ ] 결제 실패 시 에러 메시지 표시 확인
- [ ] 네트워크 오류 시 처리 확인

---

#### 1.2 웹앱 - 자동결제 등록 테스트
**목표**: 웹앱에서 결제 수단 등록이 정상 동작하는지 확인

**테스트 단계**:
1. [ ] 웹앱 접속 (`http://localhost:3000`)
2. [ ] 결제 수단 등록 페이지 이동 (`/billing/payment-method`)
3. [ ] 결제 수단 등록 버튼 클릭
4. [ ] 토스페이먼츠 결제 창 표시 확인
5. [ ] 테스트 카드 정보 입력
6. [ ] 결제 완료 후 콜백 페이지 이동 확인
7. [ ] 성공 메시지 표시 확인
8. [ ] 백엔드 API 호출 확인

**예상 결과**:
- ✅ 토스페이먼츠 결제 창 정상 표시
- ✅ 결제 완료 후 콜백 페이지 정상 이동
- ✅ 빌링키가 백엔드에 정상 저장됨

---

#### 1.3 구독 관리 테스트
**목표**: 구독 생성, 조회, 취소가 정상 동작하는지 확인

**테스트 단계**:
1. [ ] 구독 목록 조회 (`GET /api/v1/billing/subscriptions`)
2. [ ] 구독 생성 (`POST /api/v1/billing/subscriptions`)
3. [ ] 구독 상세 조회 (`GET /api/v1/billing/subscriptions/{id}`)
4. [ ] 구독 취소 (`DELETE /api/v1/billing/subscriptions/{id}`)
5. [ ] 구독 상태 변경 확인

**예상 결과**:
- ✅ 구독 목록 정상 조회
- ✅ 구독 생성 정상 동작
- ✅ 구독 취소 정상 동작
- ✅ 구독 상태가 정상적으로 변경됨

---

### Phase 2: 통합 테스트 (1일)

#### 2.1 전체 플로우 테스트
**목표**: 온보딩부터 구독까지 전체 플로우 검증

**테스트 단계**:
1. [ ] Trinity 홈페이지에서 온보딩 요청 생성
2. [ ] 결제 수단 등록
3. [ ] Ops 포털에서 온보딩 승인
4. [ ] 테넌트 생성 확인
5. [ ] 구독 자동 생성 확인
6. [ ] 첫 결제 진행 확인
7. [ ] 구독 활성화 확인

**예상 결과**:
- ✅ 전체 플로우가 정상적으로 동작
- ✅ 각 단계에서 데이터 정합성 확인
- ✅ 에러 없이 완료

---

#### 2.2 에러 처리 테스트
**목표**: 다양한 에러 상황에서의 처리 확인

**테스트 케이스**:
- [ ] 결제 취소 시 처리
- [ ] 결제 실패 시 처리
- [ ] 네트워크 오류 시 처리
- [ ] 백엔드 API 오류 시 처리
- [ ] 타임아웃 처리

---

### Phase 3: 성능 및 안정성 테스트 (0.5일)

#### 3.1 동시성 테스트
- [ ] 여러 사용자가 동시에 결제 수단 등록 시도
- [ ] 동일 사용자가 여러 번 결제 수단 등록 시도

#### 3.2 부하 테스트
- [ ] 대량의 결제 요청 처리
- [ ] 대량의 구독 생성/취소 처리

---

## 📊 테스트 체크리스트

### 프론트엔드 테스트
- [ ] Trinity 홈페이지 결제 수단 등록
- [ ] 웹앱 결제 수단 등록
- [ ] 콜백 페이지 처리
- [ ] 에러 메시지 표시
- [ ] 로딩 상태 표시
- [ ] 공통 코드 동적 조회

### 백엔드 테스트
- [ ] 빌링키 저장 API
- [ ] 구독 생성 API
- [ ] 구독 조회 API
- [ ] 구독 취소 API
- [ ] 에러 처리
- [ ] 로깅 확인

### 통합 테스트
- [ ] 전체 플로우 검증
- [ ] 데이터 정합성 확인
- [ ] 트랜잭션 처리 확인

---

## 🐛 알려진 이슈 및 해결 방법

### 이슈 1: SDK 스크립트 로드 실패
**증상**: `window.TossPayments is not defined` 에러

**해결 방법**:
1. `index.html` 또는 `layout.tsx`에 스크립트 태그 확인
2. 스크립트 로드 순서 확인 (SDK 로드 후 컴포넌트 초기화)
3. 브라우저 콘솔에서 스크립트 로드 확인

### 이슈 2: 환경 변수 미적용
**증상**: 클라이언트 키가 `undefined`

**해결 방법**:
1. `.env.local` 파일 확인
2. 서버 재시작 (Next.js: `npm run dev`, React: `npm start`)
3. 환경 변수 접두사 확인 (`NEXT_PUBLIC_`, `REACT_APP_`)

### 이슈 3: 공통 코드 조회 실패
**증상**: 드롭다운이 비어있음

**해결 방법**:
1. 데이터베이스에 공통 코드 등록 확인
2. API 엔드포인트 확인 (`/api/v1/common-codes?codeGroup=...`)
3. 네트워크 탭에서 API 응답 확인

---

## 📝 테스트 결과 기록

### 테스트 일자: [ ]
### 테스트 환경: [ ]
### 테스트 담당자: [ ]

#### Phase 1 결과
- [ ] Trinity 홈페이지 테스트: [ ] 성공 / [ ] 실패
- [ ] 웹앱 테스트: [ ] 성공 / [ ] 실패
- [ ] 구독 관리 테스트: [ ] 성공 / [ ] 실패

**발견된 이슈**:
1. [이슈 내용]
2. [이슈 내용]

#### Phase 2 결과
- [ ] 전체 플로우 테스트: [ ] 성공 / [ ] 실패
- [ ] 에러 처리 테스트: [ ] 성공 / [ ] 실패

**발견된 이슈**:
1. [이슈 내용]
2. [이슈 내용]

#### Phase 3 결과
- [ ] 동시성 테스트: [ ] 성공 / [ ] 실패
- [ ] 부하 테스트: [ ] 성공 / [ ] 실패

**발견된 이슈**:
1. [이슈 내용]
2. [이슈 내용]

---

## 🎯 다음 단계

테스트 완료 후:
1. [ ] 발견된 이슈 수정
2. [ ] 재테스트
3. [ ] 대시보드 테스트 진행
4. [ ] 프로덕션 배포 준비 (운영 키 전환)

---

**마지막 업데이트**: 2025-11-20

