# 동적 역할 시스템

**작성일**: 2025-11-20  
**버전**: 1.0.0  
**상태**: 완료

---

## 📋 개요

CoreSolution은 **동적 역할 시스템**을 사용하여 입점사(테넌트)마다 다른 역할 구조를 지원합니다. 하드코딩된 역할이 아닌 데이터베이스 기반의 유연한 역할 관리 시스템입니다.

---

## 🏗️ 시스템 구조

### 핵심 엔티티

```
RoleTemplate (역할 템플릿)
  ├─ 업종별 기본 역할 템플릿 정의
  ├─ ACADEMY, CONSULTATION 등 업종별 템플릿
  └─ 권한 템플릿 포함

TenantRole (테넌트 역할)
  ├─ 테넌트별 커스텀 역할
  ├─ 템플릿 기반 복제 또는 커스텀 생성
  └─ 역할명, 설명 커스터마이징 가능

UserRoleAssignment (사용자 역할 할당)
  ├─ 사용자와 테넌트 역할 매핑
  ├─ 브랜치별 역할 할당 지원
  └─ 유효 기간 관리 (effective_from, effective_to)

RolePermission (역할 권한)
  ├─ 테넌트 역할에 부여된 권한
  ├─ ABAC 정책 (policy_json)
  └─ 권한 범위 (SELF, BRANCH, TENANT, ALL)
```

---

## 🔄 역할 생성 프로세스

### 1. 템플릿 기반 역할 생성

```
RoleTemplate (템플릿)
    ↓ 복제
TenantRole (테넌트 역할)
    ↓ 권한 복제
RolePermission (역할 권한)
```

**프로세스:**
1. 테넌트 온보딩 시 업종별 기본 역할 템플릿 조회
2. 템플릿을 기반으로 `TenantRole` 생성
3. 템플릿 권한을 `RolePermission`으로 복제
4. 테넌트 관리자가 역할명, 설명 커스터마이징 가능

### 2. 커스텀 역할 생성

```
TenantRole (커스텀 역할)
    ↓ 직접 생성
RolePermission (직접 권한 설정)
```

**프로세스:**
1. 테넌트 관리자가 새로운 역할 직접 생성
2. `role_template_id` 없이 `TenantRole` 생성
3. 권한을 직접 설정

---

## 📊 업종별 기본 역할 템플릿

### ACADEMY (학원)

| 템플릿 코드 | 역할명 | 설명 |
|-----------|--------|------|
| ACADEMY_DIRECTOR | 원장 | 학원 원장 역할 |
| ACADEMY_TEACHER | 교사 | 학원 교사 역할 |
| ACADEMY_STUDENT | 학생 | 학원 학생 역할 |
| ACADEMY_PARENT | 학부모 | 학원 학부모 역할 |
| ACADEMY_STAFF | 사무원 | 학원 사무원 역할 |

### CONSULTATION (상담소)

| 템플릿 코드 | 역할명 | 설명 |
|-----------|--------|------|
| CONSULTATION_DIRECTOR | 원장 | 상담소 원장 역할 |
| CONSULTATION_COUNSELOR | 상담사 | 상담소 상담사 역할 |
| CONSULTATION_CLIENT | 내담자 | 상담소 내담자 역할 |
| CONSULTATION_STAFF | 사무원 | 상담소 사무원 역할 |

**참고**: MindGarden은 CONSULTATION 업종의 예시입니다.

---

## 🔐 역할 할당 및 권한

### 사용자 역할 할당

```java
UserRoleAssignment
  ├─ user_id: 사용자 ID
  ├─ tenant_id: 테넌트 ID
  ├─ tenant_role_id: 테넌트 역할 ID
  ├─ branch_id: 브랜치 ID (NULL = 전체 브랜치)
  ├─ effective_from: 역할 시작일
  └─ effective_to: 역할 종료일 (NULL = 무기한)
```

**브랜치별 역할 할당:**
- `branch_id = NULL`: 전체 브랜치에 역할 할당
- `branch_id = 1`: 특정 브랜치에만 역할 할당

### 역할 권한

```java
RolePermission
  ├─ tenant_role_id: 테넌트 역할 ID
  ├─ permission_code: 권한 코드
  ├─ scope: 권한 범위 (SELF, BRANCH, TENANT, ALL)
  └─ policy_json: ABAC 정책 (JSON)
```

**권한 범위:**
- `SELF`: 자신의 데이터만 접근
- `BRANCH`: 브랜치 내 데이터 접근
- `TENANT`: 테넌트 전체 데이터 접근
- `ALL`: 모든 데이터 접근

---

## 🎯 입점사별 차이점

### 왜 입점사마다 다른 역할 구조를 가지는가?

1. **업종별 특성**
   - 학원: 학생, 선생님, 원장
   - 상담소: 내담자, 상담사, 원장
   - 기타: 각 업종마다 다른 역할 필요

2. **비즈니스 요구사항**
   - 입점사마다 조직 구조가 다름
   - 역할명, 권한이 다를 수 있음
   - 커스텀 역할 필요

3. **유연성**
   - 테넌트 관리자가 역할 커스터마이징 가능
   - 새로운 역할 추가/수정/삭제 가능
   - 권한 세밀하게 조정 가능

### 역할 커스터마이징 방법

1. **템플릿 기반 역할 수정**
   - 템플릿에서 복제한 역할도 수정 가능
   - 역할명, 설명 변경 가능
   - 권한 추가/수정 가능

2. **커스텀 역할 생성**
   - 템플릿 없이 새로운 역할 직접 생성
   - 역할명, 설명, 권한 직접 설정

3. **역할 삭제**
   - 필수 역할(레벨 1, 2)은 삭제 불가
   - 옵션 역할(레벨 3, 4)은 삭제 가능
   - 사용자가 할당된 역할은 삭제 불가

---

## 📝 역할 레벨 구조

### 레벨 1: 기본 사용자 (필수)
- 상담소: 내담자
- 학원: 학생
- 기타: 손님

### 레벨 2: 서비스 제공자 (필수)
- 상담소: 상담사
- 학원: 선생님
- 기타: 관리자

### 레벨 3: 관리자 (옵션)
- 상담소: 관리자
- 학원: 관리자
- 기타: 사장

### 레벨 4: 최고 관리자 (옵션)
- 상담소: 수퍼관리자
- 학원: 원장
- 기타: 원장

**구성 예시:**
- 최소 구성: 레벨 1 + 레벨 2 (2개 역할)
- 일반 구성: 레벨 1 + 레벨 2 + 레벨 3 (3개 역할)
- 최대 구성: 레벨 1 + 레벨 2 + 레벨 3 + 레벨 4 (4개 역할)

---

## 🔗 관련 문서

- [역할 템플릿 가이드](./ROLE_TEMPLATE_GUIDE.md)
- [업종별 역할 예시](./ROLE_EXAMPLES.md)
- [역할별 권한 매트릭스](./ROLE_PERMISSION_MATRIX.md)
- [업종별 역할 시스템 설계](../BUSINESS_CATEGORY_ROLE_SYSTEM.md)

---

**마지막 업데이트**: 2025-11-20

