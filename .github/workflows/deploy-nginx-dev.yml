name: ğŸŒ Nginx ì„¤ì • ê°œë°œ ì„œë²„ ë°°í¬

on:
  push:
    branches: [ develop ]
    paths:
      - 'config/nginx/**'
      - '.github/workflows/deploy-nginx-dev.yml'
  workflow_dispatch:
    # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  deploy-nginx:
    name: ğŸŒ Nginx ì„¤ì • ë°°í¬
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ“¤ Nginx ì„¤ì • íŒŒì¼ ì—…ë¡œë“œ (ê°œë°œ ì„œë²„ - í†µí•© ì„¤ì •)
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.DEV_SERVER_HOST }}
        username: ${{ secrets.DEV_SERVER_USER }}
        key: ${{ secrets.DEV_SERVER_SSH_KEY }}
        port: 22
        timeout: 120s
        source: "config/nginx/core-solution-dev.conf"
        target: "/tmp/core-solution-dev.conf"
        overwrite: true
        
    - name: ğŸ“¤ Nginx ì„¤ì • íŒŒì¼ ì—…ë¡œë“œ (ê°œë°œ ì„œë²„ - ê¸°ì¡´ ë„ë©”ì¸)
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.DEV_SERVER_HOST }}
        username: ${{ secrets.DEV_SERVER_USER }}
        key: ${{ secrets.DEV_SERVER_SSH_KEY }}
        port: 22
        timeout: 120s
        source: "config/nginx/dev.m-garden.co.kr.conf"
        target: "/tmp/dev.m-garden.co.kr.conf"
        overwrite: true
        
    - name: ğŸ”„ Nginx ì„¤ì • ì ìš© ë° ì¬ì‹œì‘
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.DEV_SERVER_HOST }}
        username: ${{ secrets.DEV_SERVER_USER }}
        key: ${{ secrets.DEV_SERVER_SSH_KEY }}
        port: 22
        timeout: 30s
        script: |
          echo "ğŸŒ Nginx ì„¤ì • ì—…ë°ì´íŠ¸ ì‹œì‘..."
          
          # Nginx ì„¤ì • ì—…ë°ì´íŠ¸ (í†µí•© ì„¤ì • íŒŒì¼ ìš°ì„ )
          if [ -f /tmp/core-solution-dev.conf ]; then
            echo "ğŸŒ Nginx í†µí•© ì„¤ì • ì—…ë°ì´íŠ¸ ì¤‘..."
            sudo cp /tmp/core-solution-dev.conf /etc/nginx/sites-available/core-solution-dev
            sudo ln -sf /etc/nginx/sites-available/core-solution-dev /etc/nginx/sites-enabled/core-solution-dev
            echo "âœ… í†µí•© ì„¤ì • íŒŒì¼ ì ìš© ì™„ë£Œ"
          fi
          
          # ê¸°ì¡´ ë„ë©”ì¸ ì„¤ì • ì—…ë°ì´íŠ¸ (í•˜ìœ„ í˜¸í™˜ì„±)
          if [ -f /tmp/dev.m-garden.co.kr.conf ]; then
            echo "ğŸŒ Nginx ê¸°ì¡´ ë„ë©”ì¸ ì„¤ì • ì—…ë°ì´íŠ¸ ì¤‘..."
            sudo cp /tmp/dev.m-garden.co.kr.conf /etc/nginx/sites-available/dev.m-garden.co.kr.conf
            sudo ln -sf /etc/nginx/sites-available/dev.m-garden.co.kr.conf /etc/nginx/sites-enabled/dev.m-garden.co.kr.conf
            echo "âœ… ê¸°ì¡´ ë„ë©”ì¸ ì„¤ì • íŒŒì¼ ì ìš© ì™„ë£Œ"
          fi
          
          # í”„ë¡ íŠ¸ì—”ë“œ ë””ë ‰í† ë¦¬ ê¶Œí•œ ì„¤ì •
          sudo mkdir -p /var/www/html-dev
          sudo chown -R www-data:www-data /var/www/html-dev
          sudo chmod -R 755 /var/www/html-dev
          
          # Trinity í”„ë¡ íŠ¸ì—”ë“œ ë””ë ‰í† ë¦¬ ìƒì„± ë° ê¶Œí•œ ì„¤ì •
          sudo mkdir -p /var/www/html-trinity
          sudo chown -R www-data:www-data /var/www/html-trinity
          sudo chmod -R 755 /var/www/html-trinity
          
          # Ops í”„ë¡ íŠ¸ì—”ë“œ ë””ë ‰í† ë¦¬ ìƒì„± ë° ê¶Œí•œ ì„¤ì •
          sudo mkdir -p /var/www/html-ops
          sudo chown -R www-data:www-data /var/www/html-ops
          sudo chmod -R 755 /var/www/html-ops
          
          # Nginx ì„¤ì • í…ŒìŠ¤íŠ¸
          if sudo nginx -t; then
            sudo systemctl reload nginx
            echo "âœ… Nginx ì„¤ì • ì—…ë°ì´íŠ¸ ì™„ë£Œ"
          else
            echo "âŒ Nginx ì„¤ì • ì˜¤ë¥˜ - ìˆ˜ë™ í™•ì¸ í•„ìš”"
            sudo nginx -t
            exit 1
          fi
          
    - name: âœ… Nginx ì„¤ì • ë°°í¬ ì™„ë£Œ
      run: |
        echo "âœ… Nginx ì„¤ì • ë°°í¬ ì™„ë£Œ"
        echo "ğŸŒ ì ìš©ëœ ë„ë©”ì¸:"
        echo "  - dev.core-solution.co.kr (CoreSolution)"
        echo "  - apply.dev.e-trinity.co.kr (Trinity ì˜¨ë³´ë”©)"
        echo "  - ops.dev.e-trinity.co.kr (Ops í¬í„¸)"

