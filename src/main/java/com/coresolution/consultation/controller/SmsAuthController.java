package com.coresolution.consultation.controller;

import java.util.HashMap;
import java.util.Map;
import com.coresolution.consultation.service.SmsAuthService;
import com.coresolution.core.controller.BaseApiController;
import com.coresolution.core.dto.ApiResponse;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

/**
 * SMS ì¸ì¦ ì»¨íŠ¸ë¡¤ëŸ¬
 * ë¹„ìš© ì ˆì•½ì„ ìœ„í•´ ì„¤ì • ê¸°ë°˜ìœ¼ë¡œ ë™ì‘ ì œì–´
 */
@Slf4j
@RestController
@RequestMapping({"/api/v1/auth/sms", "/api/sms-auth"}) // v1 ê²½ë¡œ ì¶”ê°€, ë ˆê±°ì‹œ ê²½ë¡œ ìœ ì§€
@RequiredArgsConstructor
public class SmsAuthController extends BaseApiController {
    
    private final SmsAuthService smsAuthService;
    
    /**
     * SMS ì¸ì¦ë²ˆí˜¸ ë°œì†¡
     * @param phoneNumber ì „í™”ë²ˆí˜¸
     * @return ë°œì†¡ ê²°ê³¼
     */
    @PostMapping("/send-code")
    public ResponseEntity<ApiResponse<Map<String, Object>>> sendVerificationCode(@RequestParam String phoneNumber) {
        log.info("ğŸ“± SMS ì¸ì¦ë²ˆí˜¸ ë°œì†¡ ìš”ì²­ - ì „í™”ë²ˆí˜¸: {}", phoneNumber);
        
        // ì „í™”ë²ˆí˜¸ í˜•ì‹ ê²€ì¦
        if (phoneNumber == null || phoneNumber.trim().isEmpty()) {
            throw new IllegalArgumentException("ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        }
        
        // SMS ì¸ì¦ë²ˆí˜¸ ë°œì†¡
        String verificationCode = smsAuthService.sendVerificationCode(phoneNumber);
        
        if (verificationCode == null) {
            throw new IllegalStateException("SMS ì¸ì¦ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.");
        }
        
        Map<String, Object> response = new HashMap<>();
        response.put("message", "ì¸ì¦ë²ˆí˜¸ê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
        
        // í…ŒìŠ¤íŠ¸ ëª¨ë“œì—ì„œëŠ” ì¸ì¦ë²ˆí˜¸ë„ í•¨ê»˜ ë°˜í™˜ (ê°œë°œ í¸ì˜ì„±)
        if (smsAuthService.isTestMode()) {
            response.put("verificationCode", verificationCode);
            response.put("testMode", true);
            log.info("ğŸ§ª í…ŒìŠ¤íŠ¸ ëª¨ë“œ: ì¸ì¦ë²ˆí˜¸ ë°˜í™˜ - {}", verificationCode);
        }
        
        return success("ì¸ì¦ë²ˆí˜¸ê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.", response);
    }
    
    /**
     * SMS ì¸ì¦ë²ˆí˜¸ ê²€ì¦
     * @param phoneNumber ì „í™”ë²ˆí˜¸
     * @param verificationCode ì¸ì¦ë²ˆí˜¸
     * @return ê²€ì¦ ê²°ê³¼
     */
    @PostMapping("/verify-code")
    public ResponseEntity<ApiResponse<Map<String, Object>>> verifyCode(
            @RequestParam String phoneNumber,
            @RequestParam String verificationCode,
            @RequestParam String sentCode) {
        
        log.info("ğŸ” SMS ì¸ì¦ë²ˆí˜¸ ê²€ì¦ ìš”ì²­ - ì „í™”ë²ˆí˜¸: {}, ì…ë ¥: {}", phoneNumber, verificationCode);
        
        // ì…ë ¥ê°’ ê²€ì¦
        if (phoneNumber == null || phoneNumber.trim().isEmpty()) {
            throw new IllegalArgumentException("ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        }
        
        if (verificationCode == null || verificationCode.trim().isEmpty()) {
            throw new IllegalArgumentException("ì¸ì¦ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        }
        
        if (sentCode == null || sentCode.trim().isEmpty()) {
            throw new IllegalArgumentException("ë°œì†¡ëœ ì¸ì¦ë²ˆí˜¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë°œì†¡í•´ì£¼ì„¸ìš”.");
        }
        
        // ì¸ì¦ë²ˆí˜¸ ê²€ì¦
        boolean isValid = smsAuthService.verifyCode(phoneNumber, verificationCode, sentCode);
        
        Map<String, Object> data = new HashMap<>();
        data.put("verified", isValid);
        
        if (isValid) {
            log.info("âœ… SMS ì¸ì¦ ì„±ê³µ - ì „í™”ë²ˆí˜¸: {}", phoneNumber);
            return success("ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", data);
        } else {
            log.warn("âŒ SMS ì¸ì¦ ì‹¤íŒ¨ - ì „í™”ë²ˆí˜¸: {}", phoneNumber);
            throw new IllegalArgumentException("ì¸ì¦ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        }
    }
    
    /**
     * SMS ì¸ì¦ ì„¤ì • ìƒíƒœ í™•ì¸
     * @return SMS ì¸ì¦ ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€
     */
    @GetMapping("/status")
    public ResponseEntity<ApiResponse<Map<String, Object>>> getSmsAuthStatus() {
        boolean enabled = smsAuthService.isSmsAuthEnabled();
        boolean testMode = smsAuthService.isTestMode();
        
        Map<String, Object> data = new HashMap<>();
        data.put("enabled", enabled);
        data.put("testMode", testMode);
        
        String message = enabled ? 
            (testMode ? "SMS ì¸ì¦ì´ í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤. (í…ŒìŠ¤íŠ¸ ëª¨ë“œ)" : "SMS ì¸ì¦ì´ í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤. (ì‹¤ì œ ëª¨ë“œ)") :
            "SMS ì¸ì¦ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤. (ë¹„ìš© ì ˆì•½ ëª¨ë“œ)";
        
        return success(message, data);
    }
}
