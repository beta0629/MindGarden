name: ğŸš€ Backend ê°œë°œ ì„œë²„ ë°°í¬

on:
  push:
    branches: [ develop ]
    paths:
      - 'src/**'
      - 'pom.xml'
      - '.github/workflows/deploy-backend-dev.yml'
  workflow_dispatch:
    # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  deploy-backend:
    name: ğŸ—ï¸ ë°±ì—”ë“œ ë¹Œë“œ ë° ë°°í¬
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: â˜• Java 17 ì„¤ì •
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ğŸ”§ Maven ìºì‹œ ì„¤ì •
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: ğŸ—ï¸ ë°±ì—”ë“œ ë¹Œë“œ
      run: |
        mvn clean package -DskipTests
        echo "ë¹Œë“œ ì™„ë£Œ. ê²°ê³¼ í™•ì¸:"
        ls -lh target/consultation-management-system-1.0.0.jar || echo "JAR íŒŒì¼ ì—†ìŒ!"
      
    - name: ğŸ” ë°±ì—”ë“œ ë¹Œë“œ ê²°ê³¼ í™•ì¸
      run: |
        echo "ğŸ” ë°±ì—”ë“œ ë¹Œë“œ ê²°ê³¼ í™•ì¸..."
        if [ -f target/consultation-management-system-1.0.0.jar ]; then
          ls -lh target/consultation-management-system-1.0.0.jar
          echo "âœ… JAR íŒŒì¼ ìƒì„±ë¨"
        else
          echo "âŒ JAR íŒŒì¼ ì—†ìŒ!"
          ls -la target/ 2>/dev/null || echo "target ë””ë ‰í† ë¦¬ ì—†ìŒ"
          exit 1
        fi
        
    - name: ğŸ” ê°œë°œ ì„œë²„ SSH ì—°ê²° í…ŒìŠ¤íŠ¸
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.DEV_SERVER_HOST }}
        username: ${{ secrets.DEV_SERVER_USER }}
        key: ${{ secrets.DEV_SERVER_SSH_KEY }}
        port: 22
        timeout: 30s
        script: |
          echo "SSH ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ: $(date)"
          
    - name: ğŸš€ ê°œë°œ ì„œë²„ ë°°í¬ ì¤€ë¹„
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.DEV_SERVER_HOST }}
        username: ${{ secrets.DEV_SERVER_USER }}
        key: ${{ secrets.DEV_SERVER_SSH_KEY }}
        port: 22
        timeout: 120s
        command_timeout: 30m
        script: |
          cd /var/www/mindgarden-dev
          
          # ì„œë¹„ìŠ¤ ì¤‘ì§€
          sudo systemctl stop mindgarden-dev.service || true
          
          # ë°±ì—… ìƒì„±
          if [ -f app.jar ]; then
            cp app.jar app.jar.backup.$(date +%Y%m%d_%H%M%S)
          fi
          
    - name: ğŸ“¤ ë°±ì—”ë“œ íŒŒì¼ ì—…ë¡œë“œ SCP (ê°œë°œ ì„œë²„)
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.DEV_SERVER_HOST }}
        username: ${{ secrets.DEV_SERVER_USER }}
        key: ${{ secrets.DEV_SERVER_SSH_KEY }}
        port: 22
        timeout: 120s
        source: "target/consultation-management-system-1.0.0.jar"
        target: "/var/www/mindgarden-dev/"
        strip_components: 1
        overwrite: true
        
    - name: ğŸ“¤ systemd ì„œë¹„ìŠ¤ íŒŒì¼ ì—…ë¡œë“œ (ê°œë°œ ì„œë²„)
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.DEV_SERVER_HOST }}
        username: ${{ secrets.DEV_SERVER_USER }}
        key: ${{ secrets.DEV_SERVER_SSH_KEY }}
        port: 22
        timeout: 120s
        source: "config/systemd/mindgarden-dev.service"
        target: "/tmp/mindgarden-dev.service"
        overwrite: true
        
    - name: ğŸ”„ ê°œë°œ ì„œë²„ ì„œë¹„ìŠ¤ ì¬ì‹œì‘
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.DEV_SERVER_HOST }}
        username: ${{ secrets.DEV_SERVER_USER }}
        key: ${{ secrets.DEV_SERVER_SSH_KEY }}
        port: 22
        timeout: 60s
        command_timeout: 5m
        script: |
          cd /var/www/mindgarden-dev
          
          # JAR íŒŒì¼ëª… ë³€ê²½
          if [ -f consultation-management-system-1.0.0.jar ]; then
            mv consultation-management-system-1.0.0.jar app.jar
          fi
          
          # ê¶Œí•œ ì„¤ì •
          chmod +x app.jar
          
          # ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
          echo "ğŸ“ ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì¤‘..."
          sudo mkdir -p /opt/mindgarden
          sudo bash -c 'echo "#!/bin/bash" > /opt/mindgarden/start.sh'
          sudo bash -c 'echo "set -e" >> /opt/mindgarden/start.sh'
          sudo bash -c 'echo "source /etc/mindgarden/dev.env" >> /opt/mindgarden/start.sh'
          sudo bash -c 'echo "export DB_PASSWORD" >> /opt/mindgarden/start.sh'
          sudo bash -c 'echo "export DB_USERNAME" >> /opt/mindgarden/start.sh'
          sudo bash -c 'echo "export DB_HOST" >> /opt/mindgarden/start.sh'
          sudo bash -c 'echo "export DB_NAME" >> /opt/mindgarden/start.sh'
          sudo bash -c 'echo "export DB_PORT" >> /opt/mindgarden/start.sh'
          sudo bash -c 'echo "export JWT_SECRET" >> /opt/mindgarden/start.sh'
          sudo bash -c 'echo "export PERSONAL_DATA_ENCRYPTION_KEY" >> /opt/mindgarden/start.sh'
          sudo bash -c 'echo "export PERSONAL_DATA_ENCRYPTION_IV" >> /opt/mindgarden/start.sh'
          sudo bash -c 'echo "cd /var/www/mindgarden-dev" >> /opt/mindgarden/start.sh'
          sudo bash -c 'echo "exec /usr/bin/java -jar app.jar --spring.profiles.active=dev" >> /opt/mindgarden/start.sh'
          sudo chmod +x /opt/mindgarden/start.sh
          echo "âœ… ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì™„ë£Œ"
          
          # systemd ì„œë¹„ìŠ¤ íŒŒì¼ ì„¤ì •
          echo "ğŸ“ systemd ì„œë¹„ìŠ¤ íŒŒì¼ ì„¤ì • ì¤‘..."
          if [ -f /tmp/mindgarden-dev.service ]; then
            sudo cp /tmp/mindgarden-dev.service /etc/systemd/system/mindgarden-dev.service
            sudo systemctl daemon-reload
            sudo systemctl enable mindgarden-dev.service
            echo "âœ… systemd ì„œë¹„ìŠ¤ íŒŒì¼ ì„¤ì • ì™„ë£Œ"
          else
            echo "âš ï¸ systemd ì„œë¹„ìŠ¤ íŒŒì¼ì´ ì—…ë¡œë“œë˜ì§€ ì•ŠìŒ - ê¸°ë³¸ ì„¤ì • ì‚¬ìš©"
            sudo bash -c 'echo "[Unit]" > /etc/systemd/system/mindgarden-dev.service'
            sudo bash -c 'echo "Description=MindGarden Development Server" >> /etc/systemd/system/mindgarden-dev.service'
            sudo bash -c 'echo "After=network.target mysql.service" >> /etc/systemd/system/mindgarden-dev.service'
            sudo bash -c 'echo "" >> /etc/systemd/system/mindgarden-dev.service'
            sudo bash -c 'echo "[Service]" >> /etc/systemd/system/mindgarden-dev.service'
            sudo bash -c 'echo "Type=simple" >> /etc/systemd/system/mindgarden-dev.service'
            sudo bash -c 'echo "User=root" >> /etc/systemd/system/mindgarden-dev.service'
            sudo bash -c 'echo "WorkingDirectory=/var/www/mindgarden-dev" >> /etc/systemd/system/mindgarden-dev.service'
            sudo bash -c 'echo "ExecStart=/opt/mindgarden/start.sh" >> /etc/systemd/system/mindgarden-dev.service'
            sudo bash -c 'echo "Restart=always" >> /etc/systemd/system/mindgarden-dev.service'
            sudo bash -c 'echo "RestartSec=10" >> /etc/systemd/system/mindgarden-dev.service'
            sudo bash -c 'echo "StandardOutput=journal" >> /etc/systemd/system/mindgarden-dev.service'
            sudo bash -c 'echo "StandardError=journal" >> /etc/systemd/system/mindgarden-dev.service'
            sudo bash -c 'echo "SyslogIdentifier=mindgarden-dev" >> /etc/systemd/system/mindgarden-dev.service'
            sudo bash -c 'echo "" >> /etc/systemd/system/mindgarden-dev.service'
            sudo bash -c 'echo "[Install]" >> /etc/systemd/system/mindgarden-dev.service'
            sudo bash -c 'echo "WantedBy=multi-user.target" >> /etc/systemd/system/mindgarden-dev.service'
            sudo systemctl daemon-reload
            sudo systemctl enable mindgarden-dev.service
            echo "âœ… ê¸°ë³¸ systemd ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„± ì™„ë£Œ"
          fi
          
          # ì„œë¹„ìŠ¤ ì¬ì‹œì‘
          echo "ğŸ”„ ê°œë°œ ì„œë²„ ì„œë¹„ìŠ¤ ì¬ì‹œì‘..."
          sudo systemctl daemon-reload
          sudo systemctl stop mindgarden-dev.service || true
          sleep 5
          sudo systemctl start mindgarden-dev.service
          sleep 15
          
          # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
          echo "ğŸ” ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸..."
          sudo systemctl status mindgarden-dev.service --no-pager | head -20
          
          if sudo systemctl is-active --quiet mindgarden-dev.service; then
            echo "âœ… ê°œë°œ ì„œë²„ ì„œë¹„ìŠ¤ ì •ìƒ ì‹œì‘ë¨"
          else
            echo "âŒ ì„œë¹„ìŠ¤ ì‹œì‘ ì‹¤íŒ¨ - ë¡œê·¸ í™•ì¸..."
            sudo journalctl -u mindgarden-dev.service --no-pager -n 100 || true
            exit 1
          fi
          
    - name: ğŸ¥ ê°œë°œ ì„œë²„ í—¬ìŠ¤ì²´í¬
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.DEV_SERVER_HOST }}
        username: ${{ secrets.DEV_SERVER_USER }}
        key: ${{ secrets.DEV_SERVER_SSH_KEY }}
        port: 22
        timeout: 30s
        script: |
          echo "ğŸ¥ ê°œë°œ ì„œë²„ í—¬ìŠ¤ì²´í¬ ì‹œì‘..."
          sleep 5
          
          for i in {1..3}; do
            if curl -f -s http://localhost:8080/actuator/health > /dev/null 2>&1; then
              echo "âœ… ê°œë°œ ì„œë²„ í—¬ìŠ¤ì²´í¬ ì„±ê³µ (ì‹œë„ $i)"
              curl -s http://localhost:8080/actuator/health | head -5
              exit 0
            else
              echo "â³ í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° ì¤‘... (ì‹œë„ $i/3)"
              sleep 10
            fi
          done
          
          echo "âš ï¸ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ - ì„œë¹„ìŠ¤ ë¡œê·¸ í™•ì¸ í•„ìš”"
          sudo journalctl -u mindgarden-dev.service --no-pager -n 50
          exit 1

