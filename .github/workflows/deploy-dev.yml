name: ğŸ§ª MindGarden ê°œë°œ ì„œë²„ ë°°í¬

on:
  push:
    branches: [ develop ]
    # develop ë¸Œëœì¹˜ì— pushí•˜ë©´ ìë™ìœ¼ë¡œ ê°œë°œ ì„œë²„ì— ë°°í¬
    # main ë¸Œëœì¹˜ëŠ” ìš´ì˜ ë°°í¬ìš©ì´ë¯€ë¡œ ê°œë°œ ë°°í¬ì—ì„œ ì œì™¸
  workflow_dispatch:
    # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  deploy:
    name: ğŸ—ï¸ ê°œë°œ ì„œë²„ ë¹Œë“œ ë° ë°°í¬
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: â˜• Java 17 ì„¤ì •
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ğŸ“¦ Node.js 18 ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: ğŸ”§ Maven ìºì‹œ ì„¤ì •
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: ğŸ—ï¸ ë°±ì—”ë“œ ë¹Œë“œ
      run: |
        mvn clean package -DskipTests
        echo "ë¹Œë“œ ì™„ë£Œ. ê²°ê³¼ í™•ì¸:"
        ls -lh target/consultation-management-system-1.0.0.jar || echo "JAR íŒŒì¼ ì—†ìŒ!"
      
    - name: ğŸ” ë°±ì—”ë“œ ë¹Œë“œ ê²°ê³¼ í™•ì¸
      run: |
        echo "ğŸ” ë°±ì—”ë“œ ë¹Œë“œ ê²°ê³¼ í™•ì¸..."
        if [ -f target/consultation-management-system-1.0.0.jar ]; then
          ls -lh target/consultation-management-system-1.0.0.jar
          echo "âœ… JAR íŒŒì¼ ìƒì„±ë¨"
        else
          echo "âŒ JAR íŒŒì¼ ì—†ìŒ!"
          ls -la target/ 2>/dev/null || echo "target ë””ë ‰í† ë¦¬ ì—†ìŒ"
          exit 1
        fi
        
    - name: ğŸ“¦ í”„ë¡ íŠ¸ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        cd frontend
        npm ci
        
    - name: ğŸ—ï¸ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ
      run: |
        cd frontend
        npm run build:ci
        
    - name: ğŸ” í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ê²°ê³¼ í™•ì¸
      run: |
        echo "ğŸ” í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ê²°ê³¼ í™•ì¸..."
        if [ -d frontend/build ]; then
          FILE_COUNT=$(find frontend/build -type f 2>/dev/null | wc -l)
          if [ "$FILE_COUNT" -gt 0 ]; then
            echo "âœ… frontend/build ë””ë ‰í† ë¦¬ ìƒì„±ë¨: $FILE_COUNT ê°œ íŒŒì¼"
          else
            echo "âŒ frontend/build ë””ë ‰í† ë¦¬ê°€ ë¹„ì–´ìˆìŒ!"
            exit 1
          fi
        else
          echo "âŒ frontend/build ë””ë ‰í† ë¦¬ ì—†ìŒ!"
          exit 1
        fi
        
    - name: ğŸ“¦ Trinity í”„ë¡ íŠ¸ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        cd frontend-trinity
        npm ci
        
    - name: ğŸ—ï¸ Trinity í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ
      run: |
        cd frontend-trinity
        ESLINT_NO_DEV_ERRORS=true npm run build
        
    - name: ğŸ” Trinity í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ê²°ê³¼ í™•ì¸
      run: |
        echo "ğŸ” Trinity í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ê²°ê³¼ í™•ì¸..."
        if [ -d frontend-trinity/out ]; then
          FILE_COUNT=$(find frontend-trinity/out -type f 2>/dev/null | wc -l)
          if [ "$FILE_COUNT" -gt 0 ]; then
            echo "âœ… frontend-trinity/out ë””ë ‰í† ë¦¬ ìƒì„±ë¨: $FILE_COUNT ê°œ íŒŒì¼"
          else
            echo "âŒ frontend-trinity/out ë””ë ‰í† ë¦¬ê°€ ë¹„ì–´ìˆìŒ!"
            exit 1
          fi
        else
          echo "âŒ frontend-trinity/out ë””ë ‰í† ë¦¬ ì—†ìŒ!"
          exit 1
        fi
        
    - name: ğŸ” ê°œë°œ ì„œë²„ SSH ì—°ê²° í…ŒìŠ¤íŠ¸
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.DEV_SERVER_HOST }}
        username: ${{ secrets.DEV_SERVER_USER }}
        key: ${{ secrets.DEV_SERVER_SSH_KEY }}
        port: 22
        timeout: 30s
        script: |
          echo "SSH ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ: $(date)"
          echo "ì„œë²„ ì •ë³´: $(uname -a)"
          
    - name: ğŸš€ ê°œë°œ ì„œë²„ ë°°í¬ ì¤€ë¹„
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.DEV_SERVER_HOST }}
        username: ${{ secrets.DEV_SERVER_USER }}
        key: ${{ secrets.DEV_SERVER_SSH_KEY }}
        port: 22
        timeout: 120s
        command_timeout: 30m
        script: |
          # ë°°í¬ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          cd /var/www/mindgarden-dev
          
          # ì„œë¹„ìŠ¤ ì¤‘ì§€
          sudo systemctl stop mindgarden-dev.service || true
          
          # ë°±ì—… ìƒì„±
          if [ -f app.jar ]; then
            cp app.jar app.jar.backup.$(date +%Y%m%d_%H%M%S)
          fi
          
          # í”„ë¡ íŠ¸ì—”ë“œ ë°±ì—…
          if [ -d frontend ]; then
            tar -czf frontend.backup.$(date +%Y%m%d_%H%M%S).tar.gz frontend/
          fi
          
    - name: ğŸ“¤ ë°±ì—”ë“œ íŒŒì¼ ì—…ë¡œë“œ (ê°œë°œ ì„œë²„)
      run: |
        echo "=========================================="
        echo "ğŸ” ë°±ì—”ë“œ íŒŒì¼ ì—…ë¡œë“œ ì‹œì‘"
        echo "íŒŒì¼ í™•ì¸:"
        ls -la target/consultation-management-system-1.0.0.jar || echo "âŒ íŒŒì¼ ì—†ìŒ!"
        echo "=========================================="
        
    - name: ğŸ“¤ ë°±ì—”ë“œ íŒŒì¼ ì—…ë¡œë“œ SCP (ê°œë°œ ì„œë²„)
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.DEV_SERVER_HOST }}
        username: ${{ secrets.DEV_SERVER_USER }}
        key: ${{ secrets.DEV_SERVER_SSH_KEY }}
        port: 22
        timeout: 120s
        source: "target/consultation-management-system-1.0.0.jar"
        target: "/var/www/mindgarden-dev/"
        strip_components: 1
        overwrite: true
        
    - name: ğŸ“¤ í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ ì—…ë¡œë“œ (ê°œë°œ ì„œë²„)
      run: |
        echo "=========================================="
        echo "ğŸ” í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ ì—…ë¡œë“œ ì‹œì‘"
        echo "ë””ë ‰í† ë¦¬ í™•ì¸:"
        ls -ld frontend/build || echo "âŒ ë””ë ‰í† ë¦¬ ì—†ìŒ!"
        echo "íŒŒì¼ ê°œìˆ˜: $(find frontend/build -type f 2>/dev/null | wc -l)"
        echo "=========================================="
        
    - name: ğŸ“¤ í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ ì—…ë¡œë“œ SCP (ê°œë°œ ì„œë²„)
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.DEV_SERVER_HOST }}
        username: ${{ secrets.DEV_SERVER_USER }}
        key: ${{ secrets.DEV_SERVER_SSH_KEY }}
        port: 22
        timeout: 120s
        source: "frontend/build/*"
        target: "/var/www/html-dev/"
        strip_components: 2
        overwrite: true
        
    - name: ğŸ“¤ Trinity í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ ì—…ë¡œë“œ (ê°œë°œ ì„œë²„)
      run: |
        echo "=========================================="
        echo "ğŸ” Trinity í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ ì—…ë¡œë“œ ì‹œì‘"
        echo "ë””ë ‰í† ë¦¬ í™•ì¸:"
        ls -ld frontend-trinity/out || echo "âŒ ë””ë ‰í† ë¦¬ ì—†ìŒ!"
        echo "íŒŒì¼ ê°œìˆ˜: $(find frontend-trinity/out -type f 2>/dev/null | wc -l)"
        echo "=========================================="
        
    - name: ğŸ“¤ Trinity í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ ì—…ë¡œë“œ SCP (ê°œë°œ ì„œë²„)
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.DEV_SERVER_HOST }}
        username: ${{ secrets.DEV_SERVER_USER }}
        key: ${{ secrets.DEV_SERVER_SSH_KEY }}
        port: 22
        timeout: 120s
        source: "frontend-trinity/out/*"
        target: "/var/www/html-trinity/"
        strip_components: 2
        overwrite: true
        
    - name: ğŸ“¤ ê°œë°œ ì„œë²„ í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ì—…ë¡œë“œ
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.DEV_SERVER_HOST }}
        username: ${{ secrets.DEV_SERVER_USER }}
        key: ${{ secrets.DEV_SERVER_SSH_KEY }}
        port: 22
        timeout: 120s
        source: "dev.env"
        target: "/tmp/dev.env"
        overwrite: true
        
    - name: ğŸ“¤ Nginx ì„¤ì • íŒŒì¼ ì—…ë¡œë“œ (ê°œë°œ ì„œë²„ - í†µí•© ì„¤ì •)
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.DEV_SERVER_HOST }}
        username: ${{ secrets.DEV_SERVER_USER }}
        key: ${{ secrets.DEV_SERVER_SSH_KEY }}
        port: 22
        timeout: 120s
        source: "config/nginx/core-solution-dev.conf"
        target: "/tmp/core-solution-dev.conf"
        overwrite: true
        
    - name: ğŸ“¤ Nginx ì„¤ì • íŒŒì¼ ì—…ë¡œë“œ (ê°œë°œ ì„œë²„ - ê¸°ì¡´ ë„ë©”ì¸)
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.DEV_SERVER_HOST }}
        username: ${{ secrets.DEV_SERVER_USER }}
        key: ${{ secrets.DEV_SERVER_SSH_KEY }}
        port: 22
        timeout: 120s
        source: "config/nginx/dev.m-garden.co.kr.conf"
        target: "/tmp/dev.m-garden.co.kr.conf"
        overwrite: true
        
    - name: ğŸ“¤ systemd ì„œë¹„ìŠ¤ íŒŒì¼ ì—…ë¡œë“œ (ê°œë°œ ì„œë²„)
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.DEV_SERVER_HOST }}
        username: ${{ secrets.DEV_SERVER_USER }}
        key: ${{ secrets.DEV_SERVER_SSH_KEY }}
        port: 22
        timeout: 120s
        source: "config/systemd/mindgarden-dev.service"
        target: "/tmp/mindgarden-dev.service"
        overwrite: true
        
    - name: ğŸ”„ ê°œë°œ ì„œë²„ ì„œë¹„ìŠ¤ ì¬ì‹œì‘
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.DEV_SERVER_HOST }}
        username: ${{ secrets.DEV_SERVER_USER }}
        key: ${{ secrets.DEV_SERVER_SSH_KEY }}
        port: 22
        timeout: 60s
        command_timeout: 5m
        script: |
          cd /var/www/mindgarden-dev
          
          # JAR íŒŒì¼ëª… ë³€ê²½ (ìš´ì˜ê³¼ ë™ì¼)
          if [ -f consultation-management-system-1.0.0.jar ]; then
            mv consultation-management-system-1.0.0.jar app.jar
          fi
          
          # ê¶Œí•œ ì„¤ì •
          chmod +x app.jar
          
          # ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± (í•­ìƒ ì—…ë°ì´íŠ¸)
          echo "ğŸ“ ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì¤‘..."
          sudo mkdir -p /opt/mindgarden
          sudo bash -c 'echo "#!/bin/bash" > /opt/mindgarden/start.sh'
          sudo bash -c 'echo "set -e" >> /opt/mindgarden/start.sh'
          sudo bash -c 'echo "source /etc/mindgarden/dev.env" >> /opt/mindgarden/start.sh'
          sudo bash -c 'echo "export DB_PASSWORD" >> /opt/mindgarden/start.sh'
          sudo bash -c 'echo "export DB_USERNAME" >> /opt/mindgarden/start.sh'
          sudo bash -c 'echo "export DB_HOST" >> /opt/mindgarden/start.sh'
          sudo bash -c 'echo "export DB_NAME" >> /opt/mindgarden/start.sh'
          sudo bash -c 'echo "export DB_PORT" >> /opt/mindgarden/start.sh'
          sudo bash -c 'echo "export JWT_SECRET" >> /opt/mindgarden/start.sh'
          sudo bash -c 'echo "export PERSONAL_DATA_ENCRYPTION_KEY" >> /opt/mindgarden/start.sh'
          sudo bash -c 'echo "export PERSONAL_DATA_ENCRYPTION_IV" >> /opt/mindgarden/start.sh'
          sudo bash -c 'echo "cd /var/www/mindgarden-dev" >> /opt/mindgarden/start.sh'
          sudo bash -c 'echo "exec /usr/bin/java -jar app.jar --spring.profiles.active=dev" >> /opt/mindgarden/start.sh'
          sudo chmod +x /opt/mindgarden/start.sh
          echo "âœ… ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì™„ë£Œ"
          
          # systemd ì„œë¹„ìŠ¤ íŒŒì¼ ì„¤ì • (í•­ìƒ ì—…ë°ì´íŠ¸)
          echo "ğŸ“ systemd ì„œë¹„ìŠ¤ íŒŒì¼ ì„¤ì • ì¤‘..."
          if [ -f /tmp/mindgarden-dev.service ]; then
            sudo cp /tmp/mindgarden-dev.service /etc/systemd/system/mindgarden-dev.service
            sudo systemctl daemon-reload
            sudo systemctl enable mindgarden-dev.service
            echo "âœ… systemd ì„œë¹„ìŠ¤ íŒŒì¼ ì„¤ì • ì™„ë£Œ"
          elif [ -f /tmp/config/systemd/mindgarden-dev.service ]; then
            sudo cp /tmp/config/systemd/mindgarden-dev.service /etc/systemd/system/mindgarden-dev.service
            sudo systemctl daemon-reload
            sudo systemctl enable mindgarden-dev.service
            echo "âœ… systemd ì„œë¹„ìŠ¤ íŒŒì¼ ì„¤ì • ì™„ë£Œ"
          else
            echo "âš ï¸ systemd ì„œë¹„ìŠ¤ íŒŒì¼ì´ ì—…ë¡œë“œë˜ì§€ ì•ŠìŒ - ê¸°ë³¸ ì„¤ì • ì‚¬ìš©"
            # ê¸°ë³¸ ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„±
            sudo bash -c 'echo "[Unit]" > /etc/systemd/system/mindgarden-dev.service'
            sudo bash -c 'echo "Description=MindGarden Development Server" >> /etc/systemd/system/mindgarden-dev.service'
            sudo bash -c 'echo "After=network.target mysql.service" >> /etc/systemd/system/mindgarden-dev.service'
            sudo bash -c 'echo "" >> /etc/systemd/system/mindgarden-dev.service'
            sudo bash -c 'echo "[Service]" >> /etc/systemd/system/mindgarden-dev.service'
            sudo bash -c 'echo "Type=simple" >> /etc/systemd/system/mindgarden-dev.service'
            sudo bash -c 'echo "User=root" >> /etc/systemd/system/mindgarden-dev.service'
            sudo bash -c 'echo "WorkingDirectory=/var/www/mindgarden-dev" >> /etc/systemd/system/mindgarden-dev.service'
            sudo bash -c 'echo "ExecStart=/opt/mindgarden/start.sh" >> /etc/systemd/system/mindgarden-dev.service'
            sudo bash -c 'echo "Restart=always" >> /etc/systemd/system/mindgarden-dev.service'
            sudo bash -c 'echo "RestartSec=10" >> /etc/systemd/system/mindgarden-dev.service'
            sudo bash -c 'echo "StandardOutput=journal" >> /etc/systemd/system/mindgarden-dev.service'
            sudo bash -c 'echo "StandardError=journal" >> /etc/systemd/system/mindgarden-dev.service'
            sudo bash -c 'echo "SyslogIdentifier=mindgarden-dev" >> /etc/systemd/system/mindgarden-dev.service'
            sudo bash -c 'echo "" >> /etc/systemd/system/mindgarden-dev.service'
            sudo bash -c 'echo "[Install]" >> /etc/systemd/system/mindgarden-dev.service'
            sudo bash -c 'echo "WantedBy=multi-user.target" >> /etc/systemd/system/mindgarden-dev.service'
            sudo systemctl daemon-reload
            sudo systemctl enable mindgarden-dev.service
            echo "âœ… ê¸°ë³¸ systemd ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„± ì™„ë£Œ"
          fi
          
          # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ì—…ë°ì´íŠ¸ (ì—…ë¡œë“œëœ ê²½ìš°)
          if [ -f /tmp/dev.env ]; then
            echo "ğŸ“ í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ì—…ë°ì´íŠ¸ ì¤‘..."
            sudo mkdir -p /etc/mindgarden
            sudo cp /tmp/dev.env /etc/mindgarden/dev.env
            sudo chmod 600 /etc/mindgarden/dev.env
            echo "âœ… í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ì—…ë°ì´íŠ¸ ì™„ë£Œ"
          elif [ ! -f /etc/mindgarden/dev.env ]; then
            echo "âš ï¸ í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤: /etc/mindgarden/dev.env"
            echo "âš ï¸ ìˆ˜ë™ìœ¼ë¡œ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤"
          else
            echo "âœ… í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ì¡´ì¬ í™•ì¸ (ì—…ë°ì´íŠ¸ ì—†ìŒ)"
          fi
          
          # ì„œë¹„ìŠ¤ ì¬ì‹œì‘
          echo "ğŸ”„ ê°œë°œ ì„œë²„ ì„œë¹„ìŠ¤ ì¬ì‹œì‘..."
          sudo systemctl daemon-reload
          sudo systemctl stop mindgarden-dev.service || true
          sleep 5
          sudo systemctl start mindgarden-dev.service
          sleep 15
          
          # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
          echo "ğŸ” ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸..."
          sudo systemctl status mindgarden-dev.service --no-pager | head -20
          
          # ì„œë¹„ìŠ¤ í™œì„±í™” ìƒíƒœ í™•ì¸
          if sudo systemctl is-active --quiet mindgarden-dev.service; then
            echo "âœ… ê°œë°œ ì„œë²„ ì„œë¹„ìŠ¤ ì •ìƒ ì‹œì‘ë¨"
          else
            echo "âŒ ì„œë¹„ìŠ¤ ì‹œì‘ ì‹¤íŒ¨ - ë¡œê·¸ í™•ì¸..."
            echo "=========================================="
            echo "ğŸ“‹ ìµœê·¼ ì„œë¹„ìŠ¤ ë¡œê·¸ (ìµœê·¼ 100ì¤„):"
            echo "=========================================="
            sudo journalctl -u mindgarden-dev.service --no-pager -n 100 || true
            echo "=========================================="
            echo "ğŸ“‹ ì• í”Œë¦¬ì¼€ì´ì…˜ ì—ëŸ¬ ë¡œê·¸:"
            echo "=========================================="
            sudo tail -100 /var/log/mindgarden/dev-error.log 2>/dev/null || echo "ì—ëŸ¬ ë¡œê·¸ íŒŒì¼ ì—†ìŒ"
            echo "=========================================="
            echo "ğŸ“‹ JAR íŒŒì¼ í™•ì¸:"
            echo "=========================================="
            ls -lh /var/www/mindgarden-dev/app.jar || echo "JAR íŒŒì¼ ì—†ìŒ!"
            echo "=========================================="
            echo "ğŸ“‹ í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ í™•ì¸:"
            echo "=========================================="
            sudo test -f /etc/mindgarden/dev.env && echo "í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ì¡´ì¬" || echo "í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ì—†ìŒ!"
            echo "=========================================="
            echo "âŒ ì„œë¹„ìŠ¤ ì‹œì‘ ì‹¤íŒ¨ - ì¬ì‹œë„..."
            sudo systemctl restart mindgarden-dev.service
            sleep 15
            sudo systemctl status mindgarden-dev.service --no-pager | head -20
            echo "=========================================="
            echo "ğŸ“‹ ì¬ì‹œì‘ í›„ ë¡œê·¸:"
            echo "=========================================="
            sudo journalctl -u mindgarden-dev.service --no-pager -n 50 || true
            exit 1
          fi
          
          # Nginx ì„¤ì • ì—…ë°ì´íŠ¸ (í†µí•© ì„¤ì • íŒŒì¼ ìš°ì„ )
          if [ -f /tmp/core-solution-dev.conf ]; then
            echo "ğŸŒ Nginx í†µí•© ì„¤ì • ì—…ë°ì´íŠ¸ ì¤‘..."
            sudo cp /tmp/core-solution-dev.conf /etc/nginx/sites-available/core-solution-dev
            sudo ln -sf /etc/nginx/sites-available/core-solution-dev /etc/nginx/sites-enabled/core-solution-dev
            echo "âœ… í†µí•© ì„¤ì • íŒŒì¼ ì ìš© ì™„ë£Œ"
          fi
          
          # ê¸°ì¡´ ë„ë©”ì¸ ì„¤ì • ì—…ë°ì´íŠ¸ (í•˜ìœ„ í˜¸í™˜ì„±)
          if [ -f /tmp/dev.m-garden.co.kr.conf ]; then
            echo "ğŸŒ Nginx ê¸°ì¡´ ë„ë©”ì¸ ì„¤ì • ì—…ë°ì´íŠ¸ ì¤‘..."
            sudo cp /tmp/dev.m-garden.co.kr.conf /etc/nginx/sites-available/dev.m-garden.co.kr.conf
            sudo ln -sf /etc/nginx/sites-available/dev.m-garden.co.kr.conf /etc/nginx/sites-enabled/dev.m-garden.co.kr.conf
            echo "âœ… ê¸°ì¡´ ë„ë©”ì¸ ì„¤ì • íŒŒì¼ ì ìš© ì™„ë£Œ"
          fi
          
          # í”„ë¡ íŠ¸ì—”ë“œ ë””ë ‰í† ë¦¬ ê¶Œí•œ ì„¤ì •
          sudo chown -R www-data:www-data /var/www/html-dev
          sudo chmod -R 755 /var/www/html-dev
          
          # Trinity í”„ë¡ íŠ¸ì—”ë“œ ë””ë ‰í† ë¦¬ ìƒì„± ë° ê¶Œí•œ ì„¤ì •
          sudo mkdir -p /var/www/html-trinity
          sudo chown -R www-data:www-data /var/www/html-trinity
          sudo chmod -R 755 /var/www/html-trinity
          
          # Nginx ì„¤ì • í…ŒìŠ¤íŠ¸
          if sudo nginx -t; then
            sudo systemctl reload nginx
            echo "âœ… Nginx ì„¤ì • ì—…ë°ì´íŠ¸ ì™„ë£Œ"
          else
            echo "âš ï¸ Nginx ì„¤ì • ì˜¤ë¥˜ - ìˆ˜ë™ í™•ì¸ í•„ìš”"
            sudo nginx -t
          fi
          
    - name: ğŸ¥ ê°œë°œ ì„œë²„ í—¬ìŠ¤ì²´í¬
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.DEV_SERVER_HOST }}
        username: ${{ secrets.DEV_SERVER_USER }}
        key: ${{ secrets.DEV_SERVER_SSH_KEY }}
        port: 22
        timeout: 30s
        script: |
          echo "ğŸ¥ ê°œë°œ ì„œë²„ í—¬ìŠ¤ì²´í¬ ì‹œì‘..."
          sleep 5
          
          # Health Check (ìµœëŒ€ 3íšŒ ì¬ì‹œë„)
          for i in {1..3}; do
            if curl -f -s http://localhost:8080/actuator/health > /dev/null 2>&1; then
              echo "âœ… ê°œë°œ ì„œë²„ í—¬ìŠ¤ì²´í¬ ì„±ê³µ (ì‹œë„ $i)"
              curl -s http://localhost:8080/actuator/health | head -5
              exit 0
            else
              echo "â³ í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° ì¤‘... (ì‹œë„ $i/3)"
              sleep 10
            fi
          done
          
          echo "âš ï¸ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ - ì„œë¹„ìŠ¤ ë¡œê·¸ í™•ì¸ í•„ìš”"
          sudo journalctl -u mindgarden-dev.service --no-pager -n 50
          exit 1

