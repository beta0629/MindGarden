import { Linking, Platform } from 'react-native';
import AsyncStorage from '@react-native-async-storage/async-storage';
import { apiGet, apiPost } from '../api/client';
import { AUTH_API } from '../api/endpoints';
import { STRINGS } from '../constants/strings';
import { login as kakaoSDKLogin, getProfile as getKakaoProfile, logout as kakaoSDKLogout, unlink as kakaoSDKUnlink } from '@react-native-seoul/kakao-login';
import NaverLogin from '@react-native-seoul/naver-login';
import { getNaverLoginConfig } from '../config/environments';

/**
 * ë„¤ì´ë²„ SDK ì´ˆê¸°í™” (ì•± ì‹œì‘ ì‹œ í•œ ë²ˆë§Œ í˜¸ì¶œ)
 * iOSì™€ Android ëª¨ë‘ ì§€ì›
 */
let naverSDKInitialized = false;
export const initializeNaverSDK = async () => {
  if (naverSDKInitialized) {
    return;
  }
  
  try {
    const naverConfig = getNaverLoginConfig();
    
    // ë„¤ì´ë²„ SDK ì´ˆê¸°í™” (iOSì™€ Android ëª¨ë‘ ì§€ì›)
    const initConfig = {
      appName: naverConfig.APP_NAME,
      consumerKey: naverConfig.CLIENT_ID,
      consumerSecret: naverConfig.CLIENT_SECRET,
    };
    
    // iOSë§Œ serviceUrlSchemeIOS í•„ìš”
    if (Platform.OS === 'ios') {
      initConfig.serviceUrlSchemeIOS = 'naverMindGardenMobileApp'; // Info.plistì˜ URL Schemeê³¼ ì¼ì¹˜í•´ì•¼ í•¨
    }
    
    NaverLogin.initialize(initConfig);
    
    naverSDKInitialized = true;
    const platform = Platform.OS === 'ios' ? 'ğŸ iOS' : 'ğŸ¤– Android';
    console.log(`âœ… ë„¤ì´ë²„ SDK ì´ˆê¸°í™” ì™„ë£Œ (${platform})`);
  } catch (error) {
    console.error('âŒ ë„¤ì´ë²„ SDK ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
    throw error;
  }
};

/**
 * ëœë¤ state ìƒì„± (ì›¹ê³¼ ë™ì¼)
 */
const generateRandomState = (length = 32) => {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let result = '';
  for (let i = 0; i < length; i++) {
    result += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return result;
};

/**
 * ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ (ë„¤ì´í‹°ë¸Œ SDK ì‚¬ìš© - iOS/Android ëª¨ë‘ ì§€ì›)
 */
export const kakaoLogin = async () => {
  try {
    const platform = Platform.OS === 'ios' ? 'ğŸ iOS' : 'ğŸ¤– Android';
    console.log(`${platform} - ğŸ”µ ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì‹œì‘ (ë„¤ì´í‹°ë¸Œ SDK)`);
    
    // ì¹´ì¹´ì˜¤ SDKë¡œ ë¡œê·¸ì¸
    const token = await kakaoSDKLogin();
    console.log(`${platform} - âœ… ì¹´ì¹´ì˜¤ SDK ë¡œê·¸ì¸ ì„±ê³µ:`, token);
    
    // ì¹´ì¹´ì˜¤ í”„ë¡œí•„ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const profile = await getKakaoProfile();
    console.log(`${platform} - âœ… ì¹´ì¹´ì˜¤ í”„ë¡œí•„ ì •ë³´:`, profile);
    
    // ë°±ì—”ë“œë¡œ ë¡œê·¸ì¸ ì •ë³´ ì „ì†¡
    const response = await apiPost(AUTH_API.SOCIAL_LOGIN, {
      provider: 'KAKAO',
      accessToken: token.accessToken,
      userId: profile.id,
      email: profile.email,
      nickname: profile.nickname,
      profileImage: profile.profileImageUrl,
    });
    
    if (response?.success && response?.user) {
      // ì‚¬ìš©ì ì •ë³´ ì €ì¥
      await AsyncStorage.setItem('user', JSON.stringify(response.user));
      
      // ì„¸ì…˜ ID ì €ì¥ (ì‘ë‹µ ì¸í„°ì…‰í„°ì—ì„œ ì´ë¯¸ ì €ì¥í–ˆì„ ìˆ˜ ìˆì§€ë§Œ, ëª…ì‹œì ìœ¼ë¡œ ë‹¤ì‹œ ì €ì¥)
      const sessionId = response.sessionId;
      if (sessionId) {
        await AsyncStorage.setItem('sessionId', sessionId);
        
        // iOS ë””ë²„ê¹…: ì„¸ì…˜ ì €ì¥ í™•ì¸
        if (Platform.OS === 'ios') {
          const savedSessionId = await AsyncStorage.getItem('sessionId');
          console.log(`${platform} - âœ… ì¹´ì¹´ì˜¤ ì„¸ì…˜ ID ì €ì¥ ì™„ë£Œ:`, savedSessionId ? `${savedSessionId.substring(0, 10)}... (ê¸¸ì´: ${savedSessionId.length})` : 'ì €ì¥ ì‹¤íŒ¨');
          console.log(`${platform} - ğŸ“Š ì‘ë‹µì—ì„œ ë°›ì€ sessionId:`, sessionId ? `${sessionId.substring(0, 10)}... (ê¸¸ì´: ${sessionId.length})` : 'ì—†ìŒ');
          console.log(`${platform} - ğŸ“Š AsyncStorageì— ì €ì¥ëœ sessionId:`, savedSessionId ? `${savedSessionId.substring(0, 10)}... (ê¸¸ì´: ${savedSessionId.length})` : 'ì—†ìŒ');
        }
      } else {
        // iOS ë””ë²„ê¹…: ì„¸ì…˜ IDê°€ ì—†ìŒ
        if (Platform.OS === 'ios') {
          console.warn(`${platform} - âš ï¸ ì¹´ì¹´ì˜¤ ì‘ë‹µì— sessionIdê°€ ì—†ìŠµë‹ˆë‹¤! response:`, JSON.stringify(response, null, 2));
        }
      }
      
      return {
        success: true,
        user: response.user,
        accessToken: response.accessToken,
        refreshToken: response.refreshToken,
      };
    } else if (response?.requiresSignup) {
      return {
        success: false,
        requiresSignup: true,
        socialUserInfo: {
          email: profile.email || profile.email,
          nickname: profile.nickname || '',
          provider: 'KAKAO',
          socialId: profile.id.toString(),
        },
      };
    } else {
      throw new Error(response?.message || 'ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  } catch (error) {
    console.error('âŒ ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
    
    let errorMessage = STRINGS.AUTH.SOCIAL_LOGIN_ERROR;
    if (error.message) {
      errorMessage = error.message;
    }
    
    return {
      success: false,
      message: errorMessage,
    };
  }
};

/**
 * ë„¤ì´ë²„ ë¡œê·¸ì¸ (ë„¤ì´í‹°ë¸Œ SDK ì‚¬ìš© - iOS/Android ëª¨ë‘ ì§€ì›)
 */
export const naverLogin = async () => {
  try {
    const platform = Platform.OS === 'ios' ? 'ğŸ iOS' : 'ğŸ¤– Android';
    console.log(`${platform} - ğŸŸ¢ ë„¤ì´ë²„ ë¡œê·¸ì¸ ì‹œì‘ (ë„¤ì´í‹°ë¸Œ SDK)`);
    
    // ë„¤ì´ë²„ SDK ì´ˆê¸°í™” (ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìœ¼ë©´)
    await initializeNaverSDK();
    
    // ë„¤ì´ë²„ SDKë¡œ ë¡œê·¸ì¸
    const loginResult = await NaverLogin.login();
    console.log(`${platform} - âœ… ë„¤ì´ë²„ SDK ë¡œê·¸ì¸ ì„±ê³µ:`, loginResult);
    console.log(`${platform} - ğŸ“Š ë„¤ì´ë²„ SDK ì‘ë‹µ êµ¬ì¡°:`, JSON.stringify(loginResult, null, 2));
    
    // ë„¤ì´ë²„ SDK ì‘ë‹µ êµ¬ì¡° í™•ì¸ (iOSì™€ Androidê°€ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ)
    // iOS: { isSuccess: true, successResponse: { accessToken, refreshToken, ... } }
    // Android: ì§ì ‘ accessToken ê°ì²´ë¥¼ ë°˜í™˜í•  ìˆ˜ë„ ìˆìŒ
    let accessToken = null;
    
    if (loginResult?.isSuccess && loginResult?.successResponse?.accessToken) {
      // iOS í˜•ì‹: { isSuccess: true, successResponse: { accessToken: string } }
      accessToken = loginResult.successResponse.accessToken;
    } else if (loginResult?.accessToken) {
      // ì§ì ‘ accessToken í•„ë“œ (Android ê°€ëŠ¥)
      accessToken = typeof loginResult.accessToken === 'string' 
        ? loginResult.accessToken 
        : loginResult.accessToken.accessToken;
    } else if (loginResult?.successResponse?.accessToken) {
      // successResponseê°€ ìˆì§€ë§Œ isSuccessê°€ ì—†ëŠ” ê²½ìš°
      accessToken = loginResult.successResponse.accessToken;
    } else if (loginResult?.token) {
      // token í•„ë“œ ì‚¬ìš©
      accessToken = loginResult.token;
    }
    
    if (!accessToken) {
      console.error(`${platform} - âŒ ë„¤ì´ë²„ ë¡œê·¸ì¸ ì‘ë‹µ êµ¬ì¡°:`, JSON.stringify(loginResult, null, 2));
      throw new Error('ë„¤ì´ë²„ ë¡œê·¸ì¸ ì‘ë‹µì—ì„œ accessTokenì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
    
    console.log(`${platform} - âœ… ë„¤ì´ë²„ accessToken íšë“:`, accessToken.substring(0, 20) + '...');
    
    // ë„¤ì´ë²„ í”„ë¡œí•„ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (accessToken ì‚¬ìš©)
    let userId = null;
    let email = null;
    let nickname = null;
    let profileImage = null;
    
    try {
      const profileResult = await NaverLogin.getProfile(accessToken);
      console.log(`${platform} - âœ… ë„¤ì´ë²„ í”„ë¡œí•„ ì •ë³´:`, profileResult);
      
      if (profileResult?.response) {
        userId = profileResult.response.id || profileResult.response.userId;
        email = profileResult.response.email;
        nickname = profileResult.response.nickname || profileResult.response.name;
        profileImage = profileResult.response.profile_image || profileResult.response.profileImageUrl;
      }
    } catch (profileError) {
      console.warn('âš ï¸ ë„¤ì´ë²„ í”„ë¡œí•„ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', profileError);
      // í”„ë¡œí•„ ì •ë³´ê°€ ì—†ì–´ë„ accessTokenìœ¼ë¡œ ë°±ì—”ë“œì—ì„œ ì¡°íšŒ ê°€ëŠ¥
    }
    
    if (!userId || !email) {
      console.warn('âš ï¸ ë„¤ì´ë²„ ì‘ë‹µì— ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë°±ì—”ë“œì—ì„œ ì¡°íšŒí•©ë‹ˆë‹¤.');
    }
    
      // ë°±ì—”ë“œë¡œ ë¡œê·¸ì¸ ì •ë³´ ì „ì†¡
      const response = await apiPost(AUTH_API.SOCIAL_LOGIN, {
        provider: 'NAVER',
        accessToken: accessToken,
        userId: userId,
        email: email,
        nickname: nickname || '',
        profileImage: profileImage || '',
      });
      
      if (response?.success && response?.user) {
        // ì‚¬ìš©ì ì •ë³´ ì €ì¥
        await AsyncStorage.setItem('user', JSON.stringify(response.user));
        
        // ì„¸ì…˜ ID ì €ì¥ (ì‘ë‹µ ì¸í„°ì…‰í„°ì—ì„œ ì´ë¯¸ ì €ì¥í–ˆì„ ìˆ˜ ìˆì§€ë§Œ, ëª…ì‹œì ìœ¼ë¡œ ë‹¤ì‹œ ì €ì¥)
        const sessionId = response.sessionId;
        if (sessionId) {
          await AsyncStorage.setItem('sessionId', sessionId);
          
          // iOS ë””ë²„ê¹…: ì„¸ì…˜ ì €ì¥ í™•ì¸
          if (Platform.OS === 'ios') {
            const savedSessionId = await AsyncStorage.getItem('sessionId');
            console.log(`${platform} - âœ… ë„¤ì´ë²„ ì„¸ì…˜ ID ì €ì¥ ì™„ë£Œ:`, savedSessionId ? `${savedSessionId.substring(0, 10)}... (ê¸¸ì´: ${savedSessionId.length})` : 'ì €ì¥ ì‹¤íŒ¨');
            console.log(`${platform} - ğŸ“Š ì‘ë‹µì—ì„œ ë°›ì€ sessionId:`, sessionId ? `${sessionId.substring(0, 10)}... (ê¸¸ì´: ${sessionId.length})` : 'ì—†ìŒ');
            console.log(`${platform} - ğŸ“Š AsyncStorageì— ì €ì¥ëœ sessionId:`, savedSessionId ? `${savedSessionId.substring(0, 10)}... (ê¸¸ì´: ${savedSessionId.length})` : 'ì—†ìŒ');
          }
        } else {
          // iOS ë””ë²„ê¹…: ì„¸ì…˜ IDê°€ ì—†ìŒ
          if (Platform.OS === 'ios') {
            console.warn(`${platform} - âš ï¸ ë„¤ì´ë²„ ì‘ë‹µì— sessionIdê°€ ì—†ìŠµë‹ˆë‹¤! response:`, JSON.stringify(response, null, 2));
          }
        }
        
        return {
          success: true,
          user: response.user,
          accessToken: response.accessToken,
          refreshToken: response.refreshToken,
        };
      } else if (response?.requiresSignup) {
      return {
        success: false,
        requiresSignup: true,
        socialUserInfo: {
          email: email || '',
          nickname: nickname || '',
          provider: 'NAVER',
          socialId: userId ? userId.toString() : '',
        },
      };
    } else {
      throw new Error(response?.message || 'ë„¤ì´ë²„ ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  } catch (error) {
    console.error('âŒ ë„¤ì´ë²„ ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
    
    let errorMessage = STRINGS.AUTH.SOCIAL_LOGIN_ERROR;
    if (error.message) {
      errorMessage = error.message;
    }
    
    return {
      success: false,
      message: errorMessage,
    };
  }
};

/**
 * ì†Œì…œ ë¡œê·¸ì•„ì›ƒ (ë„¤ì´í‹°ë¸Œ SDK ì‚¬ìš©)
 */
export const socialLogout = async (provider) => {
  try {
    if (provider === 'KAKAO') {
      await kakaoSDKLogout();
      console.log('âœ… ì¹´ì¹´ì˜¤ SDK ë¡œê·¸ì•„ì›ƒ ì„±ê³µ');
    } else if (provider === 'NAVER') {
      await NaverLogin.logout();
      console.log('âœ… ë„¤ì´ë²„ SDK ë¡œê·¸ì•„ì›ƒ ì„±ê³µ');
    }
    
    // ë°±ì—”ë“œ ë¡œê·¸ì•„ì›ƒ API í˜¸ì¶œ (ì„ íƒ ì‚¬í•­, ì„¸ì…˜ ê¸°ë°˜ì´ë¯€ë¡œ í•„ìš” ì—†ì„ ìˆ˜ë„ ìˆìŒ)
    await apiPost(AUTH_API.LOGOUT);
    
    // ë¡œì»¬ ì €ì¥ì†Œì—ì„œ í† í° ë° ì‚¬ìš©ì ì •ë³´ ì œê±°
    await AsyncStorage.multiRemove(['accessToken', 'refreshToken', 'user', 'sessionId', 'oauth_state']);
    
    return { success: true };
  } catch (error) {
    console.error(`âŒ Social Logout Failed (${provider}):`, error);
    return { success: false, message: error.message || 'ì†Œì…œ ë¡œê·¸ì•„ì›ƒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' };
  }
};

/**
 * ì†Œì…œ ê³„ì • ì—°ê²° í•´ì œ (ë„¤ì´í‹°ë¸Œ SDK ì‚¬ìš©)
 */
export const socialUnlink = async (provider) => {
  try {
    if (provider === 'KAKAO') {
      await kakaoSDKUnlink();
      console.log('âœ… ì¹´ì¹´ì˜¤ SDK ì—°ê²° í•´ì œ ì„±ê³µ');
    } else if (provider === 'NAVER') {
      await NaverLogin.deleteToken(); // ë„¤ì´ë²„ëŠ” deleteTokenìœ¼ë¡œ ì—°ê²° í•´ì œ
      console.log('âœ… ë„¤ì´ë²„ SDK ì—°ê²° í•´ì œ ì„±ê³µ');
    }
    
    // ë°±ì—”ë“œ APIë¥¼ í†µí•´ ì†Œì…œ ê³„ì • ì—°ê²° í•´ì œ
    const response = await apiPost('/api/auth/social/unlink', { provider });
    
    if (response.success) {
      await AsyncStorage.multiRemove(['accessToken', 'refreshToken', 'user', 'sessionId', 'oauth_state']);
      return { success: true };
    } else {
      throw new Error(response.message || 'ì†Œì…œ ê³„ì • ì—°ê²° í•´ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  } catch (error) {
    console.error(`âŒ Social Unlink Failed (${provider}):`, error);
    return { success: false, message: error.message || 'ì†Œì…œ ê³„ì • ì—°ê²° í•´ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' };
  }
};

/**
 * OAuth2 ì½œë°± ì²˜ë¦¬ (ì›¹ê³¼ ë™ì¼)
 * Deep Link URL í˜•ì‹ ì§€ì›: mindgarden://oauth/callback?code=xxx&state=xxx
 */
export const handleOAuthCallback = async (url) => {
  try {
    const isIOS = Platform.OS === 'ios';
    const logPrefix = isIOS ? 'ğŸ iOS' : 'ğŸ¤– Android';
    
    console.log(`${logPrefix} - OAuth2 ì½œë°± ì²˜ë¦¬ ì‹œì‘:`, url);
    
    // URL íŒŒë¼ë¯¸í„° íŒŒì‹± (Deep Link ë° ì¼ë°˜ URL ëª¨ë‘ ì§€ì›)
    let params;
    
    if (url.startsWith('mindgarden://') || url.startsWith('com.mindgardenmobile://')) {
      // Deep Link í˜•ì‹: mindgarden://oauth/callback?code=xxx&state=xxx
      // URLì—ì„œ pathì™€ query ë¶„ë¦¬
      const urlParts = url.split('?');
      const queryString = urlParts.length > 1 ? urlParts[1] : '';
      params = new URLSearchParams(queryString);
      console.log(`${logPrefix} - Deep Link í˜•ì‹ ê°ì§€:`, url);
      console.log(`${logPrefix} - Query String:`, queryString);
      
      // iOS ì „ìš©: URL ë””ì½”ë”© í™•ì¸
      if (isIOS) {
        console.log(`${logPrefix} - URL ì „ì²´ ê¸¸ì´:`, url.length);
        console.log(`${logPrefix} - Query String ê¸¸ì´:`, queryString.length);
      }
    } else if (url.includes('oauth/callback') || url.includes('oauth2/callback')) {
      // ì¼ë°˜ URL í˜•ì‹
      try {
        const urlObj = new URL(url);
        params = new URLSearchParams(urlObj.search);
      } catch (e) {
        // URL íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì§ì ‘ íŒŒì‹±
        const queryString = url.includes('?') ? url.split('?')[1] : url;
        params = new URLSearchParams(queryString);
      }
    }
    
    const success = params.get('success');
    const provider = params.get('provider');
    const code = params.get('code');
    const authToken = params.get('authToken'); // Deep Linkì—ì„œ ì „ë‹¬ëœ ì„ì‹œ ì¸ì¦ í† í°
    const state = params.get('state');
    const error = params.get('error');
    const userId = params.get('userId'); // Deep Linkì—ì„œ ë°›ì€ userId
    let sessionId = params.get('sessionId'); // Deep Linkì—ì„œ ë°›ì€ sessionId
    
    // iOS ì „ìš©: sessionId íŒŒì‹± ì‹¤íŒ¨ ì‹œ ê°•ì œ ì¶”ì¶œ
    if (isIOS && !sessionId) {
      console.warn(`${logPrefix} - âš ï¸ URLSearchParamsì—ì„œ sessionId íŒŒì‹± ì‹¤íŒ¨! ê°•ì œ ì¶”ì¶œ ì‹œë„`);
      // URLì—ì„œ ì§ì ‘ ì¶”ì¶œ ì‹œë„ (ì—¬ëŸ¬ íŒ¨í„´ ì‹œë„)
      const patterns = [
        /[&?]sessionId=([^&]+)/,  // ì¼ë°˜ íŒ¨í„´
        /sessionId%3D([^&%]+)/,   // URL ì¸ì½”ë”©ëœ íŒ¨í„´
        /sessionId=([A-F0-9]{32})/, // 32ìë¦¬ hex íŒ¨í„´
      ];
      
      for (const pattern of patterns) {
        const match = url.match(pattern);
        if (match && match[1]) {
          try {
            sessionId = decodeURIComponent(match[1]);
            console.log(`${logPrefix} - ğŸ”§ ì •ê·œì‹ìœ¼ë¡œ sessionId ì¶”ì¶œ ì„±ê³µ:`, sessionId);
            console.log(`${logPrefix} - sessionId ê¸¸ì´:`, sessionId.length);
            // paramsì— ê°•ì œë¡œ ì¶”ê°€
            params.set('sessionId', sessionId);
            break;
          } catch (e) {
            console.warn(`${logPrefix} - ğŸ”§ URL ë””ì½”ë”© ì‹¤íŒ¨, ì›ë³¸ ì‚¬ìš©:`, match[1]);
            sessionId = match[1];
            params.set('sessionId', sessionId);
            break;
          }
        }
      }
      
      if (!sessionId) {
        console.error(`${logPrefix} - âŒ sessionIdë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤! URL ì „ì²´:`, url);
      }
    }
    
    console.log(`${logPrefix} - OAuth2 ì½œë°± íŒŒë¼ë¯¸í„°:`, { 
      success, 
      provider, 
      userId, 
      sessionId: sessionId ? `${sessionId.substring(0, 10)}... (ê¸¸ì´: ${sessionId.length})` : 'ì—†ìŒ' 
    });
    
    // iOS ì „ìš©: sessionId ìƒì„¸ í™•ì¸
    if (isIOS && sessionId) {
      console.log(`${logPrefix} - âœ… sessionId íŒŒì‹± ì„±ê³µ:`, sessionId);
      console.log(`${logPrefix} - sessionId ì „ì²´:`, sessionId);
    }
    
    if (error) {
      console.error('âŒ OAuth2 ì˜¤ë¥˜:', error);
      return { success: false, message: `OAuth2 ì¸ì¦ ì˜¤ë¥˜: ${error}` };
    }
    
    // ì €ì¥ëœ state í™•ì¸
    const savedState = await AsyncStorage.getItem('oauth_state');
    if (state && state !== savedState) {
      console.error('âŒ State ê²€ì¦ ì‹¤íŒ¨:', { received: state, saved: savedState });
      return { success: false, message: 'OAuth2 state ê²€ì¦ ì‹¤íŒ¨' };
    }
    
    if (state) {
      await AsyncStorage.removeItem('oauth_state');
    }
    
    // Deep Linkì—ì„œ ì´ë¯¸ success=trueë¥¼ ë°›ì€ ê²½ìš° (ë°±ì—”ë“œì—ì„œ ì´ë¯¸ ì²˜ë¦¬ ì™„ë£Œ)
    if (success === 'true') {
      console.log(`${logPrefix} - Deep Linkì—ì„œ success=true ë°›ìŒ, ì„¸ì…˜ ë³µì› ì‹œë„`);
      
      // Deep Linkì—ì„œ ë°›ì€ sessionId ì €ì¥ (ìµœìš°ì„ ) - ì—¬ëŸ¬ ë°©ë²•ìœ¼ë¡œ ì‹œë„
      let finalSessionId = params.get('sessionId') || sessionId;
      
      // iOS ì „ìš©: params.getì´ ì‹¤íŒ¨í–ˆì„ ê²½ìš° ê°•ì œ ì¶”ì¶œ
      if (isIOS && !finalSessionId) {
        console.warn(`${logPrefix} - âš ï¸ sessionIdê°€ ì—†ì–´ì„œ URLì—ì„œ ì¬ì¶”ì¶œ ì‹œë„`);
        const sessionIdMatch = url.match(/[&?]sessionId=([^&]+)/);
        if (sessionIdMatch && sessionIdMatch[1]) {
          finalSessionId = decodeURIComponent(sessionIdMatch[1]);
          console.log(`${logPrefix} - ğŸ”§ URLì—ì„œ sessionId ì¬ì¶”ì¶œ:`, finalSessionId);
        }
      }
      
      if (finalSessionId) {
        // ì„¸ì…˜ ID ì •ê·œí™” (ê³µë°± ì œê±° ë“±)
        finalSessionId = finalSessionId.trim();
        await AsyncStorage.setItem('sessionId', finalSessionId);
        console.log(`${logPrefix} - âœ… Deep Linkì—ì„œ ë°›ì€ ì„¸ì…˜ ID ì €ì¥:`, finalSessionId);
        console.log(`${logPrefix} - ì„¸ì…˜ ID ê¸¸ì´:`, finalSessionId.length);
        
        // iOS ì „ìš©: ì €ì¥ í™•ì¸ (ì¦‰ì‹œ í™•ì¸)
        if (isIOS) {
          const savedSessionId = await AsyncStorage.getItem('sessionId');
          if (savedSessionId === finalSessionId) {
            console.log(`${logPrefix} - âœ… ì„¸ì…˜ ID ì €ì¥ í™•ì¸ ì™„ë£Œ`);
            console.log(`${logPrefix} - ì €ì¥ëœ ì„¸ì…˜ ID ì „ì²´:`, savedSessionId);
          } else {
            console.error(`${logPrefix} - âŒ ì„¸ì…˜ ID ì €ì¥ ì‹¤íŒ¨!`);
            console.error(`${logPrefix} - ì €ì¥í•˜ë ¤ë˜ ê°’:`, finalSessionId);
            console.error(`${logPrefix} - ì‹¤ì œ ì €ì¥ëœ ê°’:`, savedSessionId);
            // ì¬ì‹œë„
            await AsyncStorage.setItem('sessionId', finalSessionId);
            const retrySaved = await AsyncStorage.getItem('sessionId');
            if (retrySaved === finalSessionId) {
              console.log(`${logPrefix} - âœ… ì¬ì‹œë„ í›„ ì„¸ì…˜ ID ì €ì¥ ì„±ê³µ`);
            } else {
              console.error(`${logPrefix} - âŒ ì¬ì‹œë„ í›„ì—ë„ ì‹¤íŒ¨`);
            }
          }
        }
      } else {
        console.error(`${logPrefix} - âŒ sessionIdë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`);
        console.error(`${logPrefix} - URL ì „ì²´:`, url);
        console.error(`${logPrefix} - params ê°ì²´:`, Object.fromEntries(params));
      }
      
      // ë°±ì—”ë“œë¡œ ì„¸ì…˜ ë³µì› ìš”ì²­ (Deep Linkì—ì„œ ë°›ì€ userId, sessionId ì „ë‹¬)
      const requestSessionId = params.get('sessionId') || sessionId;
      
      console.log(`${logPrefix} - ğŸ“¤ /api/auth/oauth2/callback í˜¸ì¶œ ì‹œì‘`);
      console.log(`${logPrefix} - ğŸ“¤ ìš”ì²­ ë°ì´í„°:`, { provider, userId, sessionId: requestSessionId ? `${requestSessionId.substring(0, 10)}...` : 'ì—†ìŒ' });
      
      // iOS ì „ìš©: AsyncStorageì—ì„œ ì €ì¥ëœ ì„¸ì…˜ ID í™•ì¸
      if (isIOS) {
        const storedSessionId = await AsyncStorage.getItem('sessionId');
        console.log(`${logPrefix} - ğŸ“¦ AsyncStorageì˜ ì„¸ì…˜ ID:`, storedSessionId ? `${storedSessionId.substring(0, 10)}...` : 'ì—†ìŒ');
      }
      
      const response = await apiPost(AUTH_API.OAUTH2_CALLBACK, {
        provider,
        userId, // Deep Linkì—ì„œ ë°›ì€ userId
        sessionId: requestSessionId, // Deep Linkì—ì„œ ë°›ì€ sessionId
        authToken, // ì„ì‹œ ì¸ì¦ í† í° (ì‚¬ìš© ì•ˆí•  ìˆ˜ë„ ìˆìŒ)
        code, // fallbackìš© (ì‚¬ìš© ì•ˆí•  ìˆ˜ë„ ìˆìŒ)
        state,
      });
      
      console.log(`${logPrefix} - ğŸ“Š ë°±ì—”ë“œ OAuth2 ì½œë°± ì‘ë‹µ:`, response);
      console.log(`${logPrefix} - ğŸ“Š ì‘ë‹µ ì„¸ì…˜ ID:`, response?.sessionId ? `${response.sessionId.substring(0, 10)}...` : 'ì—†ìŒ');
      
      if (response && response.success) {
        // ì„¸ì…˜ ID ì €ì¥ (API ì‘ë‹µì—ì„œ ë°›ì€ ê²ƒ ìš°ì„ , ì—†ìœ¼ë©´ Deep Linkì—ì„œ ë°›ì€ ê²ƒ ì‚¬ìš©)
        const finalSessionId = response.sessionId || requestSessionId;
        if (finalSessionId) {
          await AsyncStorage.setItem('sessionId', finalSessionId);
          console.log(`${logPrefix} - âœ… ìµœì¢… ì„¸ì…˜ ID ì €ì¥:`, finalSessionId);
          
          // iOS ì „ìš©: ì €ì¥ í™•ì¸
          if (isIOS) {
            const savedSessionId = await AsyncStorage.getItem('sessionId');
            if (savedSessionId === finalSessionId) {
              console.log(`${logPrefix} - âœ… ìµœì¢… ì„¸ì…˜ ID ì €ì¥ í™•ì¸ ì™„ë£Œ`);
            } else {
              console.error(`${logPrefix} - âŒ ìµœì¢… ì„¸ì…˜ ID ì €ì¥ ì‹¤íŒ¨! ì €ì¥ëœ ê°’:`, savedSessionId);
            }
          }
        } else {
          console.error(`${logPrefix} - âŒ ìµœì¢… ì„¸ì…˜ IDê°€ ì—†ìŠµë‹ˆë‹¤!`);
        }
        
        // ì‚¬ìš©ì ì •ë³´ ì €ì¥ (ë¡œê·¸ì¸ í›„ Context ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ í•„ìˆ˜)
        let finalUser = response.user;
        
        if (finalUser) {
          await AsyncStorage.setItem('user', JSON.stringify(finalUser));
          console.log('âœ… ì†Œì…œ ë¡œê·¸ì¸ ì‚¬ìš©ì ì •ë³´ ì €ì¥ ì™„ë£Œ:', finalUser);
        } else {
          // ë°±ì—”ë“œì—ì„œ user ì •ë³´ë¥¼ ë°˜í™˜í•˜ì§€ ì•Šì•˜ì§€ë§Œ userIdê°€ ìˆìœ¼ë©´
          // í˜„ì¬ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ GET_CURRENT_USER í˜¸ì¶œ
          console.log('âš ï¸ ë°±ì—”ë“œ ì‘ë‹µì— ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìŒ, í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹œë„');
          try {
            const { apiGet } = await import('../api/client');
            const { AUTH_API } = await import('../api/endpoints');
            const userResponse = await apiGet(AUTH_API.GET_CURRENT_USER);
            if (userResponse && userResponse.user) {
              finalUser = userResponse.user;
              await AsyncStorage.setItem('user', JSON.stringify(finalUser));
              console.log('âœ… í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ë° ì €ì¥ ì™„ë£Œ:', finalUser);
            } else {
              console.warn('âš ï¸ GET_CURRENT_USER ì‘ë‹µì— ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
            }
          } catch (userError) {
            console.error('âŒ í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', userError);
            // ì„¸ì…˜ì€ ì„¤ì •ë˜ì—ˆì§€ë§Œ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í•œ ê²½ìš°
            // Deep Linkì—ì„œ ë°›ì€ ì •ë³´ë¡œ ì‚¬ìš©ì ê°ì²´ ìƒì„±
            const name = params.get('name');
            const email = params.get('email');
            const role = params.get('role');
            const nickname = params.get('nickname');
            const profileImage = params.get('profileImage');
            
            if (userId && name && email && role) {
              finalUser = {
                id: parseInt(userId),
                email: email,
                name: name,
                nickname: nickname || '',
                role: role,
                profileImageUrl: profileImage || ''
              };
              await AsyncStorage.setItem('user', JSON.stringify(finalUser));
              console.log('âœ… Deep Link ì •ë³´ë¡œ ì‚¬ìš©ì ê°ì²´ ìƒì„± ë° ì €ì¥:', finalUser);
            }
          }
        }
        
        if (!finalUser) {
          console.error('âŒ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return { success: false, message: 'ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' };
        }
        
        return { 
          success: true, 
          user: finalUser
        };
      } else if (response && response.requiresSignup) {
        return { 
          success: false, 
          requiresSignup: true, 
          socialUserInfo: response.socialUserInfo 
        };
      } else {
        return { success: false, message: response.message || 'OAuth2 ì¸ì¦ ì‹¤íŒ¨' };
      }
    } else if (success === 'false' && params.get('requiresSignup') === 'true') {
      // íšŒì›ê°€ì… í•„ìš”
      return {
        success: false,
        requiresSignup: true,
        socialUserInfo: {
          email: params.get('email') || '',
          name: params.get('name') || '',
          nickname: params.get('nickname') || '',
          provider: provider
        }
      };
    } else {
      return { success: false, message: error || 'OAuth2 ì¸ì¦ ì‹¤íŒ¨' };
    }
  } catch (error) {
    console.error('âŒ OAuth2 ì½œë°± ì²˜ë¦¬ ì˜¤ë¥˜:', error);
    return { success: false, message: error.message || 'OAuth2 ì½œë°± ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' };
  }
};
