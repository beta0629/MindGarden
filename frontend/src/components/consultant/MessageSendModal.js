import React, { useState, useEffect } from 'react';
import { useSession } from '../../contexts/SessionContext';
import { apiPost, apiGet } from '../../utils/ajax';
import UnifiedLoading from "../common/UnifiedLoading";
import notificationManager from '../../utils/notification';

/**
 * ÎÇ¥Îã¥Ïûê Î©îÏãúÏßÄ Ï†ÑÏÜ° Î™®Îã¨ Ïª¥Ìè¨ÎÑåÌä∏
 * ÏÉÅÎã¥ÏùºÏßÄ ÏûëÏÑ± ÏôÑÎ£å ÌõÑ ÎÇ¥Îã¥ÏûêÏóêÍ≤å Î©îÏãúÏßÄÎ•º Î≥¥ÎÇº Ïàò ÏûàÎäî Î™®Îã¨
 */
const MessageSendModal = ({ 
  isOpen, 
  onClose, 
  clientData, 
  scheduleData,
  onSend 
}) => {
  const { user } = useSession();
  
  const [sending, setSending] = useState(false);
  const [formData, setFormData] = useState({
    title: '',
    content: '',
    messageType: 'GENERAL',
    isImportant: false,
    isUrgent: false
  });
  const [messageTypeOptions, setMessageTypeOptions] = useState([]);
  const [loadingCodes, setLoadingCodes] = useState(false);

  // Î©îÏãúÏßÄ Ïú†Ìòï ÏΩîÎìú Î°úÎìú
  useEffect(() => {
    const loadMessageTypeCodes = async () => {
      try {
        setLoadingCodes(true);
        const response = await apiGet('/api/common-codes/group/MESSAGE_TYPE');
        if (response && response.length > 0) {
          const options = response.map(code => ({
            value: code.codeValue,
            label: code.codeLabel,
            icon: code.icon,
            color: code.colorCode,
            description: code.description
          }));
          setMessageTypeOptions(options);
        }
      } catch (error) {
        console.error('Î©îÏãúÏßÄ Ïú†Ìòï ÏΩîÎìú Î°úÎìú Ïã§Ìå®:', error);
        // Ïã§Ìå® Ïãú Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
        setMessageTypeOptions([
          { value: 'GENERAL', label: 'ÏùºÎ∞ò Î©îÏãúÏßÄ', icon: 'üí¨', color: '#6c757d', description: 'ÏùºÎ∞òÏ†ÅÏù∏ Î©îÏãúÏßÄ' },
          { value: 'FOLLOW_UP', label: 'ÌõÑÏÜç Ï°∞Ïπò', icon: 'üîÑ', color: '#007bff', description: 'ÌõÑÏÜç Ï°∞Ïπò ÏïàÎÇ¥ Î©îÏãúÏßÄ' },
          { value: 'HOMEWORK', label: 'Í≥ºÏ†ú ÏïàÎÇ¥', icon: 'üìù', color: '#28a745', description: 'Í≥ºÏ†ú Î∞è ÏàôÏ†ú ÏïàÎÇ¥ Î©îÏãúÏßÄ' },
          { value: 'APPOINTMENT', label: 'ÏïΩÏÜç ÏïàÎÇ¥', icon: 'üìÖ', color: '#ffc107', description: 'ÏïΩÏÜç Î∞è ÏùºÏ†ï ÏïàÎÇ¥ Î©îÏãúÏßÄ' },
          { value: 'EMERGENCY', label: 'Í∏¥Í∏â ÏïàÎÇ¥', icon: 'üö®', color: '#dc3545', description: 'Í∏¥Í∏â ÏÉÅÌô© ÏïàÎÇ¥ Î©îÏãúÏßÄ' }
        ]);
      } finally {
        setLoadingCodes(false);
      }
    };

    loadMessageTypeCodes();
  }, []);

  // ÏïàÏ†ÑÌïú ÎÇ†Ïßú Î≥ÄÌôò Ìï®Ïàò
  const safeFormatDateTime = (dateValue) => {
    if (!dateValue) return 'ÌôïÏù∏ ÌïÑÏöî';
    
    try {
      if (typeof dateValue === 'string') {
        return new Date(dateValue).toLocaleString('ko-KR');
      } else if (dateValue instanceof Date) {
        return dateValue.toLocaleString('ko-KR');
      } else {
        return new Date(dateValue).toLocaleString('ko-KR');
      }
    } catch (error) {
      console.warn('ÎÇ†Ïßú Î≥ÄÌôò Ïò§Î•ò:', error);
      return 'ÌôïÏù∏ ÌïÑÏöî';
    }
  };

  // Ìèº Ï¥àÍ∏∞Ìôî
  useEffect(() => {
    if (isOpen && clientData && scheduleData) {
      const startTime = safeFormatDateTime(scheduleData.startTime);

      setFormData({
        title: `ÏÉÅÎã¥ ÏùºÏßÄ ÏûëÏÑ± ÏôÑÎ£å - ${scheduleData.title || 'ÏÉÅÎã¥'}`,
        content: `ÏïàÎÖïÌïòÏÑ∏Ïöî ${clientData.name}Îãò,\n\nÏÉÅÎã¥ ÏùºÏßÄÍ∞Ä ÏûëÏÑ±ÎêòÏóàÏäµÎãàÎã§.\n\nÏÉÅÎã¥ ÏùºÏãú: ${startTime}\n\nÏ∂îÍ∞Ä Î¨∏ÏùòÏÇ¨Ìï≠Ïù¥ ÏûàÏúºÏãúÎ©¥ Ïñ∏Ï†úÎì†ÏßÄ Ïó∞ÎùΩÏ£ºÏÑ∏Ïöî.\n\nÍ∞êÏÇ¨Ìï©ÎãàÎã§.`,
        messageType: 'GENERAL',
        isImportant: false,
        isUrgent: false
      });
    }
  }, [isOpen, clientData, scheduleData]);

  const handleInputChange = (e) => {
    const { name, value, type, checked } = e.target;
    setFormData(prev => ({
      ...prev,
      [name]: type === 'checkbox' ? checked : value
    }));
  };

  const handleSend = async () => {
    if (!formData.title.trim() || !formData.content.trim()) {
      notificationManager.show('Ï†úÎ™©Í≥º ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
      return;
    }

    try {
      setSending(true);
      
      // consultationIdÎ•º Ïà´ÏûêÎ°ú Î≥ÄÌôò (schedule-30 -> 30)
      const consultationId = scheduleData.id ? 
        (typeof scheduleData.id === 'string' && scheduleData.id.startsWith('schedule-') ? 
          parseInt(scheduleData.id.replace('schedule-', '')) : 
          parseInt(scheduleData.id)) : 
        null;

      const messageData = {
        consultantId: user.id,
        clientId: clientData.id,
        consultationId: consultationId,
        senderType: 'CONSULTANT',
        title: formData.title,
        content: formData.content,
        messageType: formData.messageType,
        isImportant: formData.isImportant,
        isUrgent: formData.isUrgent
      };

      const response = await apiPost('/api/consultation-messages', messageData);

      if (response.success) {
        notificationManager.show('Î©îÏãúÏßÄÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÑÏÜ°ÎêòÏóàÏäµÎãàÎã§.', 'success');
        onSend && onSend(response.data);
        onClose();
      } else {
        throw new Error(response.message || 'Î©îÏãúÏßÄ Ï†ÑÏÜ°Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
      }
    } catch (error) {
      console.error('Î©îÏãúÏßÄ Ï†ÑÏÜ° Ïò§Î•ò:', error);
      notificationManager.show('Î©îÏãúÏßÄ Ï†ÑÏÜ° Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
    } finally {
      setSending(false);
    }
  };

  if (!isOpen) return null;

  // Ïª¥Ìè¨ÎÑåÌä∏ Ïä§ÌÉÄÏùº
  const styles = {
    modalOverlay: {
      position: 'fixed',
      top: 0,
      left: 0,
      right: 0,
      bottom: 0,
      backgroundColor: 'rgba(0, 0, 0, 0.7)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      zIndex: 10000,
      padding: '20px'
    },
    modalContent: {
      backgroundColor: '#fff',
      borderRadius: '12px',
      width: '90%',
      maxWidth: '600px',
      maxHeight: '80vh',
      overflowY: 'auto',
      boxShadow: '0 10px 30px rgba(0, 0, 0, 0.3)',
      position: 'relative'
    },
    header: {
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'center',
      padding: '20px 24px',
      borderBottom: '1px solid #e9ecef',
      backgroundColor: '#f8f9fa',
      borderRadius: '12px 12px 0 0'
    },
    headerTitle: {
      fontSize: 'var(--font-size-lg)',
      fontWeight: '600',
      color: '#2c3e50',
      margin: 0
    },
    closeBtn: {
      background: 'none',
      border: 'none',
      fontSize: 'var(--font-size-xxl)',
      cursor: 'pointer',
      color: '#6c757d',
      padding: '4px',
      borderRadius: '4px',
      transition: 'all 0.2s ease'
    },
    content: {
      padding: '24px'
    },
    clientInfo: {
      backgroundColor: '#f8f9fa',
      borderRadius: '8px',
      padding: '16px',
      marginBottom: '20px',
      border: '1px solid #e9ecef'
    },
    clientInfoTitle: {
      fontSize: 'var(--font-size-sm)',
      fontWeight: '600',
      color: '#495057',
      marginBottom: '8px'
    },
    clientInfoText: {
      fontSize: 'var(--font-size-sm)',
      color: '#6c757d'
    },
    formGroup: {
      marginBottom: '20px'
    },
    formLabel: {
      display: 'block',
      fontSize: 'var(--font-size-sm)',
      fontWeight: '600',
      color: '#495057',
      marginBottom: '8px'
    },
    formInput: {
      width: '100%',
      padding: '12px 16px',
      border: '2px solid #e9ecef',
      borderRadius: '8px',
      fontSize: 'var(--font-size-sm)',
      backgroundColor: '#fff',
      color: '#495057',
      transition: 'all 0.2s ease',
      boxSizing: 'border-box'
    },
    formSelect: {
      width: '100%',
      padding: '12px 16px',
      border: '2px solid #e9ecef',
      borderRadius: '8px',
      fontSize: 'var(--font-size-sm)',
      backgroundColor: '#fff',
      color: '#495057',
      cursor: 'pointer',
      transition: 'all 0.2s ease',
      boxSizing: 'border-box'
    },
    formTextarea: {
      width: '100%',
      padding: '12px 16px',
      border: '2px solid #e9ecef',
      borderRadius: '8px',
      fontSize: 'var(--font-size-sm)',
      backgroundColor: '#fff',
      color: '#495057',
      minHeight: '120px',
      resize: 'vertical',
      fontFamily: 'inherit',
      transition: 'all 0.2s ease',
      boxSizing: 'border-box'
    },
    checkboxGroup: {
      display: 'flex',
      gap: '16px',
      marginTop: '8px'
    },
    checkboxItem: {
      display: 'flex',
      alignItems: 'center',
      gap: '8px'
    },
    checkbox: {
      width: '16px',
      height: '16px',
      cursor: 'pointer'
    },
    checkboxLabel: {
      fontSize: 'var(--font-size-sm)',
      color: '#495057',
      cursor: 'pointer'
    },
    buttonGroup: {
      display: 'flex',
      gap: '12px',
      justifyContent: 'flex-end',
      marginTop: '24px',
      paddingTop: '20px',
      borderTop: '1px solid #e9ecef'
    },
    button: {
      padding: '12px 24px',
      borderRadius: '8px',
      fontSize: 'var(--font-size-sm)',
      fontWeight: '600',
      cursor: 'pointer',
      transition: 'all 0.2s ease',
      border: 'none',
      display: 'flex',
      alignItems: 'center',
      gap: '8px'
    },
    primaryButton: {
      backgroundColor: '#007bff',
      color: '#fff'
    },
    secondaryButton: {
      backgroundColor: '#6c757d',
      color: '#fff'
    },
    loadingOverlay: {
      position: 'absolute',
      top: 0,
      left: 0,
      right: 0,
      bottom: 0,
      backgroundColor: 'rgba(255, 255, 255, 0.8)',
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      zIndex: 9999
    }
  };

  return (
    <div className="message-send-modal-overlay">
      <div className="message-send-modal-content">
        {/* Ìó§Îçî */}
        <div style={styles.header}>
          <h1 style={styles.headerTitle}>üì® ÎÇ¥Îã¥ÏûêÏóêÍ≤å Î©îÏãúÏßÄ Î≥¥ÎÇ¥Í∏∞</h1>
          <button style={styles.closeBtn} onClick={onClose}>√ó</button>
        </div>

        <div style={styles.content}>
          {/* ÎÇ¥Îã¥Ïûê Ï†ïÎ≥¥ */}
          {clientData && (
            <div style={styles.clientInfo}>
              <div style={styles.clientInfoTitle}>üë§ ÏàòÏã†Ïûê</div>
              <div style={styles.clientInfoText}>
                {clientData.name} ({clientData.age}ÏÑ∏, {clientData.gender})
              </div>
            </div>
          )}

          {/* Î©îÏãúÏßÄ ÏûëÏÑ± Ìèº */}
          <div style={styles.formGroup}>
            <label style={styles.formLabel}>Ï†úÎ™© *</label>
            <input
              type="text"
              name="title"
              value={formData.title}
              onChange={handleInputChange}
              placeholder="Î©îÏãúÏßÄ Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
              style={styles.formInput}
              required
            />
          </div>

          <div style={styles.formGroup}>
            <label style={styles.formLabel}>Î©îÏãúÏßÄ ÌÉÄÏûÖ</label>
            <select
              name="messageType"
              value={formData.messageType}
              onChange={handleInputChange}
              style={styles.formSelect}
            >
              {messageTypeOptions.map(type => (
                <option key={type.value} value={type.value}>
                  {type.icon} {type.label} ({type.value})
                </option>
              ))}
            </select>
          </div>

          <div style={styles.formGroup}>
            <label style={styles.formLabel}>ÎÇ¥Ïö© *</label>
            <textarea
              name="content"
              value={formData.content}
              onChange={handleInputChange}
              placeholder="Î©îÏãúÏßÄ ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
              style={styles.formTextarea}
              required
            />
          </div>

          <div style={styles.formGroup}>
            <label style={styles.formLabel}>ÏòµÏÖò</label>
            <div style={styles.checkboxGroup}>
              <div style={styles.checkboxItem}>
                <input
                  type="checkbox"
                  name="isImportant"
                  checked={formData.isImportant}
                  onChange={handleInputChange}
                  style={styles.checkbox}
                />
                <label style={styles.checkboxLabel}>Ï§ëÏöî Î©îÏãúÏßÄ</label>
              </div>
              <div style={styles.checkboxItem}>
                <input
                  type="checkbox"
                  name="isUrgent"
                  checked={formData.isUrgent}
                  onChange={handleInputChange}
                  style={styles.checkbox}
                />
                <label style={styles.checkboxLabel}>Í∏¥Í∏â Î©îÏãúÏßÄ</label>
              </div>
            </div>
          </div>

          {/* Î≤ÑÌäº Í∑∏Î£π */}
          <div style={styles.buttonGroup}>
            <button
              type="button"
              onClick={onClose}
              style={{...styles.button, ...styles.secondaryButton}}
              disabled={sending}
            >
              Ï∑®ÏÜå
            </button>
            <button
              type="button"
              onClick={handleSend}
              style={{...styles.button, ...styles.primaryButton}}
              disabled={sending}
            >
              {sending ? <UnifiedLoading variant="dots" size="small" type="inline" /> : 'üì§ Î©îÏãúÏßÄ Ï†ÑÏÜ°'}
            </button>
          </div>
        </div>

        {/* Î°úÎî© Ïò§Î≤ÑÎ†àÏù¥ */}
        {sending && (
          <div style={styles.loadingOverlay}>
            <UnifiedLoading variant="pulse" size="large" text="Î©îÏãúÏßÄ Ï†ÑÏÜ° Ï§ë..." type="inline" />
          </div>
        )}
      </div>
    </div>
  );
};

export default MessageSendModal;
