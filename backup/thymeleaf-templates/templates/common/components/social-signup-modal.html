<!-- ì†Œì…œ ë¡œê·¸ì¸ ê°„í¸ íšŒì›ê°€ì… ëª¨ë‹¬ -->
<div class="social-signup-modal" id="socialSignupModal" th:fragment="social-signup-modal">
    <div class="modal-overlay" id="modalOverlay"></div>
    <div class="modal-container">
        <div class="modal-header">
            <h3 class="modal-title">ê°„í¸ íšŒì›ê°€ì…</h3>
            <button class="modal-close" id="modalClose">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        
        <div class="modal-body">
            <div class="social-info">
                <div class="social-provider">
                    <span class="provider-icon" id="providerIcon"></span>
                    <span class="provider-name" id="providerName"></span>
                </div>
                <p class="social-description">ì†Œì…œ ê³„ì • ì •ë³´ë¡œ ê°„í¸í•˜ê²Œ ê°€ì…í•˜ì„¸ìš”</p>
            </div>
            
            <form id="socialSignupForm" class="social-signup-form">
                <div class="form-group">
                    <label for="socialName" class="form-label">ì´ë¦„ *</label>
                    <input type="text" id="socialName" name="name" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label for="socialNickname" class="form-label">ë‹‰ë„¤ì„</label>
                    <input type="text" id="socialNickname" name="nickname" class="form-input">
                </div>
                
                <div class="form-group">
                    <label for="socialEmail" class="form-label">ì´ë©”ì¼ *</label>
                    <input type="email" id="socialEmail" name="email" class="form-input" readonly>
                    <small class="form-help">ì†Œì…œ ê³„ì •ì˜ ì´ë©”ì¼ì´ ìë™ìœ¼ë¡œ ì…ë ¥ë©ë‹ˆë‹¤</small>
                </div>
                
                <div class="form-group">
                    <label for="socialPassword" class="form-label">ë¹„ë°€ë²ˆí˜¸ *</label>
                    <div class="input-wrapper">
                        <input type="password" id="socialPassword" name="password" class="form-input" required minlength="8">
                        <button type="button" class="password-toggle" onclick="toggleSocialPassword()">
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                                <path d="M10 4.16667C6.25 4.16667 3.33333 6.66667 2.5 10C3.33333 13.3333 6.25 15.8333 10 15.8333C13.75 15.8333 16.6667 13.3333 17.5 10C16.6667 6.66667 13.75 4.16667 10 4.16667Z" stroke="var(--secondary-400)" stroke-width="1.5"/>
                                <circle cx="10" cy="10" r="2.5" stroke="var(--secondary-400)" stroke-width="1.5"/>
                            </svg>
                        </button>
                    </div>
                    <small class="form-help">8ì ì´ìƒì˜ ì•ˆì „í•œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</small>
                </div>
                
                <div class="form-group">
                    <label for="socialPasswordConfirm" class="form-label">ë¹„ë°€ë²ˆí˜¸ í™•ì¸ *</label>
                    <div class="input-wrapper">
                        <input type="password" id="socialPasswordConfirm" name="passwordConfirm" class="form-input" required minlength="8">
                        <button type="button" class="password-toggle" onclick="toggleSocialPasswordConfirm()">
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                                <path d="M10 4.16667C6.25 4.16667 3.33333 6.66667 2.5 10C3.33333 13.3333 6.25 15.8333 10 15.8333C13.75 15.8333 16.6667 13.3333 17.5 10C16.6667 6.66667 13.75 4.16667 10 4.16667Z" stroke="var(--secondary-400)" stroke-width="1.5"/>
                                <circle cx="10" cy="10" r="2.5" stroke="var(--secondary-400)" stroke-width="1.5"/>
                            </svg>
                        </button>
                    </div>
                    <small class="form-help">ë¹„ë°€ë²ˆí˜¸ë¥¼ í•œ ë²ˆ ë” ì…ë ¥í•˜ì„¸ìš”</small>
                </div>
                
                <div class="form-group">
                    <label for="socialPhone" class="form-label">íœ´ëŒ€í° ë²ˆí˜¸ *</label>
                    <input type="tel" id="socialPhone" name="phone" class="form-input" required placeholder="010-0000-0000" maxlength="13">
                    <small class="form-help">ìˆ«ìë§Œ ì…ë ¥í•˜ë©´ ìë™ìœ¼ë¡œ í•˜ì´í”ˆì´ ì¶”ê°€ë©ë‹ˆë‹¤ (ì˜ˆ: 010-0000-0000)</small>
                </div>
                
                <div class="form-agreement">
                    <label class="checkbox-wrapper">
                        <input type="checkbox" id="agreeTerms" name="agreeTerms" required>
                        <span class="checkmark"></span>
                        <span class="agreement-text">
                            <a href="/terms" target="_blank">ì´ìš©ì•½ê´€</a> ë° 
                            <a href="/privacy" target="_blank">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>ì— ë™ì˜í•©ë‹ˆë‹¤ *
                        </span>
                    </label>
                    
                    <label class="checkbox-wrapper">
                        <input type="checkbox" id="agreeMarketing" name="agreeMarketing">
                        <span class="checkmark"></span>
                        <span class="agreement-text">
                            ë§ˆì¼€íŒ… ì •ë³´ ìˆ˜ì‹ ì— ë™ì˜í•©ë‹ˆë‹¤ (ì„ íƒ)
                        </span>
                    </label>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelSignup">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary" id="completeSignup">íšŒì›ê°€ì… ì™„ë£Œ</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ì†Œì…œ íšŒì›ê°€ì… ëª¨ë‹¬ ìŠ¤í¬ë¦½íŠ¸ -->
<script th:fragment="social-signup-modal-script">
// ì†Œì…œ íšŒì›ê°€ì… ëª¨ë‹¬ ê´€ë¦¬
class SocialSignupModal {
    constructor() {
        this.modal = document.getElementById('socialSignupModal');
        this.overlay = document.getElementById('modalOverlay');
        this.closeBtn = document.getElementById('modalClose');
        this.cancelBtn = document.getElementById('cancelSignup');
        this.form = document.getElementById('socialSignupForm');
        this.providerIcon = document.getElementById('providerIcon');
        this.providerName = document.getElementById('providerName');
        this.emailInput = document.getElementById('socialEmail');
        
        this.initEventListeners();
    }
    
    initEventListeners() {
        // ëª¨ë‹¬ ë‹«ê¸°
        this.closeBtn.addEventListener('click', () => this.hide());
        this.cancelBtn.addEventListener('click', () => this.hide());
        this.overlay.addEventListener('click', () => this.hide());
        
        // í¼ ì œì¶œ
        this.form.addEventListener('submit', (e) => this.handleSubmit(e));
        
        // íœ´ëŒ€í° ë²ˆí˜¸ ìë™ í•˜ì´í”ˆ
        const phoneInput = document.getElementById('socialPhone');
        phoneInput.addEventListener('input', (e) => this.formatPhoneNumber(e.target));
        
        // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && this.isVisible()) {
                this.hide();
            }
        });
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ URL íŒŒë¼ë¯¸í„° í™•ì¸í•˜ì—¬ ëª¨ë‹¬ í‘œì‹œ
        this.checkUrlParameters();
    }
    
    /**
     * íœ´ëŒ€í° ë²ˆí˜¸ ìë™ í•˜ì´í”ˆ í¬ë§·íŒ…
     * @param {HTMLInputElement} input íœ´ëŒ€í° ë²ˆí˜¸ ì…ë ¥ í•„ë“œ
     */
    formatPhoneNumber(input) {
        // ìˆ«ìë§Œ ì¶”ì¶œ
        let value = input.value.replace(/[^0-9]/g, '');
        
        // 11ìë¦¬ ì œí•œ
        if (value.length > 11) {
            value = value.slice(0, 11);
        }
        
        // í•˜ì´í”ˆ ì¶”ê°€
        if (value.length >= 3 && value.length <= 7) {
            value = value.slice(0, 3) + '-' + value.slice(3);
        } else if (value.length >= 8) {
            value = value.slice(0, 3) + '-' + value.slice(3, 7) + '-' + value.slice(7);
        }
        
        input.value = value;
    }
    
    /**
     * URL íŒŒë¼ë¯¸í„° í™•ì¸í•˜ì—¬ ê°„í¸ íšŒì›ê°€ì… ëª¨ë‹¬ í‘œì‹œ
     */
    checkUrlParameters() {
        const urlParams = new URLSearchParams(window.location.search);
        const signupRequired = urlParams.get('signup');
        const provider = urlParams.get('provider');
        const email = urlParams.get('email');
        const name = urlParams.get('name');
        const nickname = urlParams.get('nickname');
        
        if (signupRequired === 'required' && provider && email) {
            // ê°„í¸ íšŒì›ê°€ì… ëª¨ë‹¬ í‘œì‹œ
            const userInfo = {
                provider: provider,
                email: email,
                name: name || '',
                nickname: nickname || '',
                providerUserId: '', // URLì—ì„œ ì „ë‹¬í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ë¹ˆ ê°’
                profileImageUrl: ''
            };
            
            // ëª¨ë‹¬ í‘œì‹œ
            this.show(provider, userInfo);
            
            // URLì—ì„œ íŒŒë¼ë¯¸í„° ì œê±° (ë¸Œë¼ìš°ì € íˆìŠ¤í† ë¦¬ ì •ë¦¬)
            const newUrl = window.location.pathname;
            window.history.replaceState({}, document.title, newUrl);
        }
    }
    
    show(provider, userInfo) {
        // ì œê³µì ì •ë³´ ì„¤ì •
        this.setProviderInfo(provider, userInfo);
        
        // í¼ ë°ì´í„° ì„¤ì •
        this.setFormData(userInfo);
        
        // ì†Œì…œ ì‚¬ìš©ì ì •ë³´ ì €ì¥ (íšŒì›ê°€ì… ì‹œ ì‚¬ìš©)
        this.socialUserInfo = userInfo;
        
        // ëª¨ë‹¬ í‘œì‹œ
        this.modal.style.display = 'flex';
        document.body.classList.add('modal-open');
        
        // í¬ì»¤ìŠ¤ ì„¤ì •
        this.emailInput.focus();
    }
    
    hide() {
        this.modal.style.display = 'none';
        document.body.classList.remove('modal-open');
        
        // í¼ ì´ˆê¸°í™”
        this.form.reset();
        
        // ë¹„ë°€ë²ˆí˜¸ í•„ë“œ íƒ€ì… ì´ˆê¸°í™”
        const passwordInput = document.getElementById('socialPassword');
        const passwordConfirmInput = document.getElementById('socialPasswordConfirm');
        if (passwordInput) passwordInput.type = 'password';
        if (passwordConfirmInput) passwordConfirmInput.type = 'password';
    }
    
    isVisible() {
        return this.modal.style.display === 'flex';
    }
    
    setProviderInfo(provider, userInfo) {
        const providerConfig = {
            'KAKAO': {
                icon: '<i class="bi bi-chat-dots-fill" style="color: #FEE500;"></i>',
                name: 'ì¹´ì¹´ì˜¤'
            },
            'NAVER': {
                icon: '<i class="bi bi-chat-square-fill" style="color: #03C75A;"></i>',
                name: 'ë„¤ì´ë²„'
            }
        };
        
        const config = providerConfig[provider] || { icon: '', name: provider };
        this.providerIcon.innerHTML = config.icon;
        this.providerName.textContent = config.name;
    }
    
    setFormData(userInfo) {
        // ì†Œì…œ ê³„ì •ì—ì„œ ë°›ì€ ì •ë³´ë¡œ í¼ ì´ˆê¸°í™”
        if (userInfo.name) {
            document.getElementById('socialName').value = userInfo.name;
        }
        if (userInfo.nickname) {
            document.getElementById('socialNickname').value = userInfo.nickname;
        }
        if (userInfo.email) {
            document.getElementById('socialEmail').value = userInfo.email;
        }
        if (userInfo.profileImageUrl) {
            // í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ ìˆë‹¤ë©´ í‘œì‹œ
            this.showProfileImage(userInfo.profileImageUrl);
        }
    }
    
    showProfileImage(imageUrl) {
        // í”„ë¡œí•„ ì´ë¯¸ì§€ í‘œì‹œ ë¡œì§ (ì„ íƒì‚¬í•­)
        const profileSection = document.createElement('div');
        profileSection.className = 'profile-image-section';
        profileSection.innerHTML = `
            <img src="${imageUrl}" alt="í”„ë¡œí•„ ì´ë¯¸ì§€" class="profile-image">
        `;
        
        const socialInfo = this.modal.querySelector('.social-info');
        socialInfo.appendChild(profileSection);
    }
    
    async handleSubmit(e) {
        e.preventDefault();
        
        // ë¹„ë°€ë²ˆí˜¸ ê²€ì¦
        const password = document.getElementById('socialPassword').value;
        const passwordConfirm = document.getElementById('socialPasswordConfirm').value;
        
        if (password.length < 8) {
            window.notification.error('ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜', 'ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.', 5000);
            return;
        }
        
        if (password !== passwordConfirm) {
            window.notification.error('ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜', 'ë¹„ë°€ë²ˆí˜¸ì™€ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 5000);
            return;
        }
        
        const formData = new FormData(this.form);
        const signupData = {
            // ì‚¬ìš©ì ì…ë ¥ ì •ë³´ (í•„ìˆ˜ê°’ë§Œ)
            name: formData.get('name'),
            nickname: formData.get('nickname'),
            email: formData.get('email'),
            password: formData.get('password'),
            phone: formData.get('phone').replace(/-/g, ''), // í•˜ì´í”ˆ ì œê±°
            agreeTerms: formData.get('agreeTerms') === 'on',
            agreeMarketing: formData.get('agreeMarketing') === 'on',
            
            // ì†Œì…œ ê³„ì • ì •ë³´
            provider: this.socialUserInfo.provider,
            providerUserId: this.socialUserInfo.providerUserId,
            providerUsername: this.socialUserInfo.nickname,
            providerProfileImage: this.socialUserInfo.profileImageUrl
        };
        
        try {
            // íšŒì›ê°€ì… API í˜¸ì¶œ
            const response = await fetch('/api/auth/social/signup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(signupData)
            });
            
            if (response.ok) {
                const result = await response.json();
                
                if (result.success) {
                    // íšŒì›ê°€ì… ì„±ê³µ
                    window.notification.success('ğŸ‰ íšŒì›ê°€ì… ì™„ë£Œ!', 'ì†Œì…œ ê³„ì •ìœ¼ë¡œ ê°„í¸í•˜ê²Œ ê°€ì…ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œ ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 5000);
                    this.hide();
                    
                    // 3ì´ˆ í›„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                    setTimeout(() => {
                        window.location.href = '/tablet/login';
                    }, 3000);
                } else {
                    window.notification.error('íšŒì›ê°€ì… ì‹¤íŒ¨', result.message, 5000);
                }
            } else {
                window.notification.error('íšŒì›ê°€ì… ì‹¤íŒ¨', 'íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 5000);
            }
        } catch (error) {
            console.error('íšŒì›ê°€ì… ì˜¤ë¥˜:', error);
            window.notification.error('ì˜¤ë¥˜ ë°œìƒ', 'íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 5000);
        }
    }
}

// ì „ì—­ ë³€ìˆ˜ë¡œ ëª¨ë‹¬ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
window.socialSignupModal = new SocialSignupModal();

// ë¹„ë°€ë²ˆí˜¸ í† ê¸€ í•¨ìˆ˜ë“¤
function toggleSocialPassword() {
    const passwordInput = document.getElementById('socialPassword');
    const toggleButton = event.target.closest('button');
    
    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        toggleButton.innerHTML = `
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                <path d="M2.5 5.83333C2.5 4.91286 3.24619 4.16667 4.16667 4.16667H15.8333C16.7538 4.16667 17.5 4.91286 17.5 5.83333V14.1667C17.5 15.0871 16.7538 15.8333 15.8333 15.8333H4.16667C3.24619 15.8333 2.5 15.0871 2.5 14.1667V5.83333Z" stroke="var(--secondary-400)" stroke-width="1.5"/>
                <path d="M17.5 5.83333L10 10.8333L2.5 5.83333" stroke="var(--secondary-400)" stroke-width="1.5"/>
            </svg>
        `;
    } else {
        passwordInput.type = 'password';
        toggleButton.innerHTML = `
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                <path d="M10 4.16667C6.25 4.16667 3.33333 6.66667 2.5 10C3.33333 13.3333 6.25 15.8333 10 15.8333C13.75 15.8333 16.6667 13.3333 17.5 10C16.6667 6.66667 13.75 4.16667 10 4.16667Z" stroke="var(--secondary-400)" stroke-width="1.5"/>
                <circle cx="10" cy="10" r="2.5" stroke="var(--secondary-400)" stroke-width="1.5"/>
            </svg>
        `;
    }
}

function toggleSocialPasswordConfirm() {
    const passwordInput = document.getElementById('socialPasswordConfirm');
    const toggleButton = event.target.closest('button');
    
    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        toggleButton.innerHTML = `
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                <path d="M2.5 5.83333C2.5 4.91286 3.24619 4.16667 4.16667 4.16667H15.8333C16.7538 4.16667 17.5 4.91286 17.5 5.83333V14.1667C17.5 15.0871 16.7538 15.8333 15.8333 15.8333H4.16667C3.24619 15.8333 2.5 15.0871 2.5 14.1667V5.83333Z" stroke="var(--secondary-400)" stroke-width="1.5"/>
                <path d="M17.5 5.83333L10 10.8333L2.5 5.83333" stroke="var(--secondary-400)" stroke-width="1.5"/>
            </svg>
        `;
    } else {
        passwordInput.type = 'password';
        toggleButton.innerHTML = `
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                <path d="M10 4.16667C6.25 4.16667 3.33333 6.66667 2.5 10C3.33333 13.3333 6.25 15.8333 10 15.8333C13.75 15.8333 16.6667 13.3333 17.5 10C16.6667 6.66667 13.75 4.16667 10 4.16667Z" stroke="var(--secondary-400)" stroke-width="1.5"/>
                <circle cx="10" cy="10" r="2.5" stroke="var(--secondary-400)" stroke-width="1.5"/>
            </svg>
        `;
    }
}
</script>
