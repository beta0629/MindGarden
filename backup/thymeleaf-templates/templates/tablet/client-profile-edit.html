<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindGarden - 내담자 프로필 편집</title>
    
    <!-- 추가 CSS 파일들 -->
    <link rel="stylesheet" th:href="@{/css/variables.css}">
    <link rel="stylesheet" th:href="@{/css/common.css}">
    <link rel="stylesheet" th:href="@{/css/components.css}">
    <link rel="stylesheet" th:href="@{/css/tablet.css}">
    <link rel="stylesheet" th:href="@{/css/tablet-common.css}">
</head>
<body th:replace="~{common/layout/tablet-base}">
    
    <!-- 페이지별 컨텐츠 -->
    <div th:fragment="content" class="tablet-client-profile-edit-page">
        <!-- 페이지 헤더 -->
        <div class="profile-edit-header">
            <h1 class="profile-title">내담자 프로필 편집</h1>
            <p class="profile-subtitle">내담자님의 정보를 업데이트하고 프로필을 완성해주세요</p>
        </div>
        
        <!-- 성공 메시지 -->
        <div id="successMessage" class="success-message"></div>
        
        <!-- 프로필 편집 폼 -->
        <form id="profileForm" class="profile-form">
            <!-- 기본 정보 섹션 -->
            <div class="form-section">
                <h3 class="section-title">
                    <i class="bi bi-person-circle"></i>
                    기본 정보
                </h3>
                
                <div class="form-group">
                    <label for="name" class="form-label">이름 *</label>
                    <input type="text" id="name" name="name" class="form-input" th:value="${user?.name}" required>
                    <div class="error-message"></div>
                </div>
                
                <div class="form-group">
                    <label for="nickname" class="form-label">닉네임</label>
                    <input type="text" id="nickname" name="nickname" class="form-input" placeholder="닉네임을 입력하세요">
                    <div class="error-message"></div>
                </div>
                
                <div class="form-group">
                    <label for="email" class="form-label">이메일</label>
                    <input type="email" id="email" name="email" class="form-input" th:value="${user?.email}" readonly>
                    <small class="form-help">이메일은 변경할 수 없습니다</small>
                </div>
            </div>
            
            <!-- 이미지 업로드 섹션 -->
            <div class="form-section">
                <h3 class="section-title">
                    <i class="bi bi-camera"></i>
                    프로필 이미지
                </h3>
                
                <div class="image-upload">
                    <div class="image-preview" id="imagePreview" onclick="document.getElementById('imageInput').click()">
                        <i class="bi bi-camera upload-icon"></i>
                        <button type="button" class="remove-image" onclick="removeImage()">×</button>
                    </div>
                    <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
                    <p class="upload-text">
                        <strong>클릭하여 이미지 선택</strong> 또는 이미지를 여기로 드래그하세요
                    </p>
                    <div class="upload-tips">
                        <p><i class="bi bi-info-circle"></i> 권장 크기: 300x300px 이상</p>
                        <p><i class="bi bi-info-circle"></i> 지원 형식: JPG, PNG, GIF</p>
                        <p><i class="bi bi-info-circle"></i> 최대 크기: 5MB</p>
                    </div>
                </div>
            </div>
            
            <!-- 추가 정보 섹션 -->
            <div class="form-section">
                <h3 class="section-title">
                    <i class="bi bi-gear"></i>
                    추가 설정
                </h3>
                
                <div class="form-group">
                    <label for="notification" class="form-label">알림 설정</label>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" name="emailNotification" checked>
                            <span class="checkmark"></span>
                            이메일 알림 받기
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" name="smsNotification">
                            <span class="checkmark"></span>
                            SMS 알림 받기
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- 버튼 -->
            <div class="form-buttons">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-circle"></i>
                    프로필 저장
                </button>
                <button type="button" class="btn btn-secondary" onclick="resetForm()">
                    <i class="bi bi-arrow-clockwise"></i>
                    초기화
                </button>
                <button type="button" class="btn btn-cancel" onclick="goBack()">
                    <i class="bi bi-x-circle"></i>
                    취소
                </button>
            </div>
        </form>
        
        <!-- 도움말 섹션 -->
        <div class="help-section">
            <h4><i class="bi bi-question-circle"></i> 도움이 필요하신가요?</h4>
            <div class="help-content">
                <p>프로필 편집에 문제가 있으시다면 고객센터에 문의해주세요.</p>
                <div class="help-actions">
                    <a href="#" class="help-link">
                        <i class="bi bi-chat-dots"></i>
                        고객센터 문의
                    </a>
                    <a href="#" class="help-link">
                        <i class="bi bi-book"></i>
                        사용자 가이드
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 페이지별 JavaScript -->
    <script th:fragment="additionalScripts">
        let selectedFile = null;
        
        // 이미지 선택 처리
        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (file) {
                // 파일 유효성 검사
                if (!file.type.startsWith('image/')) {
                    alert('이미지 파일만 선택할 수 있습니다.');
                    return;
                }
                
                if (file.size > 5 * 1024 * 1024) { // 5MB 제한
                    alert('파일 크기는 5MB 이하여야 합니다.');
                    return;
                }
                
                selectedFile = file;
                displayImage(file);
            }
        }
        
        // 이미지 표시
        function displayImage(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('imagePreview');
                preview.innerHTML = `
                    <img src="${e.target.result}" alt="프로필 이미지">
                    <button type="button" class="remove-image" onclick="removeImage()">×</button>
                `;
                preview.classList.add('has-image');
            };
            reader.readAsDataURL(file);
        }
        
        // 이미지 제거
        function removeImage() {
            selectedFile = null;
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '<i class="bi bi-camera upload-icon"></i>';
            preview.classList.remove('has-image');
            document.getElementById('imageInput').value = '';
        }
        
        // 폼 제출 처리
        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // 기본 유효성 검사
            const name = document.getElementById('name').value.trim();
            if (!name) {
                showFieldError('name', '이름을 입력해주세요.');
                return;
            }
            
            // FormData 생성
            const formData = new FormData();
            formData.append('name', name);
            
            const nickname = document.getElementById('nickname').value.trim();
            if (nickname) {
                formData.append('nickname', nickname);
            }
            
            if (selectedFile) {
                formData.append('profileImage', selectedFile);
            }
            
            try {
                // 프로필 업데이트 API 호출
                const response = await fetch('/api/client/profile/update', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showSuccess('프로필이 성공적으로 업데이트되었습니다!');
                    
                    // 프로필 이미지가 업데이트되었다면 헤더에 반영
                    if (selectedFile) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            localStorage.setItem('profileImageUrl', e.target.result);
                        };
                        reader.readAsDataURL(selectedFile);
                    }
                    
                    // 잠시 후 대시보드로 이동
                    setTimeout(() => {
                        window.location.href = '/tablet/client/dashboard';
                    }, 2000);
                } else {
                    const error = await response.json();
                    showError(error.message || '프로필 업데이트에 실패했습니다.');
                }
            } catch (error) {
                console.error('프로필 업데이트 오류:', error);
                showError('네트워크 오류가 발생했습니다. 다시 시도해주세요.');
            }
        });
        
        // 필드 오류 표시
        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const errorElement = field.nextElementSibling;
            
            field.classList.add('error');
            errorElement.textContent = message;
        }
        
        // 성공 메시지 표시
        function showSuccess(message) {
            const successElement = document.getElementById('successMessage');
            successElement.textContent = message;
            successElement.style.display = 'block';
            
            // 5초 후 숨김
            setTimeout(() => {
                successElement.style.display = 'none';
            }, 5000);
        }
        
        // 오류 메시지 표시
        function showError(message) {
            if (window.showNotification) {
                window.showNotification(message, 'error');
            } else {
                alert(message);
            }
        }
        
        // 폼 초기화
        function resetForm() {
            if (confirm('입력한 모든 내용이 초기화됩니다. 계속하시겠습니까?')) {
                document.getElementById('profileForm').reset();
                removeImage();
                
                // 오류 메시지 제거
                const errorMessages = document.querySelectorAll('.error-message');
                errorMessages.forEach(msg => msg.textContent = '');
                
                // 오류 스타일 제거
                const errorFields = document.querySelectorAll('.form-input.error');
                errorFields.forEach(field => field.classList.remove('error'));
            }
        }
        
        // 뒤로 가기
        function goBack() {
            if (confirm('저장하지 않은 변경사항이 있습니다. 정말 나가시겠습니까?')) {
                window.history.back();
            }
        }
    </script>
</body>
</html>
