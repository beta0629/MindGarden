# PL/SQL 도입 방향성 검증 보고서

**작성일:** 2025-01-XX  
**목적:** PL/SQL을 코어 로직으로 사용하는 방향성의 적합성 검증

## 1. 현재 PL/SQL 사용 현황

### 1.1 이미 구현된 PL/SQL 프로시저
- ✅ **통계 처리**: `UpdateDailyStatistics`, `UpdateConsultantPerformance`
- ✅ **정산 처리**: `GetConsolidatedFinancialData`, 정산 배치 프로시저
- ✅ **매핑 동기화**: `UseSessionForMapping`, `ProcessRefundWithSessionAdjustment`
- ✅ **재무 관리**: 통합 재무 현황 조회 프로시저
- ✅ **급여 관리**: 급여 계산 및 지급 프로시저
- ✅ **상담 기록 알림**: 상담 기록 기반 알림 프로시저
- ✅ **스케줄 검증**: 스케줄 유효성 검증 프로시저

### 1.2 Java 코드에서의 PL/SQL 호출
- **155개의 `CALL` 또는 `jdbcTemplate.call` 사용**
- 주요 서비스:
  - `PlSqlStatisticsServiceImpl`
  - `PlSqlAccountingServiceImpl`
  - `PlSqlMappingSyncServiceImpl`
  - `PlSqlFinancialServiceImpl`
  - `PlSqlSalaryManagementServiceImpl`
  - `PlSqlConsultationRecordAlertServiceImpl`
  - `PlSqlScheduleValidationServiceImpl`

### 1.3 SQL 파일 현황
- **32개의 SQL 파일**에 프로시저 정의
- 주요 파일:
  - `mapping_update_procedures_mysql.sql`
  - `production_all_missing_procedures.sql`
  - `business_time_procedures_final.sql`
  - `production_mapping_procedures.sql`
  - 기타 통계, 정산, 재무 관련 프로시저

## 2. PL/SQL 도입 방향성 검증

### 2.1 ✅ 적합한 이유

#### 2.1.1 이미 구축된 인프라
- **기존 시스템과의 일관성**: 이미 PL/SQL을 광범위하게 사용 중
- **개발팀의 경험**: PL/SQL 프로시저 작성 및 관리 경험 보유
- **인프라 준비 완료**: Flyway 마이그레이션, 프로시저 배포 시스템 구축

#### 2.1.2 데이터 정확성 및 일관성
- **트랜잭션 보장**: 복잡한 비즈니스 로직을 단일 트랜잭션으로 처리
- **원자성**: 온보딩 승인 시 테넌트 생성, 컴포넌트 활성화, ERD 생성 등이 모두 성공하거나 모두 실패
- **데이터 무결성**: 외래 키 제약 조건과 함께 데이터 일관성 보장

#### 2.1.3 성능 최적화
- **DB 레벨 처리**: 네트워크 왕복 최소화, 대량 데이터 처리 최적화
- **인덱스 활용**: DB 엔진이 최적의 실행 계획 수립
- **배치 처리**: 통계, 정산 등 대량 데이터 처리에 유리

#### 2.1.4 중앙화 및 재사용성
- **중앙화된 로직**: 모든 코어 로직이 DB에 저장되어 일관성 유지
- **재사용성**: 여러 서비스에서 동일한 프로시저 재사용
- **버전 관리**: Flyway를 통한 프로시저 버전 관리

#### 2.1.5 동적 처리
- **데이터 기반 로직**: 테이블 데이터를 기반으로 동적으로 로직 실행
- **컴포넌트 의존성 확인**: JSON 기반 의존성 정보를 동적으로 처리
- **카테고리별 자동 설정**: 업종별 기본 컴포넌트, 요금제 자동 설정

### 2.2 ⚠️ 주의해야 할 점

#### 2.2.1 디버깅 어려움
- **문제점**: PL/SQL 디버깅이 Java 코드보다 어려움
- **대응 방안**:
  - 상세한 로깅 추가 (`INSERT INTO debug_log`)
  - 단계별 OUT 파라미터로 진행 상황 추적
  - 단위 테스트 프로시저 작성

#### 2.2.2 버전 관리
- **문제점**: 프로시저 변경 시 롤백이 어려울 수 있음
- **대응 방안**:
  - Flyway 마이그레이션으로 버전 관리
  - 프로시저 변경 이력 테이블 (`procedure_change_history`)
  - 변경 전 백업 및 검증

#### 2.2.3 테스트 복잡도
- **문제점**: PL/SQL 프로시저 테스트가 복잡함
- **대응 방안**:
  - 단위 테스트 프로시저 작성 (`TestProcessOnboardingApproval`)
  - 통합 테스트 환경 구축
  - 모의 데이터 기반 테스트

#### 2.2.4 확장성 제한
- **문제점**: 복잡한 비즈니스 로직이 DB에 집중될 수 있음
- **대응 방안**:
  - **하이브리드 접근**: 복잡한 비즈니스 로직은 Java, 데이터 일관성이 중요한 부분은 PL/SQL
  - **서비스 레이어 분리**: PL/SQL은 데이터 처리, Java는 비즈니스 로직

## 3. 권장 사항

### 3.1 PL/SQL 사용 권장 영역 ✅

1. **온보딩 승인 프로세스** (✅ 권장)
   - 여러 테이블에 걸친 트랜잭션 처리
   - 데이터 일관성이 중요한 핵심 프로세스
   - 자동화된 설정 로직

2. **ERD 자동 생성** (✅ 권장)
   - INFORMATION_SCHEMA 기반 동적 쿼리
   - 데이터 기반 ERD 생성
   - 중앙화된 ERD 관리

3. **컴포넌트 활성화/비활성화** (✅ 권장)
   - 의존성 확인 및 자동 처리
   - 트랜잭션 내에서 모든 변경사항 처리

4. **동적 권한 관리** (✅ 권장)
   - 권한 검증 및 부여
   - 정책 기반 권한 처리

5. **정산 및 통계 처리** (✅ 이미 사용 중)
   - 대량 데이터 처리
   - 복잡한 집계 로직

### 3.2 Java 사용 권장 영역 ⚠️

1. **외부 API 호출** (⚠️ Java 권장)
   - OAuth2 인증, PG 연동 등
   - HTTP 클라이언트, 재시도 로직

2. **복잡한 비즈니스 로직** (⚠️ Java 권장)
   - 복잡한 계산 로직
   - 조건부 분기 로직

3. **비동기 처리** (⚠️ Java 권장)
   - 이메일 발송, 알림 발송
   - 큐 기반 처리

4. **UI 로직** (⚠️ Java 권장)
   - 프론트엔드와의 상호작용
   - 세션 관리

### 3.3 하이브리드 접근 방식 권장

```
┌─────────────────────────────────────────┐
│         Java Service Layer              │
│  - 비즈니스 로직                        │
│  - 외부 API 호출                        │
│  - 비동기 처리                          │
└──────────────┬──────────────────────────┘
               │
               │ jdbcTemplate.call()
               │
┌──────────────▼──────────────────────────┐
│      PL/SQL Procedure Layer             │
│  - 데이터 일관성 보장                   │
│  - 트랜잭션 처리                        │
│  - 대량 데이터 처리                     │
│  - 동적 데이터 기반 로직                │
└─────────────────────────────────────────┘
```

## 4. 결론

### 4.1 방향성 적합성: ✅ **매우 적합**

**이유:**
1. ✅ 이미 PL/SQL 인프라가 구축되어 있음
2. ✅ 데이터 정확성 및 일관성이 중요한 코어 로직에 적합
3. ✅ 온보딩, ERD 생성 등 복잡한 트랜잭션 처리에 유리
4. ✅ 중앙화 및 재사용성 확보
5. ✅ 성능 최적화 가능

### 4.2 실행 전략

1. **단계적 확장**
   - 기존 PL/SQL 프로시저 패턴 유지
   - 새로운 코어 로직을 PL/SQL로 구현
   - Java와 PL/SQL의 역할 명확히 구분

2. **품질 관리**
   - 프로시저 단위 테스트 작성
   - 상세한 로깅 및 에러 처리
   - Flyway를 통한 버전 관리

3. **문서화**
   - 프로시저 목적 및 사용법 문서화
   - 파라미터 및 반환값 명확히 정의
   - 예제 코드 제공

## 5. 연계 문서

- `CORE_SOLUTION_PLSQL_ARCHITECTURE.md`: PL/SQL 아키텍처 설계
- `DATA_CORE_AND_PL_SQL.md`: 데이터 중앙화 및 PL/SQL 전략
- `MASTER_IMPLEMENTATION_SCHEDULE.md`: 전체 구현 일정

