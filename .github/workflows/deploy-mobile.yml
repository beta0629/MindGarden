name: ðŸ“± MindGarden ëª¨ë°”ì¼ ì•± ë¹Œë“œ

on:
  push:
    branches: [ main ]
    paths:
      - 'mobile/**'
      - '.github/workflows/deploy-mobile.yml'
  workflow_dispatch:
    inputs:
      platform:
        description: 'ë¹Œë“œí•  í”Œëž«í¼ (android, ios, both)'
        required: true
        default: 'both'
        type: choice
        options:
          - android
          - ios
          - both

jobs:
  build-android:
    name: ðŸ¤– Android ë¹Œë“œ
    runs-on: ubuntu-latest
    if: github.event.inputs.platform == 'android' || github.event.inputs.platform == 'both' || (github.event.inputs.platform == '' && github.event_name == 'push')
    
    steps:
    - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ðŸ“ mobile í´ë” í™•ì¸
      run: |
        echo "í˜„ìž¬ ë””ë ‰í† ë¦¬: $(pwd)"
        echo "mobile í´ë” í™•ì¸:"
        if [ ! -d "mobile" ]; then
          echo "âŒ mobile ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤!"
          exit 1
        fi
        
        echo "âœ… mobile ë””ë ‰í† ë¦¬ í™•ì¸ë¨"
        echo "mobile í´ë” ë‚´ìš©:"
        ls -la mobile/ | head -20
        
        # android/ios í´ë” í™•ì¸
        if [ ! -d "mobile/android" ] && [ ! -d "mobile/ios" ]; then
          echo "âŒ mobile/android ë˜ëŠ” mobile/ios í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤!"
          exit 1
        fi
        
        echo "âœ… mobile/android ë˜ëŠ” mobile/ios í´ë” í™•ì¸ë¨"
      
    - name: â˜• Java 17 ì„¤ì • (Android ë¹Œë“œìš©)
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ðŸ“¦ Node.js 20 ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: ðŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        cd mobile
        npm ci
        
    - name: ðŸ”§ Android SDK ì„¤ì •
      uses: android-actions/setup-android@v3
      with:
        api-level: 33
        build-tools: 33.0.0
        target: android-33
        
    - name: ðŸ” ë¦´ë¦¬ì¦ˆ í‚¤ìŠ¤í† ì–´ ì„¤ì • (ì„ íƒì‚¬í•­)
      if: env.ANDROID_KEYSTORE_BASE64 != ''
      env:
        ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      run: |
        if [ -n "$ANDROID_KEYSTORE_BASE64" ]; then
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > mobile/android/app/my-release-key.keystore
          echo "âœ… í‚¤ìŠ¤í† ì–´ íŒŒì¼ ìƒì„± ì™„ë£Œ"
        else
          echo "â„¹ï¸ í‚¤ìŠ¤í† ì–´ê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ - Debug ë¹Œë“œë¡œ ì§„í–‰"
        fi
        
    - name: ðŸ—ï¸ Android Release ë¹Œë“œ
      env:
        NODE_BINARY: ${{ env.NODE_BINARY }}
      run: |
        cd mobile/android
        
        echo "í˜„ìž¬ ë””ë ‰í† ë¦¬: $(pwd)"
        echo "ë””ë ‰í† ë¦¬ êµ¬ì¡°:"
        ls -la | head -20
        
        # Gradle wrapper ë””ë ‰í† ë¦¬ ìƒì„±
        mkdir -p gradle/wrapper
        
        # gradle-wrapper.properties íŒŒì¼ í™•ì¸ ë° ìƒì„±
        if [ ! -f "gradle/wrapper/gradle-wrapper.properties" ]; then
          echo "âš ï¸ gradle-wrapper.properties ì—†ìŒ, ìƒì„±..."
          cat > gradle/wrapper/gradle-wrapper.properties << 'EOF'
        distributionBase=GRADLE_USER_HOME
        distributionPath=wrapper/dists
        distributionUrl=https\://services.gradle.org/distributions/gradle-9.0.0-bin.zip
        networkTimeout=10000
        validateDistributionUrl=true
        zipStoreBase=GRADLE_USER_HOME
        zipStorePath=wrapper/dists
        EOF
        else
          echo "âœ… gradle-wrapper.properties ì¡´ìž¬"
          cat gradle/wrapper/gradle-wrapper.properties
        fi
        
        # gradle-wrapper.jar íŒŒì¼ í™•ì¸ ë° ìƒì„±
        if [ ! -f "gradle/wrapper/gradle-wrapper.jar" ]; then
          echo "âš ï¸ gradle-wrapper.jar ì—†ìŒ, ë‹¤ìš´ë¡œë“œ ì‹œë„..."
          # Gradle wrapper JAR ë‹¤ìš´ë¡œë“œ (Gradle 9.0.0)
          curl -L "https://raw.githubusercontent.com/gradle/gradle/v9.0.0/gradle/wrapper/gradle-wrapper.jar" -o gradle/wrapper/gradle-wrapper.jar || {
            echo "âš ï¸ GitHubì—ì„œ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨, Maven Centralì—ì„œ ë‹¤ìš´ë¡œë“œ ì‹œë„..."
            curl -L "https://repo1.maven.org/maven2/org/gradle/gradle-wrapper/9.0.0/gradle-wrapper-9.0.0.jar" -o gradle/wrapper/gradle-wrapper.jar || {
              echo "âš ï¸ Maven Centralì—ì„œë„ ì‹¤íŒ¨, Gradle ë°°í¬ ì‚¬ì´íŠ¸ì—ì„œ ë‹¤ìš´ë¡œë“œ ì‹œë„..."
              curl -L "https://services.gradle.org/distributions/gradle-9.0.0-bin.zip" -o /tmp/gradle.zip
              unzip -q /tmp/gradle.zip -d /tmp/
              cp /tmp/gradle-9.0.0/lib/gradle-wrapper-*.jar gradle/wrapper/gradle-wrapper.jar 2>/dev/null || echo "âš ï¸ ë³µì‚¬ ì‹¤íŒ¨"
              rm -rf /tmp/gradle.zip /tmp/gradle-9.0.0
            }
          }
        else
          echo "âœ… gradle-wrapper.jar ì¡´ìž¬"
        fi
        
        # íŒŒì¼ í™•ì¸
        echo "Gradle wrapper íŒŒì¼ í™•ì¸:"
        ls -la gradle/wrapper/ || echo "âš ï¸ gradle/wrapper ë””ë ‰í† ë¦¬ ì—†ìŒ"
        
        # íŒŒì¼ í¬ê¸° í™•ì¸
        if [ -f "gradle/wrapper/gradle-wrapper.jar" ]; then
          JAR_SIZE=$(stat -f%z gradle/wrapper/gradle-wrapper.jar 2>/dev/null || stat -c%s gradle/wrapper/gradle-wrapper.jar 2>/dev/null || echo "0")
          echo "gradle-wrapper.jar í¬ê¸°: ${JAR_SIZE} bytes"
          if [ "$JAR_SIZE" -lt 1000 ]; then
            echo "âš ï¸ JAR íŒŒì¼ì´ ë„ˆë¬´ ìž‘ìŒ, ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ë¡œ ë³´ìž„"
            exit 1
          fi
        fi
        
        chmod +x gradlew
        ./gradlew assembleRelease --stacktrace
        
    - name: ðŸ“¦ Android AAB ë¹Œë“œ (Google Play ì—…ë¡œë“œìš©)
      env:
        NODE_BINARY: ${{ env.NODE_BINARY }}
      run: |
        cd mobile/android
        ./gradlew bundleRelease --stacktrace
        
    - name: ðŸ“¤ ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: android-release
        path: |
          mobile/android/app/build/outputs/apk/release/app-release.apk
          mobile/android/app/build/outputs/bundle/release/app-release.aab
        retention-days: 30
        
    - name: ðŸ“‹ ë¹Œë“œ ì •ë³´ ì¶œë ¥
      run: |
        echo "ðŸ“± Android ë¹Œë“œ ì™„ë£Œ"
        echo "APK ìœ„ì¹˜: mobile/android/app/build/outputs/apk/release/app-release.apk"
        echo "AAB ìœ„ì¹˜: mobile/android/app/build/outputs/bundle/release/app-release.aab"
        ls -lh mobile/android/app/build/outputs/apk/release/ || true
        ls -lh mobile/android/app/build/outputs/bundle/release/ || true

  build-ios:
    name: ðŸŽ iOS ë¹Œë“œ
    runs-on: macos-latest
    if: github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'both' || (github.event.inputs.platform == '' && github.event_name == 'push')
    
    steps:
    - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ðŸ“ mobile í´ë” í™•ì¸
      run: |
        echo "í˜„ìž¬ ë””ë ‰í† ë¦¬: $(pwd)"
        echo "mobile í´ë” í™•ì¸:"
        if [ ! -d "mobile" ]; then
          echo "âŒ mobile ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤!"
          exit 1
        fi
        
        echo "âœ… mobile ë””ë ‰í† ë¦¬ í™•ì¸ë¨"
        echo "mobile í´ë” ë‚´ìš©:"
        ls -la mobile/ | head -20
        
        # android/ios í´ë” í™•ì¸
        if [ ! -d "mobile/android" ] && [ ! -d "mobile/ios" ]; then
          echo "âŒ mobile/android ë˜ëŠ” mobile/ios í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤!"
          exit 1
        fi
        
        echo "âœ… mobile/android ë˜ëŠ” mobile/ios í´ë” í™•ì¸ë¨"
      
    - name: ðŸ“¦ Node.js 20 ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: ðŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        cd mobile
        npm ci
        
    - name: ðŸŽ CocoaPods ì„¤ì¹˜
      run: |
        cd mobile/ios
        sudo gem install cocoapods
        pod install
        
    - name: ðŸ—ï¸ iOS Archive ë¹Œë“œ
      run: |
        cd mobile/ios
        xcodebuild -workspace MindGardenMobile.xcworkspace \
          -scheme MindGardenMobile \
          -configuration Release \
          -sdk iphoneos \
          -archivePath build/MindGardenMobile.xcarchive \
          archive \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
          
    - name: ðŸ“¦ IPA ìƒì„±
      run: |
        cd mobile/ios
        xcodebuild -exportArchive \
          -archivePath build/MindGardenMobile.xcarchive \
          -exportPath build \
          -exportOptionsPlist ExportOptions.plist || echo "ExportOptions.plist ì—†ìŒ - IPA ìƒì„± ê±´ë„ˆëœ€"
          
    - name: ðŸ“¤ ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: ios-release
        path: |
          mobile/ios/build/MindGardenMobile.xcarchive
          mobile/ios/build/*.ipa
        retention-days: 30
        
    - name: ðŸ“‹ ë¹Œë“œ ì •ë³´ ì¶œë ¥
      run: |
        echo "ðŸŽ iOS ë¹Œë“œ ì™„ë£Œ"
        echo "Archive ìœ„ì¹˜: mobile/ios/build/MindGardenMobile.xcarchive"
        ls -lh mobile/ios/build/ || true

  notify:
    name: ðŸ“¢ ë¹Œë“œ ì™„ë£Œ ì•Œë¦¼
    runs-on: ubuntu-latest
    needs: [build-android, build-ios]
    if: always()
    
    steps:
    - name: ðŸ“¥ ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
      uses: actions/download-artifact@v4
      with:
        pattern: '*-release'
        merge-multiple: true
        path: artifacts
        
    - name: ðŸ“‹ ë¹Œë“œ ìš”ì•½
      run: |
        echo "## ðŸ“± ëª¨ë°”ì¼ ì•± ë¹Œë“œ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ¤– Android" >> $GITHUB_STEP_SUMMARY
        if [ -d "artifacts/android-release" ]; then
          echo "âœ… Android ë¹Œë“œ ì„±ê³µ" >> $GITHUB_STEP_SUMMARY
          ls -lh artifacts/android-release/ >> $GITHUB_STEP_SUMMARY || true
        else
          echo "âš ï¸ Android ë¹Œë“œ ì‹¤íŒ¨ ë˜ëŠ” ê±´ë„ˆëœ€" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŽ iOS" >> $GITHUB_STEP_SUMMARY
        if [ -d "artifacts/ios-release" ]; then
          echo "âœ… iOS ë¹Œë“œ ì„±ê³µ" >> $GITHUB_STEP_SUMMARY
          ls -lh artifacts/ios-release/ >> $GITHUB_STEP_SUMMARY || true
        else
          echo "âš ï¸ iOS ë¹Œë“œ ì‹¤íŒ¨ ë˜ëŠ” ê±´ë„ˆëœ€" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“¥ ë¹Œë“œ íŒŒì¼ì€ GitHub Actionsì˜ Artifactsì—ì„œ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY

