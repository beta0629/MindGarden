name: ğŸš€ MindGarden ìš´ì˜ ë°°í¬

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: ğŸ—ï¸ ë¹Œë“œ ë° ë°°í¬
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: â˜• Java 17 ì„¤ì •
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ğŸ“¦ Node.js 18 ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: ğŸ”§ Maven ìºì‹œ ì„¤ì •
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: ğŸ—ï¸ ë°±ì—”ë“œ ë¹Œë“œ
      run: mvn clean package -DskipTests
      
    - name: ğŸ“¦ í”„ë¡ íŠ¸ì—”ë“œ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        cd frontend
        npm ci
        
    - name: ğŸ—ï¸ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ
      run: |
        cd frontend
        npm run build
        
    - name: ğŸš€ ì„œë²„ ë°°í¬
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        script: |
          # ë°°í¬ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          cd /var/www/mindgarden
          
          # ì„œë¹„ìŠ¤ ì¤‘ì§€
          sudo systemctl stop mindgarden.service
          
          # ë°±ì—… ìƒì„±
          if [ -f app.jar ]; then
            cp app.jar app.jar.backup.$(date +%Y%m%d_%H%M%S)
          fi
          
          # í”„ë¡ íŠ¸ì—”ë“œ ë°±ì—…
          if [ -d frontend ]; then
            tar -czf frontend.backup.$(date +%Y%m%d_%H%M%S).tar.gz frontend/
          fi
          
    - name: ğŸ“¤ ë°±ì—”ë“œ íŒŒì¼ ì—…ë¡œë“œ
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        source: "target/consultation-management-system-1.0.0.jar"
        target: "/var/www/mindgarden/"
        strip_components: 1
        overwrite: true
        
    - name: ğŸ“¤ í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ ì—…ë¡œë“œ
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        source: "frontend/build/*"
        target: "/var/www/html/"
        strip_components: 2
        overwrite: true
        
    - name: ğŸ”§ í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ ê¶Œí•œ ì„¤ì •
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        script: |
          # í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ ê¶Œí•œ ì„¤ì •
          sudo chown -R www-data:www-data /var/www/html/
          sudo chmod -R 755 /var/www/html/
          
          # CSS íŒŒì¼ ê¶Œí•œ íŠ¹ë³„ ì„¤ì •
          sudo find /var/www/html/ -name "*.css" -exec chmod 644 {} \;
          sudo find /var/www/html/ -name "*.js" -exec chmod 644 {} \;
          
          echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ ê¶Œí•œ ì„¤ì • ì™„ë£Œ"
        
    - name: ğŸ”„ ì„œë¹„ìŠ¤ ì¬ì‹œì‘
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        script: |
          cd /var/www/mindgarden
          
          # JAR íŒŒì¼ëª… ë³€ê²½
          if [ -f consultation-management-system-1.0.0.jar ]; then
            mv consultation-management-system-1.0.0.jar app.jar
          fi
          
          # ê¶Œí•œ ì„¤ì •
          chmod +x app.jar
          
          # ê¸°ì¡´ ì„œë¹„ìŠ¤ ì™„ì „ ì •ì§€ (ê·¹ê°•í™” ë²„ì „)
          echo "ğŸ›‘ ì„œë¹„ìŠ¤ ì™„ì „ ì •ì§€ ì‹œì‘..."
          
          # 1ë‹¨ê³„: systemd ì„œë¹„ìŠ¤ ì •ì§€
          echo "1ï¸âƒ£ systemd ì„œë¹„ìŠ¤ ì •ì§€..."
          sudo systemctl stop mindgarden.service || true
          sudo systemctl disable mindgarden.service || true
          sleep 3
          
          # 2ë‹¨ê³„: ëª¨ë“  Java í”„ë¡œì„¸ìŠ¤ ê°•ì œ ì¢…ë£Œ (ì—¬ëŸ¬ ë²ˆ ì‹œë„)
          echo "2ï¸âƒ£ Java í”„ë¡œì„¸ìŠ¤ ê°•ì œ ì¢…ë£Œ (1ì°¨)..."
          sudo pkill -9 -f "mindgarden" || true
          sudo pkill -9 -f "app.jar" || true
          sudo pkill -9 -f "consultation-management-system" || true
          sudo pkill -9 -f "spring.profiles.active=prod" || true
          sudo pkill -9 -f "server.port=8080" || true
          sudo pkill -9 -f "java.*8080" || true
          sleep 2
          
          # 3ë‹¨ê³„: í¬íŠ¸ ì ìœ  í”„ë¡œì„¸ìŠ¤ ê°•ì œ ì¢…ë£Œ
          echo "3ï¸âƒ£ í¬íŠ¸ ì ìœ  í”„ë¡œì„¸ìŠ¤ ê°•ì œ ì¢…ë£Œ..."
          sudo fuser -k 8080/tcp || true
          sudo fuser -k 8081/tcp || true
          sudo netstat -tlnp | grep :8080 | awk '{print $7}' | cut -d'/' -f1 | xargs -r sudo kill -9 || true
          sleep 2
          
          # 4ë‹¨ê³„: ì¬í™•ì¸ ë° 2ì°¨ ê°•ì œ ì¢…ë£Œ
          echo "4ï¸âƒ£ ë‚¨ì€ í”„ë¡œì„¸ìŠ¤ 2ì°¨ ê°•ì œ ì¢…ë£Œ..."
          sudo pkill -9 -f "java" | grep -E "(mindgarden|app\.jar|8080)" || true
          sudo killall -9 java || true
          sleep 3
          
          echo "ğŸ” í”„ë¡œì„¸ìŠ¤ ì •ë¦¬ í™•ì¸..."
          ps aux | grep -E "(mindgarden|app\.jar|8080)" | grep -v grep || echo "âœ… ëª¨ë“  í”„ë¡œì„¸ìŠ¤ ì •ë¦¬ë¨"
          
          # systemd ì™„ì „ ì¬ì‹œì‘ (ê·¹ê°•í™” ë²„ì „)
          echo "ğŸ”„ systemd ì™„ì „ ì¬ì‹œì‘..."
          
          # 1ë‹¨ê³„: systemd ì¬ë¡œë“œ
          echo "1ï¸âƒ£ systemd ì¬ë¡œë“œ..."
          sudo systemctl daemon-reload
          sleep 2
          
          # 2ë‹¨ê³„: ì„œë¹„ìŠ¤ í™œì„±í™”
          echo "2ï¸âƒ£ ì„œë¹„ìŠ¤ í™œì„±í™”..."
          sudo systemctl enable mindgarden.service
          sleep 1
          
          # 3ë‹¨ê³„: ì„œë¹„ìŠ¤ ì‹œì‘ (ìµœëŒ€ 3ë²ˆ ì‹œë„)
          echo "3ï¸âƒ£ ì„œë¹„ìŠ¤ ì‹œì‘ ì‹œë„..."
          for i in {1..3}; do
            echo "ğŸš€ ì„œë¹„ìŠ¤ ì‹œì‘ ì‹œë„ $i/3..."
            sudo systemctl start mindgarden.service
            sleep 10
            
            if sudo systemctl is-active --quiet mindgarden.service; then
              echo "âœ… ì„œë¹„ìŠ¤ ì‹œì‘ ì„±ê³µ! (ì‹œë„ $i/3)"
              break
            else
              echo "âŒ ì„œë¹„ìŠ¤ ì‹œì‘ ì‹¤íŒ¨ (ì‹œë„ $i/3)"
              if [ $i -lt 3 ]; then
                echo "ğŸ”„ 5ì´ˆ í›„ ì¬ì‹œë„..."
                sudo systemctl stop mindgarden.service || true
                sleep 5
              fi
            fi
          done
          
          # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
          echo "â³ ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
          sleep 15
          
          echo "ğŸ” ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸..."
          sudo systemctl status mindgarden.service --no-pager | head -15
          
          echo "ğŸ” ì„œë¹„ìŠ¤ í™œì„±í™” ìƒíƒœ í™•ì¸..."
          sudo systemctl is-active mindgarden.service
          sudo systemctl is-enabled mindgarden.service
          
          echo "ğŸ” ìµœê·¼ ë¡œê·¸ í™•ì¸..."
          sudo journalctl -u mindgarden.service -n 20 --no-pager | tail -10
          
          echo "ğŸ” í”„ë¡œì„¸ìŠ¤ í™•ì¸..."
          ps aux | grep -E "(mindgarden|app\.jar)" | grep -v grep || echo "í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
          
          echo "ğŸ” ì„œë¹„ìŠ¤ ì¬ì‹œì‘ í™•ì¸..."
          if sudo systemctl is-active --quiet mindgarden.service; then
            echo "âœ… ì„œë¹„ìŠ¤ ì •ìƒ ì‹œì‘ë¨"
            echo "ğŸ• ì„œë¹„ìŠ¤ ì‹œì‘ ì‹œê°„: $(sudo systemctl show mindgarden.service --property=ActiveEnterTimestamp --value)"
          else
            echo "âŒ ì„œë¹„ìŠ¤ ì‹œì‘ ì‹¤íŒ¨"
            sudo systemctl status mindgarden.service --no-pager -l
          fi
          
          # Nginx ì„¤ì • í…ŒìŠ¤íŠ¸ ë° ì¬ë¡œë“œ
          sudo nginx -t
          sudo nginx -s reload
          
          # ì •ì  íŒŒì¼ ì„œë¹™ í™•ì¸
          echo "ğŸ” ì •ì  íŒŒì¼ í™•ì¸..."
          ls -la /var/www/html/static/css/ | head -5 || echo "CSS ë””ë ‰í† ë¦¬ ì—†ìŒ"
          ls -la /var/www/html/static/js/ | head -5 || echo "JS ë””ë ‰í† ë¦¬ ì—†ìŒ"
          
    - name: ğŸ¥ í—¬ìŠ¤ì²´í¬
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        script: |
          echo "ğŸ¥ í—¬ìŠ¤ì²´í¬ ì‹œì‘..."
          
          # 30ì´ˆ ëŒ€ê¸° í›„ í—¬ìŠ¤ì²´í¬
          sleep 30
          
          # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
          if sudo systemctl is-active --quiet mindgarden.service; then
            echo "âœ… ì„œë¹„ìŠ¤ ì •ìƒ ì‹¤í–‰ ì¤‘"
          else
            echo "âŒ ì„œë¹„ìŠ¤ ì‹¤í–‰ ì‹¤íŒ¨"
            sudo systemctl status mindgarden.service --no-pager
            exit 1
          fi
          
          # HTTP í—¬ìŠ¤ì²´í¬
          if curl -f -s http://localhost:8080/actuator/health > /dev/null; then
            echo "âœ… HTTP í—¬ìŠ¤ì²´í¬ í†µê³¼"
          else
            echo "âŒ HTTP í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
            curl -v http://localhost:8080/actuator/health || true
          fi
          
          # í”„ë¡ íŠ¸ì—”ë“œ í™•ì¸
          if curl -f -s http://localhost/login > /dev/null; then
            echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ì •ìƒ ì ‘ê·¼"
          else
            echo "âŒ í”„ë¡ íŠ¸ì—”ë“œ ì ‘ê·¼ ì‹¤íŒ¨"
          fi
          
          echo "ğŸ‰ ë°°í¬ ì™„ë£Œ!"
          
    - name: ğŸ§¹ ë©”ëª¨ë¦¬ ì •ë¦¬
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        script: |
          echo "ğŸ§¹ ë©”ëª¨ë¦¬ ì •ë¦¬ ì‹œì‘..."
          
          # 7ì¼ ì´ìƒ ëœ ë°±ì—… íŒŒì¼ ì‚­ì œ
          cd /var/www/mindgarden
          find . -name "*.backup.*" -type f -mtime +7 -delete || true
          
          # ì‹œìŠ¤í…œ ë©”ëª¨ë¦¬ ì •ë¦¬
          sync
          echo 3 | sudo tee /proc/sys/vm/drop_caches > /dev/null
          
          # ìµœì¢… ì‹œìŠ¤í…œ ìƒíƒœ
          echo "ğŸ’¾ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰:"
          free -h
          echo ""
          echo "ğŸ’¿ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰:"
          df -h /var/www/mindgarden
          echo ""
          echo "ğŸ”§ ì„œë¹„ìŠ¤ ìƒíƒœ:"
          sudo systemctl is-active mindgarden.service
          
          echo "âœ… ë©”ëª¨ë¦¬ ì •ë¦¬ ì™„ë£Œ!"